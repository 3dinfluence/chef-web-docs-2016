

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Common Functionality &mdash; Chef Docs</title>
    
    <link rel="stylesheet" href="_static/opscode.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.0.1-1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="shortcut icon" href="_static/opscode.ico"/>
    <link rel="top" title="Chef Docs" href="index.html" />
    <link rel="up" title="About Resources and Providers" href="resource.html" />
    <link rel="next" title="Common Actions for Resources" href="resource_common_actions.html" />
    <link rel="prev" title="chef_gem" href="resource_chef_gem.html" /> 
  </head>
  <body>
<div style="background-color: #212c35; text-align: left; padding: 0px 0px 0px 0px">
<a href="http://docs.opscode.com/"><img src="_static/opscode_html_logo.png" border="0" alt="Opscode"/></a>
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="resource_common_actions.html" title="Common Actions for Resources"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="resource_chef_gem.html" title="chef_gem"
             accesskey="P">previous</a> |</li>
        <li><a href="http://docs.opscode.com/chef/knife.html" target="_products">Knife</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/resources.html" target="_products">Resources</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/dsl_recipe.html" target="_products">Recipe DSL</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/lwrps_custom.html" target="_products">LWRPs</a>&#149;</li>
        <li><a href="http://docs.opscode.com/search.html">Search the Docs</a>&#149;</li>
        <li><a href="http://docs.opscode.com/">Home</a> &raquo;</li>

          <li><a href="resource.html" accesskey="U">About Resources and Providers</a> &raquo;</li> 
      </ul>
    </div>

      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/opscode_chef_html_logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Common Functionality</a><ul>
<li><a class="reference internal" href="#actions">Actions</a><ul>
<li><a class="reference internal" href="#examples">Examples</a></li>
</ul>
</li>
<li><a class="reference internal" href="#attributes">Attributes</a><ul>
<li><a class="reference internal" href="#id1">Examples</a></li>
</ul>
</li>
<li><a class="reference internal" href="#conditionals">Conditionals</a><ul>
<li><a class="reference internal" href="#id2">Attributes</a></li>
<li><a class="reference internal" href="#arguments">Arguments</a></li>
<li><a class="reference internal" href="#not-if-examples">not_if Examples</a></li>
<li><a class="reference internal" href="#only-if-examples">only_if Examples</a></li>
</ul>
</li>
<li><a class="reference internal" href="#notifications">Notifications</a><ul>
<li><a class="reference internal" href="#notifications-timers">Notifications Timers</a></li>
<li><a class="reference internal" href="#notifies-syntax">Notifies Syntax</a><ul>
<li><a class="reference internal" href="#id3">Examples</a></li>
</ul>
</li>
<li><a class="reference internal" href="#subscribes-syntax">Subscribes Syntax</a><ul>
<li><a class="reference internal" href="#id4">Examples</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#relative-paths">Relative Paths</a><ul>
<li><a class="reference internal" href="#id5">Examples</a></li>
</ul>
</li>
<li><a class="reference internal" href="#run-from-resource-collection">Run from Resource Collection</a><ul>
<li><a class="reference internal" href="#before-other-resources">Before other Resources</a></li>
<li><a class="reference internal" href="#after-collection-is-built">After Collection is Built</a></li>
</ul>
</li>
<li><a class="reference internal" href="#windows-file-security">Windows File Security</a><ul>
<li><a class="reference internal" href="#access-control-lists-acls">Access Control Lists (ACLs)</a></li>
<li><a class="reference internal" href="#inheritance">Inheritance</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="common-functionality">
<h1>Common Functionality<a class="headerlink" href="#common-functionality" title="Permalink to this headline">¶</a></h1>
<p>All resources (and lightweight resources) share a set of common actions, attributes, conditional executions, notifications, and relative path options.</p>
<div class="section" id="actions">
<h2>Actions<a class="headerlink" href="#actions" title="Permalink to this headline">¶</a></h2>
<p>The following actions are common to every resource:</p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="88%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Action</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">:nothing</span></tt></td>
<td>Use to do nothing. In the absence of another default action, <tt class="docutils literal"><span class="pre">nothing</span></tt> is the default. This action can be useful to specify a resource so that it can be notified of other actions.</td>
</tr>
</tbody>
</table>
<div class="section" id="examples">
<h3>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h3>
<p>The following examples show how to use common actions in a recipe.</p>
<p><strong>Use the :nothing action</strong></p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">service</span> <span class="s2">&quot;memcached&quot;</span> <span class="k">do</span>
  <span class="n">action</span> <span class="ss">:nothing</span>
  <span class="n">supports</span> <span class="ss">:status</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:start</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:stop</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:restart</span> <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="attributes">
<h2>Attributes<a class="headerlink" href="#attributes" title="Permalink to this headline">¶</a></h2>
<p>The following attributes are common to every resource:</p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="88%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Attribute</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">ignore_failure</span></tt></td>
<td>Use to continue running a recipe if a resource fails for any reason. Default value: <tt class="docutils literal"><span class="pre">false</span></tt>.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">provider</span></tt></td>
<td>Optional. Use to specify a provider by using its long name. For example: <tt class="docutils literal"><span class="pre">provider</span> <span class="pre">Chef::Provider::Long::Name</span></tt>. See the Providers section below for the list of providers available to this resource.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">retries</span></tt></td>
<td>Use to specify the number of times to catch exceptions and retry the resource. Default value: <tt class="docutils literal"><span class="pre">0</span></tt>.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">retry_delay</span></tt></td>
<td>Use to specify the retry delay (in seconds). Default value: <tt class="docutils literal"><span class="pre">2</span></tt>.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">supports</span></tt></td>
<td>Use to specify a hash of options that contains hints about the capabilities of a resource. Chef may use these hints to help identify the correct provider. This attribute is only used by a small number of providers, including <tt class="docutils literal"><span class="pre">User</span></tt> and <tt class="docutils literal"><span class="pre">Service</span></tt>.</td>
</tr>
</tbody>
</table>
<div class="section" id="id1">
<h3>Examples<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>The following examples show how to use common attributes in a recipe.</p>
<p><strong>Use the ignore_failure common attribute</strong></p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">gem_package</span> <span class="s2">&quot;syntax&quot;</span> <span class="k">do</span>
  <span class="n">action</span> <span class="ss">:install</span>
  <span class="n">ignore_failure</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div>
<p><strong>Use the provider common attribute</strong></p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">package</span> <span class="s2">&quot;some_package&quot;</span> <span class="k">do</span>
  <span class="n">provider</span> <span class="no">Chef</span><span class="o">::</span><span class="no">Provider</span><span class="o">::</span><span class="no">Package</span><span class="o">::</span><span class="no">Rubygems</span>
<span class="k">end</span>
</pre></div>
</div>
<p><strong>Use the supports common attribute</strong></p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">service</span> <span class="s2">&quot;apache&quot;</span> <span class="k">do</span>
  <span class="n">supports</span> <span class="ss">:restart</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:reload</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">action</span> <span class="ss">:enable</span>
<span class="k">end</span>
</pre></div>
</div>
<p><strong>Use the supports and providers common attributes</strong></p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">service</span> <span class="s2">&quot;some_service&quot;</span> <span class="k">do</span>
  <span class="n">provider</span> <span class="no">Chef</span><span class="o">::</span><span class="no">Provider</span><span class="o">::</span><span class="no">Service</span><span class="o">::</span><span class="no">Upstart</span>
  <span class="n">supports</span> <span class="ss">:status</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:restart</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:reload</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">action</span> <span class="o">[</span> <span class="ss">:enable</span><span class="p">,</span> <span class="ss">:start</span> <span class="o">]</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="conditionals">
<h2>Conditionals<a class="headerlink" href="#conditionals" title="Permalink to this headline">¶</a></h2>
<p>A conditional execution can be used to put additional guards around certain resources so that they are only run when the condition is met. A conditional execution can be used with any resource. The most common reason for using a conditional execution is to ensure that the <tt class="docutils literal"><span class="pre">execute</span></tt> resource produces the same result every time. A conditional execution can be passed as a string or as a block. A strings is executed as a shell command and a block is Ruby code. In both cases, the attribute is <tt class="docutils literal"><span class="pre">true</span></tt> when the command returns <tt class="docutils literal"><span class="pre">0</span></tt>).</p>
<div class="section" id="id2">
<h3>Attributes<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>The following attributes can be used to define a conditional execution for a resource:</p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="88%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Attribute</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">not_if</span></tt></td>
<td>Indicates whether this resource should not be applied. If <tt class="docutils literal"><span class="pre">true</span></tt>, this action should not be performed. If <tt class="docutils literal"><span class="pre">false</span></tt>, this action should always be performed.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">only_if</span></tt></td>
<td>Indicates whether only this resource is applied. If <tt class="docutils literal"><span class="pre">true</span></tt>, this action should always be performed. If <tt class="docutils literal"><span class="pre">false</span></tt>, this action should never be performed.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="arguments">
<h3>Arguments<a class="headerlink" href="#arguments" title="Permalink to this headline">¶</a></h3>
<p>The following arguments can be used with the <tt class="docutils literal"><span class="pre">not_if</span></tt> or <tt class="docutils literal"><span class="pre">only_if</span></tt> attributes:</p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="88%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Argument</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">:user</span></tt></td>
<td><p class="first">Use to specify the user that a command will run as. For example:</p>
<div class="last highlight-ruby"><div class="highlight"><pre><span class="n">not_if</span> <span class="s2">&quot;grep adam /etc/passwd&quot;</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="s1">&#39;adam&#39;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">:group</span></tt></td>
<td><p class="first">Use to specify the group that a command will run as. For example:</p>
<div class="last highlight-ruby"><div class="highlight"><pre><span class="n">not_if</span> <span class="s2">&quot;grep adam /etc/passwd&quot;</span><span class="p">,</span> <span class="ss">:group</span> <span class="o">=&gt;</span> <span class="s1">&#39;adam&#39;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">:environment</span></tt></td>
<td><p class="first">Use to specify a hash of environment variables to be set. For example:</p>
<div class="last highlight-ruby"><div class="highlight"><pre><span class="n">not_if</span> <span class="s2">&quot;grep adam /etc/passwd&quot;</span><span class="p">,</span> <span class="ss">:environment</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s1">&#39;HOME&#39;</span> <span class="o">=&gt;</span> <span class="s2">&quot;/home/adam&quot;</span> <span class="p">}</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">:cwd</span></tt></td>
<td><p class="first">Use to set the current working directory before running a command. For example:</p>
<div class="last highlight-ruby"><div class="highlight"><pre><span class="n">not_if</span> <span class="s2">&quot;grep adam passwd&quot;</span><span class="p">,</span> <span class="ss">:cwd</span> <span class="o">=&gt;</span> <span class="s1">&#39;/etc&#39;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">:timeout</span></tt></td>
<td><p class="first">Use to set a timeout for a command. For example:</p>
<div class="last highlight-ruby"><div class="highlight"><pre><span class="n">not_if</span> <span class="s2">&quot;sleep 10000&quot;</span><span class="p">,</span> <span class="ss">:timeout</span> <span class="o">=&gt;</span> <span class="mi">10</span>
</pre></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="not-if-examples">
<h3>not_if Examples<a class="headerlink" href="#not-if-examples" title="Permalink to this headline">¶</a></h3>
<p>The following example shows how to use the <tt class="docutils literal"><span class="pre">not_if</span></tt> condition to create a file based on a template and using the presence of an attribute on the node to specify the condition:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">template</span> <span class="s2">&quot;/tmp/somefile&quot;</span> <span class="k">do</span>
  <span class="n">mode</span> <span class="mo">00644</span>
  <span class="n">source</span> <span class="s2">&quot;somefile.erb&quot;</span>
  <span class="n">not_if</span> <span class="p">{</span> <span class="n">node</span><span class="o">[</span><span class="ss">:some_value</span><span class="o">]</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>
<p>The following example shows how to use the <tt class="docutils literal"><span class="pre">not_if</span></tt> condition to create a file based on a template and using Ruby to specify the condition:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">template</span> <span class="s2">&quot;/tmp/somefile&quot;</span> <span class="k">do</span>
  <span class="n">mode</span> <span class="mo">00644</span>
  <span class="n">source</span> <span class="s2">&quot;somefile.erb&quot;</span>
  <span class="n">not_if</span> <span class="k">do</span>
    <span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="s2">&quot;/etc/passwd&quot;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>The following example shows how to use the <tt class="docutils literal"><span class="pre">not_if</span></tt> condition to create a file based on a template and using a Ruby block (with curly braces) to specify the condition:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">template</span> <span class="s2">&quot;/tmp/somefile&quot;</span> <span class="k">do</span>
  <span class="n">mode</span> <span class="mo">00644</span>
  <span class="n">source</span> <span class="s2">&quot;somefile.erb&quot;</span>
  <span class="n">not_if</span> <span class="p">{</span><span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="s2">&quot;/etc/passwd&quot;</span><span class="p">)}</span>
<span class="k">end</span>
</pre></div>
</div>
<p>The following example shows how to use the <tt class="docutils literal"><span class="pre">not_if</span></tt> condition to create a file based on a template and using a string to specify the condition:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">template</span> <span class="s2">&quot;/tmp/somefile&quot;</span> <span class="k">do</span>
  <span class="n">mode</span> <span class="mo">00644</span>
  <span class="n">source</span> <span class="s2">&quot;somefile.erb&quot;</span>
  <span class="n">not_if</span> <span class="s2">&quot;test -f /etc/passwd&quot;</span>
<span class="k">end</span>
</pre></div>
</div>
<p><strong>Install a file from a remote location using bash</strong></p>
<p>The following is an example of how to install the <tt class="docutils literal"><span class="pre">foo123</span></tt> module for Nginx. This module adds shell-style functionality to an Nginx configuration file and does the following:</p>
<ul class="simple">
<li>Declares three variables</li>
<li>Gets the Nginx file from a remote location</li>
<li>Installs the file using Bash to the path specified by the <tt class="docutils literal"><span class="pre">src_filepath</span></tt> variable</li>
</ul>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">src_filename</span> <span class="o">=</span> <span class="s2">&quot;foo123-nginx-module-v</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;nginx&#39;</span><span class="o">][</span><span class="s1">&#39;foo123&#39;</span><span class="o">][</span><span class="s1">&#39;version&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">.tar.gz&quot;</span>
<span class="n">src_filepath</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="no">Chef</span><span class="o">::</span><span class="no">Config</span><span class="o">[</span><span class="s1">&#39;file_cache_path&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">src_filename</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="n">extract_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="no">Chef</span><span class="o">::</span><span class="no">Config</span><span class="o">[</span><span class="s1">&#39;file_cache_path&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">/nginx_foo123_module/</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;nginx&#39;</span><span class="o">][</span><span class="s1">&#39;foo123&#39;</span><span class="o">][</span><span class="s1">&#39;checksum&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="n">remote_file</span> <span class="n">src_filepath</span> <span class="k">do</span>
  <span class="n">source</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;nginx&#39;</span><span class="o">][</span><span class="s1">&#39;foo123&#39;</span><span class="o">][</span><span class="s1">&#39;url&#39;</span><span class="o">]</span>
  <span class="n">checksum</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;nginx&#39;</span><span class="o">][</span><span class="s1">&#39;foo123&#39;</span><span class="o">][</span><span class="s1">&#39;checksum&#39;</span><span class="o">]</span>
  <span class="n">owner</span> <span class="s1">&#39;root&#39;</span>
  <span class="n">group</span> <span class="s1">&#39;root&#39;</span>
  <span class="n">mode</span> <span class="mo">00644</span>
<span class="k">end</span>

<span class="n">bash</span> <span class="s1">&#39;extract_module&#39;</span> <span class="k">do</span>
  <span class="n">cwd</span> <span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">src_filepath</span><span class="p">)</span>
  <span class="n">code</span> <span class="o">&lt;&lt;-</span><span class="no">EOH</span>
<span class="sh">    mkdir -p #{extract_path}</span>
<span class="sh">    tar xzf #{src_filename} -C #{extract_path}</span>
<span class="sh">    mv #{extract_path}/*/* #{extract_path}/</span>
<span class="no">    EOH</span>
  <span class="n">not_if</span> <span class="p">{</span> <span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="n">extract_path</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This example is similar to the <tt class="docutils literal"><span class="pre">upload_progress_module</span></tt> recipe in the following cookbook: <a class="reference external" href="https://github.com/opscode-cookbooks/nginx">https://github.com/opscode-cookbooks/nginx</a>.</p>
</div>
</div>
<div class="section" id="only-if-examples">
<h3>only_if Examples<a class="headerlink" href="#only-if-examples" title="Permalink to this headline">¶</a></h3>
<p>The following example shows how to use the <tt class="docutils literal"><span class="pre">only_if</span></tt> condition to create a file based on a template and using the presence of an attribute on the node to specify the condition:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">template</span> <span class="s2">&quot;/tmp/somefile&quot;</span> <span class="k">do</span>
  <span class="n">mode</span> <span class="mo">00644</span>
  <span class="n">source</span> <span class="s2">&quot;somefile.erb&quot;</span>
  <span class="n">only_if</span> <span class="p">{</span> <span class="n">node</span><span class="o">[</span><span class="ss">:some_value</span><span class="o">]</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>
<p>The following example shows how to use the <tt class="docutils literal"><span class="pre">only_if</span></tt> condition to create a file based on a template, and then use Ruby to specify a condition:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">template</span> <span class="s2">&quot;/tmp/somefile&quot;</span> <span class="k">do</span>
  <span class="n">mode</span> <span class="mo">00644</span>
  <span class="n">source</span> <span class="s2">&quot;somefile.erb&quot;</span>
  <span class="n">only_if</span> <span class="k">do</span> <span class="o">!</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="s2">&quot;/etc/passwd&quot;</span><span class="p">)</span> <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>The following example shows how to use the <tt class="docutils literal"><span class="pre">only_if</span></tt> condition to create a file based on a template and using a string to specify the condition:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">template</span> <span class="s2">&quot;/tmp/somefile&quot;</span> <span class="k">do</span>
  <span class="n">mode</span> <span class="mo">00644</span>
  <span class="n">source</span> <span class="s2">&quot;somefile.erb&quot;</span>
  <span class="n">only_if</span> <span class="s2">&quot;test -f /etc/passwd&quot;</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="notifications">
<h2>Notifications<a class="headerlink" href="#notifications" title="Permalink to this headline">¶</a></h2>
<p>The following notifications can be used with any resource:</p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="88%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Notification</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">notifies</span></tt></td>
<td>Use to notify another resource to take an action if this resource&#8217;s state changes for any reason.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">subscribes</span></tt></td>
<td>Use to take action on this resource if another resource&#8217;s state changes. This is similar to <tt class="docutils literal"><span class="pre">notifies</span></tt>, but reversed.</td>
</tr>
</tbody>
</table>
<div class="section" id="notifications-timers">
<h3>Notifications Timers<a class="headerlink" href="#notifications-timers" title="Permalink to this headline">¶</a></h3>
<p>The following timers can be used to define when a notification is triggered:</p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="88%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Timer</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">:delayed</span></tt></td>
<td>Use to specify that a notification should be queued up and then executed at the very end of a Chef run.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">:immediately</span></tt></td>
<td>Use to specify that a notification be run immediately.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="notifies-syntax">
<h3>Notifies Syntax<a class="headerlink" href="#notifies-syntax" title="Permalink to this headline">¶</a></h3>
<p>The basic syntax of a <tt class="docutils literal"><span class="pre">notifies</span></tt> notification is:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">resource</span> <span class="s2">&quot;name&quot;</span> <span class="k">do</span>
  <span class="n">notifies</span> <span class="ss">:action</span><span class="p">,</span> <span class="s2">&quot;resource_type[resource_name]&quot;</span><span class="p">,</span> <span class="ss">:notification_timing</span>
<span class="k">end</span>
</pre></div>
</div>
<div class="section" id="id3">
<h4>Examples<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>The following examples show how to use the <tt class="docutils literal"><span class="pre">notifies</span></tt> notification in a recipe.</p>
<p><strong>Delay notifications</strong></p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">template</span> <span class="s2">&quot;/etc/nagios3/configures-nagios.conf&quot;</span> <span class="k">do</span>
  <span class="c1"># other parameters</span>
  <span class="n">notifies</span> <span class="ss">:run</span><span class="p">,</span> <span class="s2">&quot;execute[test-nagios-config]&quot;</span><span class="p">,</span> <span class="ss">:delayed</span>
<span class="k">end</span>
</pre></div>
</div>
<p><strong>Notify immediately</strong></p>
<p>By default, notifications are <tt class="docutils literal"><span class="pre">:delayed</span></tt>, that is they are queued up as they are triggered, and then executed at the very end of a Chef run. To run an action immediately, use <tt class="docutils literal"><span class="pre">:immediately</span></tt>:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">template</span> <span class="s2">&quot;/etc/nagios3/configures-nagios.conf&quot;</span> <span class="k">do</span>
  <span class="c1"># other parameters</span>
  <span class="n">notifies</span> <span class="ss">:run</span><span class="p">,</span> <span class="s2">&quot;execute[test-nagios-config]&quot;</span><span class="p">,</span> <span class="ss">:immediately</span>
<span class="k">end</span>
</pre></div>
</div>
<p>and then Chef would immediately run the following:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">execute</span> <span class="s2">&quot;test-nagios-config&quot;</span> <span class="k">do</span>
  <span class="n">command</span> <span class="s2">&quot;nagios3 --verify-config&quot;</span>
  <span class="n">action</span> <span class="ss">:nothing</span>
<span class="k">end</span>
</pre></div>
</div>
<p><strong>Enable a service after a restart or reload</strong></p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">service</span> <span class="s2">&quot;apache&quot;</span> <span class="k">do</span>
  <span class="n">supports</span> <span class="ss">:restart</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:reload</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">action</span> <span class="ss">:enable</span>
<span class="k">end</span>
</pre></div>
</div>
<p><strong>Notify multiple resources</strong></p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">template</span> <span class="s2">&quot;/etc/chef/server.rb&quot;</span> <span class="k">do</span>
  <span class="n">source</span> <span class="s2">&quot;server.rb.erb&quot;</span>
  <span class="n">owner</span> <span class="s2">&quot;root&quot;</span>
  <span class="n">group</span> <span class="s2">&quot;root&quot;</span>
  <span class="n">mode</span> <span class="s2">&quot;644&quot;</span>
  <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="s2">&quot;service[chef-solr]&quot;</span><span class="p">,</span> <span class="ss">:delayed</span>
  <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="s2">&quot;service[chef-solr-indexer]&quot;</span><span class="p">,</span> <span class="ss">:delayed</span>
  <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="s2">&quot;service[chef-server]&quot;</span><span class="p">,</span> <span class="ss">:delayed</span>
<span class="k">end</span>
</pre></div>
</div>
<p><strong>Notify in a specific order</strong></p>
<p>To notify multiple resources, and then have these resources run in a certain order, do something like the following:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">execute</span> <span class="s1">&#39;foo&#39;</span> <span class="k">do</span>
  <span class="n">command</span> <span class="s1">&#39;...&#39;</span>
  <span class="n">notifies</span> <span class="ss">:run</span><span class="p">,</span> <span class="s1">&#39;template[baz]&#39;</span><span class="p">,</span> <span class="ss">:immediately</span>
  <span class="n">notifies</span> <span class="ss">:install</span><span class="p">,</span> <span class="s1">&#39;package[bar]&#39;</span><span class="p">,</span> <span class="ss">:immediately</span>
  <span class="n">notifies</span> <span class="ss">:run</span><span class="p">,</span> <span class="s1">&#39;execute[final]&#39;</span><span class="p">,</span> <span class="ss">:immediately</span>
<span class="k">end</span>

<span class="n">template</span> <span class="s1">&#39;baz&#39;</span> <span class="k">do</span>
  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
  <span class="n">notifies</span> <span class="ss">:run</span><span class="p">,</span> <span class="s1">&#39;execute[restart_baz]&#39;</span><span class="p">,</span> <span class="ss">:immediately</span>
<span class="k">end</span>

<span class="n">package</span> <span class="s1">&#39;bar&#39;</span>

<span class="n">execute</span> <span class="s1">&#39;restart_baz&#39;</span>

<span class="n">execute</span> <span class="s1">&#39;final&#39;</span> <span class="k">do</span>
  <span class="n">command</span> <span class="s1">&#39;...&#39;</span>
<span class="k">end</span>
</pre></div>
</div>
<p>where the sequencing will be in the same order as the resources are listed in the recipe: <tt class="docutils literal"><span class="pre">execute</span> <span class="pre">'foo'</span></tt>, <tt class="docutils literal"><span class="pre">template</span> <span class="pre">'baz'</span></tt>, <tt class="docutils literal"><span class="pre">execute</span> <span class="pre">[restart_baz]</span></tt>, <tt class="docutils literal"><span class="pre">package</span> <span class="pre">'bar'</span></tt>, and <tt class="docutils literal"><span class="pre">execute</span> <span class="pre">'final'</span></tt>.</p>
<p><strong>Reload a service</strong></p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">template</span> <span class="s2">&quot;/tmp/somefile&quot;</span> <span class="k">do</span>
  <span class="n">mode</span> <span class="s2">&quot;0644&quot;</span>
  <span class="n">source</span> <span class="s2">&quot;somefile.erb&quot;</span>
  <span class="n">notifies</span> <span class="ss">:reload</span><span class="p">,</span> <span class="s2">&quot;service[apache]&quot;</span>
<span class="k">end</span>
</pre></div>
</div>
<p><strong>Restart a service when a template is modified</strong></p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">template</span> <span class="s2">&quot;/etc/www/configures-apache.conf&quot;</span> <span class="k">do</span>
  <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="s2">&quot;service[apache]&quot;</span>
<span class="k">end</span>
</pre></div>
</div>
<p><strong>Send notifications to multiple resources</strong></p>
<p>To send notifications to multiple resources, just use multiple attributes. Multiple attributes will get sent to the notified resources in the order specified.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">template</span> <span class="s2">&quot;/etc/netatalk/netatalk.conf&quot;</span> <span class="k">do</span>
  <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="s2">&quot;service[afpd]&quot;</span><span class="p">,</span> <span class="ss">:immediately</span>
  <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="s2">&quot;service[cnid]&quot;</span><span class="p">,</span> <span class="ss">:immediately</span>
<span class="k">end</span>

<span class="n">service</span> <span class="s2">&quot;afpd&quot;</span>
<span class="n">service</span> <span class="s2">&quot;cnid&quot;</span>
</pre></div>
</div>
<p><strong>Execute a command using a template</strong></p>
<p>The following example shows how to set up IPv4 packet forwarding using the <strong>execute</strong> resource to run a command named &#8220;forward_ipv4&#8221; that uses a template defined by the <strong>template</strong> resource:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">execute</span> <span class="s2">&quot;forward_ipv4&quot;</span> <span class="k">do</span>
  <span class="n">command</span> <span class="s2">&quot;echo &gt; /proc/.../ipv4/ip_forward&quot;</span>
  <span class="n">action</span> <span class="ss">:nothing</span>
<span class="k">end</span>

<span class="n">template</span> <span class="s2">&quot;/etc/file_name.conf&quot;</span> <span class="k">do</span>
  <span class="n">source</span> <span class="s2">&quot;routing/file_name.conf.erb&quot;</span>
  <span class="n">notifies</span> <span class="ss">:run</span><span class="p">,</span> <span class="s1">&#39;execute[forward_ipv4]&#39;</span><span class="p">,</span> <span class="ss">:delayed</span>
<span class="k">end</span>
</pre></div>
</div>
<p>where the <tt class="docutils literal"><span class="pre">command</span></tt> attribute for the <strong>execute</strong> resource contains the command that is to be run and the <tt class="docutils literal"><span class="pre">source</span></tt> attribute for the <strong>template</strong> resource specifies which template to use. The <tt class="docutils literal"><span class="pre">notifies</span></tt> attribute for the <strong>template</strong> specifies that the <tt class="docutils literal"><span class="pre">execute[forward_ipv4]</span></tt> (which is defined by the <strong>execute</strong> resource) should be queued up and run at the end of the Chef run.</p>
<p><strong>Restart a service, and then notify a different service</strong></p>
<p>The following example shows how start a service named &#8220;example_service&#8221; and immediately notify the Nginx service to restart.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">service</span> <span class="s2">&quot;example_service&quot;</span> <span class="k">do</span>
  <span class="n">action</span> <span class="ss">:start</span>
  <span class="n">provider</span> <span class="no">Chef</span><span class="o">::</span><span class="no">Provider</span><span class="o">::</span><span class="no">Service</span><span class="o">::</span><span class="no">Init</span>
  <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="s2">&quot;service[nginx]&quot;</span><span class="p">,</span> <span class="ss">:immediately</span>
<span class="k">end</span>
</pre></div>
</div>
<p>where by using the default <tt class="docutils literal"><span class="pre">provider</span></tt> for the <strong>service</strong>, the recipe is telling Chef to determine the specific provider to be used during the Chef run based on the platform of the node on which the recipe will run.</p>
<p><strong>Notify when a remote source changes</strong></p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">remote_file</span> <span class="s2">&quot;/tmp/couch.png&quot;</span> <span class="k">do</span>
  <span class="n">source</span> <span class="s2">&quot;http://couchdb.apache.org/img/sketch.png&quot;</span>
  <span class="n">action</span> <span class="ss">:nothing</span>
<span class="k">end</span>

<span class="n">http_request</span> <span class="s2">&quot;HEAD http://couchdb.apache.org/img/sketch.png&quot;</span> <span class="k">do</span>
  <span class="n">message</span> <span class="s2">&quot;&quot;</span>
  <span class="n">url</span> <span class="s2">&quot;http://couchdb.apache.org/img/sketch.png&quot;</span>
  <span class="n">action</span> <span class="ss">:head</span>
  <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="s2">&quot;/tmp/couch.png&quot;</span><span class="p">)</span>
    <span class="n">headers</span> <span class="s2">&quot;If-Modified-Since&quot;</span> <span class="o">=&gt;</span> <span class="no">File</span><span class="o">.</span><span class="n">mtime</span><span class="p">(</span><span class="s2">&quot;/tmp/couch.png&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">httpdate</span>
  <span class="k">end</span>
  <span class="n">notifies</span> <span class="ss">:create</span><span class="p">,</span> <span class="s2">&quot;remote_file[/tmp/couch.png]&quot;</span><span class="p">,</span> <span class="ss">:immediately</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="subscribes-syntax">
<h3>Subscribes Syntax<a class="headerlink" href="#subscribes-syntax" title="Permalink to this headline">¶</a></h3>
<p>The basic syntax of a <tt class="docutils literal"><span class="pre">subscribes</span></tt> notification is:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">resource</span> <span class="s2">&quot;name&quot;</span> <span class="k">do</span>
  <span class="n">subscribes</span> <span class="ss">:action</span><span class="p">,</span> <span class="s2">&quot;resource_type[resource_name]&quot;</span><span class="p">,</span> <span class="ss">:notification_timing</span>
<span class="k">end</span>
</pre></div>
</div>
<div class="section" id="id4">
<h4>Examples<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<p>The following examples show how to use the <tt class="docutils literal"><span class="pre">subscribes</span></tt> notification in a recipe.</p>
<p><strong>Prevent restart and reconfigure if configuration is broken</strong></p>
<p>Use the <tt class="docutils literal"><span class="pre">:nothing</span></tt> common action to prevent an application from restarting, and then use the <tt class="docutils literal"><span class="pre">subscribes</span></tt> notification to ask the broken configuration to be reconfigured immediately:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">execute</span> <span class="s2">&quot;test-nagios-config&quot;</span> <span class="k">do</span>
  <span class="n">command</span> <span class="s2">&quot;nagios3 --verify-config&quot;</span>
  <span class="n">action</span> <span class="ss">:nothing</span>
  <span class="n">subscribes</span> <span class="ss">:run</span><span class="p">,</span> <span class="n">resources</span><span class="p">(</span><span class="ss">:template</span> <span class="o">=&gt;</span> <span class="s2">&quot;/etc/nagios3/configures-nagios.conf&quot;</span><span class="p">),</span> <span class="ss">:immediately</span>
<span class="k">end</span>
</pre></div>
</div>
<p><strong>Reload a service using a template</strong></p>
<p>To reload a service based on a template, use the <strong>template</strong> and <strong>service</strong> resources together in the same recipe, similar to the following:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">template</span> <span class="s2">&quot;/tmp/somefile&quot;</span> <span class="k">do</span>
  <span class="n">mode</span> <span class="s2">&quot;0644&quot;</span>
  <span class="n">source</span> <span class="s2">&quot;somefile.erb&quot;</span>
<span class="k">end</span>

<span class="n">service</span> <span class="s2">&quot;apache&quot;</span> <span class="k">do</span>
  <span class="n">supports</span> <span class="ss">:restart</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:reload</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">action</span> <span class="ss">:enable</span>
  <span class="n">subscribes</span> <span class="ss">:reload</span><span class="p">,</span> <span class="n">resources</span><span class="p">(</span><span class="s2">&quot;template[/tmp/somefile]&quot;</span><span class="p">),</span> <span class="ss">:immediately</span>
<span class="k">end</span>
</pre></div>
</div>
<p>where the <tt class="docutils literal"><span class="pre">subscribes</span></tt> notification is used to reload the service using the template specified by the <strong>template</strong> resource.</p>
<p><strong>Stash a file in a data bag</strong></p>
<p>The following example shows how to use the <strong>ruby_block</strong> resource to stash a BitTorrent file in a data bag so that it can be distributed to nodes in the organization.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">ruby_block</span> <span class="s2">&quot;share the torrent file&quot;</span> <span class="k">do</span>
  <span class="n">block</span> <span class="k">do</span>
    <span class="n">f</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;bittorrent&#39;</span><span class="o">][</span><span class="s1">&#39;torrent&#39;</span><span class="o">]</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span>
    <span class="c1">#read the .torrent file and base64 encode it</span>
    <span class="n">enc</span> <span class="o">=</span> <span class="no">Base64</span><span class="o">.</span><span class="n">encode64</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s1">&#39;id&#39;</span><span class="o">=&gt;</span><span class="n">bittorrent_item_id</span><span class="p">(</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;bittorrent&#39;</span><span class="o">][</span><span class="s1">&#39;file&#39;</span><span class="o">]</span><span class="p">),</span>
      <span class="s1">&#39;seed&#39;</span><span class="o">=&gt;</span><span class="n">node</span><span class="o">.</span><span class="n">ipaddress</span><span class="p">,</span>
      <span class="s1">&#39;torrent&#39;</span><span class="o">=&gt;</span><span class="n">enc</span>
    <span class="p">}</span>
    <span class="n">item</span> <span class="o">=</span> <span class="no">Chef</span><span class="o">::</span><span class="no">DataBagItem</span><span class="o">.</span><span class="n">new</span>
    <span class="n">item</span><span class="o">.</span><span class="n">data_bag</span><span class="p">(</span><span class="s1">&#39;bittorrent&#39;</span><span class="p">)</span>
    <span class="n">item</span><span class="o">.</span><span class="n">raw_data</span> <span class="o">=</span> <span class="n">data</span>
    <span class="n">item</span><span class="o">.</span><span class="n">save</span>
  <span class="k">end</span>
  <span class="n">action</span> <span class="ss">:nothing</span>
  <span class="n">subscribes</span> <span class="ss">:create</span><span class="p">,</span> <span class="n">resources</span><span class="p">(</span><span class="ss">:bittorrent_torrent</span> <span class="o">=&gt;</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;bittorrent&#39;</span><span class="o">][</span><span class="s1">&#39;torrent&#39;</span><span class="o">]</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This example comes from the <tt class="docutils literal"><span class="pre">seed</span></tt> recipe in the following cookbook: <a class="reference external" href="https://github.com/mattray/bittorrent-cookbook">https://github.com/mattray/bittorrent-cookbook</a>.</p>
</div>
</div>
</div>
</div>
<div class="section" id="relative-paths">
<h2>Relative Paths<a class="headerlink" href="#relative-paths" title="Permalink to this headline">¶</a></h2>
<p>The following relative paths can be used with any resource:</p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="88%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Relative Path</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">#{ENV['HOME']}</span></tt></td>
<td>Use to return the <tt class="docutils literal"><span class="pre">~</span></tt> path in Linux and Mac OS X or the <tt class="docutils literal"><span class="pre">%HOMEPATH%</span></tt> in Microsoft Windows.</td>
</tr>
</tbody>
</table>
<div class="section" id="id5">
<h3>Examples<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">template</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;HOME&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">/chef-getting-started.txt&quot;</span> <span class="k">do</span>
  <span class="n">source</span> <span class="s2">&quot;chef-getting-started.txt.erb&quot;</span>
  <span class="n">mode</span> <span class="mo">00644</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="run-from-resource-collection">
<h2>Run from Resource Collection<a class="headerlink" href="#run-from-resource-collection" title="Permalink to this headline">¶</a></h2>
<p>Chef processes recipes in two phases:</p>
<ol class="arabic simple">
<li>First, each resource in the node object is identified and a resource collection is built. All recipes are loaded in a specific order, and then the actions specified within each of them are identified.</li>
<li>Next, Chef configures the system based on the order of the resources in the resource collection. Each resource is mapped to a provider, which then examines the node and then does the steps necessary to complete the action.</li>
</ol>
<p>Sometimes, it may be necessary to ensure that a specific resource is run during the phase that builds the resource collection. For example:</p>
<ul class="simple">
<li>A resource may need to run first so that it can download a package that will be used by other resources in the resource collection</li>
<li>Several resources need to install a package; rather than having the package installer run several times, it can be configured to run only once</li>
</ul>
<p>To support these types of uses cases, it is possible to tell Chef to run a resource at the beginning and/or the end of the resource collection phase. Effectively, run a resource before all other resources are added to the resource collection and/or after all resources have been added, but before Chef configures the system.</p>
<div class="section" id="before-other-resources">
<h3>Before other Resources<a class="headerlink" href="#before-other-resources" title="Permalink to this headline">¶</a></h3>
<p>To run a resource at the start of the resource collection phase of the Chef run, set up a <tt class="docutils literal"><span class="pre">Chef::Resource</span></tt> object, and then call the method that runs the action.</p>
<p><strong>Update a package cache</strong></p>
<p>It is important to make sure that an operating system&#8217;s package cache is up to date before Chef tries to install packages, otherwise there may be references to versions that no longer exist. For example, on Debian or Ubuntu systems, the APT cache needs to be updated. Use code similar to the following:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">e</span> <span class="o">=</span> <span class="n">execute</span> <span class="s2">&quot;apt-get update&quot;</span> <span class="k">do</span>
  <span class="n">action</span> <span class="ss">:nothing</span>
<span class="k">end</span>

<span class="n">e</span><span class="o">.</span><span class="n">run_action</span><span class="p">(</span><span class="ss">:run</span><span class="p">)</span>
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">e</span></tt> is created as a <tt class="docutils literal"><span class="pre">Chef::Resource::Execute</span></tt> Ruby object. The <tt class="docutils literal"><span class="pre">action</span></tt> attribute is set to <tt class="docutils literal"><span class="pre">:nothing</span></tt> so that the <tt class="docutils literal"><span class="pre">run_action</span></tt> method can be used to tell Chef to run the specified command. Opscode provides a cookbook for doing this with APT (Debian or Ubuntu) and pacman (for Arch Linux). The preceding recipe can be placed at the top of a node&#8217;s run list to ensure it is run before Chef tries to install any packages.</p>
<p><strong>Install a RubyGem to use later</strong></p>
<p>A single Chef run should configure a node completely. Chef uses Ruby as the recipe language, which means that anything that can be done with Ruby can be done in a recipe. However, in some cases, a Ruby gem may need to be installed before anything else happens. For example, when a MySQL database needs to interact with a recipe. This can be done with a recipe similar to the following:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">g</span> <span class="o">=</span> <span class="n">gem_package</span> <span class="s2">&quot;mysql&quot;</span> <span class="k">do</span>
  <span class="n">action</span> <span class="ss">:nothing</span>
<span class="k">end</span>

<span class="n">g</span><span class="o">.</span><span class="n">run_action</span><span class="p">(</span><span class="ss">:install</span><span class="p">)</span>

<span class="no">Gem</span><span class="o">.</span><span class="n">clear_paths</span>
<span class="nb">require</span> <span class="s1">&#39;mysql&#39;</span>
</pre></div>
</div>
<p>where similar to the previous example for updating package caches, this example creates a new Ruby object called <tt class="docutils literal"><span class="pre">Chef::Resource::Package</span></tt>.</p>
<ul class="simple">
<li>The MySQL Ruby gem compiles native extensions in C, so the appropriate packages for the operating system will also need to be installed.</li>
<li><tt class="docutils literal"><span class="pre">Gem.clear_paths</span></tt> ensures that Chef reloads the cache of available Ruby gems.</li>
<li><tt class="docutils literal"><span class="pre">require</span> <span class="pre">'mysql'</span></tt> loads the MySQL Ruby gem so that it can be used to connect to a MySQL database.</li>
</ul>
<p><strong>An anti-pattern</strong></p>
<p>Unfortunately, resources that are executed when the resource collection is being built cannot notify any resource that has yet to be added to the resource collection. For example:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">execute</span> <span class="s2">&quot;ifconfig&quot;</span>

<span class="nb">p</span> <span class="o">=</span> <span class="n">package</span> <span class="s1">&#39;vim-enhanced&#39;</span> <span class="k">do</span>
  <span class="n">action</span> <span class="ss">:nothing</span>
  <span class="n">notifies</span> <span class="ss">:run</span><span class="p">,</span> <span class="s2">&quot;execute[ifconfig]&quot;</span><span class="p">,</span> <span class="ss">:immediately</span>
<span class="k">end</span>
<span class="nb">p</span><span class="o">.</span><span class="n">run_action</span><span class="p">(</span><span class="ss">:install</span><span class="p">)</span>
</pre></div>
</div>
<p>In some cases, the better approach may be to install the package before the resource collection is built to ensure that it is available to other resources later on. Or, something like the following can be used:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="nb">p</span> <span class="o">=</span> <span class="n">package</span> <span class="s2">&quot;foo&quot;</span> <span class="k">do</span>
  <span class="c1">#parameters</span>
<span class="k">end</span>
<span class="nb">p</span><span class="o">.</span><span class="n">run_action</span><span class="p">(</span><span class="ss">:install</span><span class="p">)</span>

<span class="k">if</span> <span class="nb">p</span><span class="o">.</span><span class="n">updated_by_last_action?</span>
  <span class="c1">#Call the resource that we want to &quot;notify&quot;</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="after-collection-is-built">
<h3>After Collection is Built<a class="headerlink" href="#after-collection-is-built" title="Permalink to this headline">¶</a></h3>
<p>To run a resource at the end of the resource collection phase of the Chef run, use the <tt class="docutils literal"><span class="pre">:delayed</span></tt> timer on a notification.</p>
</div>
</div>
<div class="section" id="windows-file-security">
<h2>Windows File Security<a class="headerlink" href="#windows-file-security" title="Permalink to this headline">¶</a></h2>
<p>To support Microsoft Windows security, the <strong>template</strong>, <strong>file</strong>, <strong>remote_file</strong>, <strong>cookbook_file</strong>, <strong>directory</strong>, and <strong>remote_directory</strong> resources support the use of inheritance and access control lists (ACLs) within recipes.</p>
<div class="section" id="access-control-lists-acls">
<h3>Access Control Lists (ACLs)<a class="headerlink" href="#access-control-lists-acls" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">rights</span></tt> attribute can be used in a recipe to manage access control lists (ACLs), which allow permissions to be given to multiple users and groups. The syntax for the <tt class="docutils literal"><span class="pre">rights</span></tt> attribute is as follows:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">rights</span> <span class="n">permission</span><span class="p">,</span> <span class="n">principal</span><span class="p">,</span> <span class="n">option</span>
</pre></div>
</div>
<p>where</p>
<ul>
<li><p class="first"><tt class="docutils literal"><span class="pre">permission</span></tt> is used to specify which rights will be granted to the <tt class="docutils literal"><span class="pre">principal</span></tt>. The possible values are: <tt class="docutils literal"><span class="pre">:read</span></tt>, <tt class="docutils literal"><span class="pre">:write</span></tt>, <tt class="docutils literal"><span class="pre">:full_control</span></tt>, and <tt class="docutils literal"><span class="pre">:deny</span></tt>. These permissions are cumulative. If <tt class="docutils literal"><span class="pre">:write</span></tt> is specified, then it includes <tt class="docutils literal"><span class="pre">:read</span></tt>. If <tt class="docutils literal"><span class="pre">:full_control</span></tt> is specified, then it includes both <tt class="docutils literal"><span class="pre">:write</span></tt> and <tt class="docutils literal"><span class="pre">:read</span></tt>. If <tt class="docutils literal"><span class="pre">:deny</span></tt> is specified, then the user or group will not have rights to the object. (For those who know the Microsoft Windows API: <tt class="docutils literal"><span class="pre">:read</span></tt> corresponds to <tt class="docutils literal"><span class="pre">GENERIC_READ</span></tt> and <tt class="docutils literal"><span class="pre">GENERIC_EXECUTE</span></tt>; <tt class="docutils literal"><span class="pre">:write</span></tt> corresponds to <tt class="docutils literal"><span class="pre">GENERIC_WRITE</span></tt>, <tt class="docutils literal"><span class="pre">GENERIC_READ</span></tt>, and <tt class="docutils literal"><span class="pre">GENERIC_EXECUTE</span></tt>; <tt class="docutils literal"><span class="pre">:full_control</span></tt> corresponds to <tt class="docutils literal"><span class="pre">GENERIC_ALL</span></tt>, which allows a user to change the owner and other metadata about a file.)</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">principal</span></tt> is used to specify a group or user name. This is identical to what is entered in the login box for Microsoft Windows, such as <tt class="docutils literal"><span class="pre">user_name</span></tt>, <tt class="docutils literal"><span class="pre">domain\user_name</span></tt>, or <tt class="docutils literal"><span class="pre">user_name&#64;fully_qualified_domain_name</span></tt>. Chef does not need to know if a principal is a user or a group.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">option</span></tt> is a hash that contains advanced rights options. For example, the rights to a directory that only applies to its children might look something like: <tt class="docutils literal"><span class="pre">rights</span> <span class="pre">:write,</span> <span class="pre">&quot;domain\group_name&quot;,</span> <span class="pre">:option_type</span> <span class="pre">=&gt;</span> <span class="pre">value</span></tt> where <tt class="docutils literal"><span class="pre">option_type</span></tt> is one of the following:</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="88%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">Option Type</p>
</th>
<th class="head"><p class="first last">Description</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><p class="first last"><tt class="docutils literal"><span class="pre">:applies_to_children</span></tt></p>
</td>
<td><p class="first last">Use to specify how permissions are applied to children. Possible values: <tt class="docutils literal"><span class="pre">true</span></tt> to inherit both child directories and files;  <tt class="docutils literal"><span class="pre">false</span></tt> to not inherit any child directories or files; <tt class="docutils literal"><span class="pre">:containers_only</span></tt> to inherit only child directories (and not files); <tt class="docutils literal"><span class="pre">:objects_only</span></tt> to recursively inherit files (and not child directories).</p>
</td>
</tr>
<tr class="row-odd"><td><p class="first last"><tt class="docutils literal"><span class="pre">:applies_to_self</span></tt></p>
</td>
<td><p class="first last">Indicates whether a permission is applied to the parent directory. Possible values: <tt class="docutils literal"><span class="pre">true</span></tt> to apply to the parent directory or file and its children; <tt class="docutils literal"><span class="pre">false</span></tt> to not apply only to child directories and files.</p>
</td>
</tr>
<tr class="row-even"><td><p class="first last"><tt class="docutils literal"><span class="pre">:one_level_deep</span></tt></p>
</td>
<td><p class="first last">Indicates the depth to which permissions will be applied. Possible values: <tt class="docutils literal"><span class="pre">true</span></tt> to apply only to the first level of children; <tt class="docutils literal"><span class="pre">false</span></tt> to apply to all children.</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
</ul>
<p>The <tt class="docutils literal"><span class="pre">rights</span></tt> attribute can be used as many times as necessary; Chef will apply them to the file or directory as required. For example:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">resource</span> <span class="s2">&quot;x.txt&quot;</span> <span class="k">do</span>
  <span class="n">rights</span> <span class="ss">:read</span><span class="p">,</span> <span class="s2">&quot;Everyone&quot;</span>
  <span class="n">rights</span> <span class="ss">:write</span><span class="p">,</span> <span class="s2">&quot;domain\group&quot;</span>
  <span class="n">rights</span> <span class="ss">:full_control</span><span class="p">,</span> <span class="s2">&quot;group_name_or_user_name&quot;</span>
  <span class="n">rights</span> <span class="ss">:full_control</span><span class="p">,</span> <span class="s2">&quot;user_name&quot;</span><span class="p">,</span> <span class="n">option</span> <span class="o">=&gt;</span> <span class="ss">:applies_to_children</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Some other important things to know when using the <tt class="docutils literal"><span class="pre">rights</span></tt> attribute:</p>
<ul class="simple">
<li>Order independence. It doesn&#8217;t matter if <tt class="docutils literal"><span class="pre">rights</span> <span class="pre">:deny,</span> <span class="pre">&quot;Sally&quot;</span></tt> is placed before or after <tt class="docutils literal"><span class="pre">rights</span> <span class="pre">:read,</span> <span class="pre">&quot;Sally&quot;</span></tt>, Sally will be unable to read the document.</li>
<li>Only inherited rights remain. All existing explicit rights on the object are removed and replaced.</li>
<li>If rights are not specified, nothing will be changed. Chef does not clear out the rights on a file or directory if rights are not specified.</li>
<li>Changing inherited rights can be expensive. Microsoft Windows will propagate rights to all children recursively due to inheritance. This is a normal aspect of Microsoft Windows, so consider the frequency with which this type of action is necessary and take steps to control this type of action if performance is the primary consideration.</li>
</ul>
</div>
<div class="section" id="inheritance">
<h3>Inheritance<a class="headerlink" href="#inheritance" title="Permalink to this headline">¶</a></h3>
<p>By default, a file or directory inherits rights from its parent directory. Most of the time this is the preferred behavior, but sometimes it may be necessary to take steps to more specifically control rights. The <tt class="docutils literal"><span class="pre">inherits</span></tt> attribute can be used to specifically tell Chef to apply (or not apply) inherited rights from its parent directory.</p>
<p>For example, the following example specifies the rights for a directory:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">directory</span> <span class="s1">&#39;C:\mordor&#39;</span> <span class="k">do</span>
  <span class="n">rights</span> <span class="ss">:read</span><span class="p">,</span> <span class="s1">&#39;MORDOR\Minions&#39;</span>
  <span class="n">rights</span> <span class="ss">:full_control</span><span class="p">,</span> <span class="s1">&#39;MORDOR\Sauron&#39;</span>
<span class="k">end</span>
</pre></div>
</div>
<p>and then the following example specifies how to use inheritance to deny access to the child directory:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">directory</span> <span class="s1">&#39;C:\mordor\mount_doom&#39;</span> <span class="k">do</span>
  <span class="n">rights</span> <span class="ss">:full_control</span><span class="p">,</span> <span class="s1">&#39;MORDOR\Sauron&#39;</span>
  <span class="n">inherits</span> <span class="kp">false</span> <span class="c1"># Sauron is the only person who should have any sort of access</span>
<span class="k">end</span>
</pre></div>
</div>
<p>If the <tt class="docutils literal"><span class="pre">:deny</span></tt> permission were to be used instead, something could slip through unless all users and groups were denied.</p>
<p>Another example also shows how to specify rights for a directory:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">directory</span> <span class="s1">&#39;C:\mordor&#39;</span> <span class="k">do</span>
  <span class="n">rights</span> <span class="ss">:read</span><span class="p">,</span> <span class="s1">&#39;MORDOR\Minions&#39;</span>
  <span class="n">rights</span> <span class="ss">:full_control</span><span class="p">,</span> <span class="s1">&#39;MORDOR\Sauron&#39;</span>
  <span class="n">rights</span> <span class="ss">:write</span><span class="p">,</span> <span class="s1">&#39;SHIRE\Frodo&#39;</span> <span class="c1"># Who put that there I didn&#39;t put that there</span>
<span class="k">end</span>
</pre></div>
</div>
<p>but then not use the <tt class="docutils literal"><span class="pre">inherits</span></tt> attribute to deny those rights on a child directory:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">directory</span> <span class="s1">&#39;C:\mordor\mount_doom&#39;</span> <span class="k">do</span>
  <span class="n">rights</span> <span class="ss">:deny</span><span class="p">,</span> <span class="s1">&#39;MORDOR\Minions&#39;</span> <span class="c1"># Oops, not specific enough</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Because the <tt class="docutils literal"><span class="pre">inherits</span></tt> attribute is not specified, Chef will default it to <tt class="docutils literal"><span class="pre">true</span></tt>, which will ensure that security settings for existing files remain unchanged.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="resource_common_actions.html" title="Common Actions for Resources"
             >next</a></li>
        <li class="right" >
          <a href="resource_chef_gem.html" title="chef_gem"
             >previous</a> |</li>
        <li><a href="http://docs.opscode.com/chef/knife.html" target="_products">Knife</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/resources.html" target="_products">Resources</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/dsl_recipe.html" target="_products">Recipe DSL</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/lwrps_custom.html" target="_products">LWRPs</a>&#149;</li>
        <li><a href="http://docs.opscode.com/search.html">Search the Docs</a>&#149;</li>
        <li><a href="http://docs.opscode.com/">Home</a> &raquo;</li>

          <li><a href="resource.html" >About Resources and Providers</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
    This work is licensed under a Creative Commons Attribution 3.0 Unported License.
    </div>


    <div class="footer">
        &copy; Copyright This work is licensed under a Creative Commons Attribution 3.0 Unported License.
    </div>

<!-- Start of Async Google Analytics Code -->
<script type="text/javascript">
var _gaq = _gaq || [];
var pluginUrl = (('https:' == document.location.protocol) ? 'https://ssl.' : 'http://www.') + 'google-analytics.com/plugins/ga/inpage_linkid.js';
_gaq.push(['_setAccount', 'UA-6369228-7']);
_gaq.push(['_setDomainName', '.opscode.com']);
_gaq.push(['_setAllowHash', false]);
_gaq.push(['_setAllowLinker', true]);
_gaq.push(['_addIgnoredRef','opscode.com']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript';
  ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0];
  s.parentNode.insertBefore(ga, s); })();
</script>
<!-- End of Async HubSpot Analytics Code -->

<!-- Start of Async HubSpot Analytics Code -->
<script type="text/javascript">
(function(d,s,i,r) {
            if (d.getElementById(i)){return;}
            var n=d.createElement(s),e=d.getElementsByTagName(s)[0];
            n.id=i;n.src='//js.hubspot.com/analytics/'+(Math.ceil(new Date()/r)*r)+'/57718.js';
            e.parentNode.insertBefore(n, e);
        })(document,"script","hs-analytics",300000);
    </script>
<!-- End of Async HubSpot Analytics Code -->

<!-- Start of Contact Analytics Code -->
<script type="text/javascript">
(function() {
  var didInit = false;
  function initMunchkin() {
    if(didInit === false) {
      didInit = true;
      Munchkin.init('255-VFB-268');
    }
  }
  var s = document.createElement('script');
  s.type = 'text/javascript';
  s.async = true;
  s.src = document.location.protocol + '//munchkin.marketo.net/munchkin.js';
  s.onreadystatechange = function() {
    if (this.readyState == 'complete' || this.readyState == 'loaded') {
      initMunchkin();
    }
  };
  s.onload = initMunchkin;
  document.getElementsByTagName('head')[0].appendChild(s);
})();
</script>
<!-- End of Contact Analytics Code -->


  </body>
</html>
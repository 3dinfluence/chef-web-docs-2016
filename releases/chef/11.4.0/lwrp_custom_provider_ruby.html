

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Lightweight Providers w/Custom Ruby &mdash; Chef Docs</title>
    
    <link rel="stylesheet" href="_static/opscode.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.0.1-1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="shortcut icon" href="_static/opscode.ico"/>
    <link rel="top" title="Chef Docs" href="index.html" />
    <link rel="up" title="About LWRPs" href="lwrp.html" />
    <link rel="next" title="Lightweight Resources" href="lwrp_custom_resource.html" />
    <link rel="prev" title="Lightweight Providers w/Chef Resources" href="lwrp_custom_provider.html" /> 
  </head>
  <body>
<div style="background-color: #212c35; text-align: left; padding: 0px 0px 0px 0px">
<a href="http://docs.opscode.com/"><img src="_static/opscode_html_logo.png" border="0" alt="Opscode"/></a>
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="lwrp_custom_resource.html" title="Lightweight Resources"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="lwrp_custom_provider.html" title="Lightweight Providers w/Chef Resources"
             accesskey="P">previous</a> |</li>
        <li><a href="http://docs.opscode.com/chef/knife.html" target="_products">Knife</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/resources.html" target="_products">Resources</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/dsl_recipe.html" target="_products">Recipe DSL</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/lwrps_custom.html" target="_products">LWRPs</a>&#149;</li>
        <li><a href="http://docs.opscode.com/search.html">Search the Docs</a>&#149;</li>
        <li><a href="http://docs.opscode.com/">Home</a> &raquo;</li>

          <li><a href="lwrp.html" accesskey="U">About LWRPs</a> &raquo;</li> 
      </ul>
    </div>

      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/opscode_chef_html_logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Lightweight Providers w/Custom Ruby</a><ul>
<li><a class="reference internal" href="#syntax">Syntax</a></li>
<li><a class="reference internal" href="#dsl-provider-methods">Provider DSL Methods</a><ul>
<li><a class="reference internal" href="#action">action</a></li>
<li><a class="reference internal" href="#converge-by">converge_by</a></li>
<li><a class="reference internal" href="#current-resource">current_resource</a></li>
<li><a class="reference internal" href="#load-current-resource">load_current_resource</a></li>
<li><a class="reference internal" href="#new-resource">new_resource</a></li>
<li><a class="reference internal" href="#updated-by-last-action">updated_by_last_action</a></li>
<li><a class="reference internal" href="#whyrun-supported">whyrun_supported?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#condition-statements">Condition Statements</a></li>
<li><a class="reference internal" href="#log-entries">Log Entries</a><ul>
<li><a class="reference internal" href="#rescue">rescue</a></li>
</ul>
</li>
<li><a class="reference internal" href="#libraries">Libraries</a></li>
<li><a class="reference internal" href="#examples">Examples</a><ul>
<li><a class="reference internal" href="#rbenv-global">rbenv_global</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="lightweight-providers-w-custom-ruby">
<h1>Lightweight Providers w/Custom Ruby<a class="headerlink" href="#lightweight-providers-w-custom-ruby" title="Permalink to this headline">¶</a></h1>
<p>Where a resource represents a piece of the system (and its desired state), a provider defines the steps that are needed to bring that piece of the system from its current state into the desired state. These steps are de-coupled from the request itself. The request is made in a recipe and is defined by a lightweight resource. The steps are then defined by a lightweight provider.</p>
<p>A lightweight provider is a custom provider that defines the steps that are required to complete one (or more) actions defined by a lightweight resource. A lightweight provider and lightweight resource work together, each being defined in the same cookbook (the <tt class="docutils literal"><span class="pre">/providers</span></tt> and <tt class="docutils literal"><span class="pre">/resources</span></tt> subdirectories, respectively); together, they are referred as a LWRP (or &#8220;lightweight resource provider&#8221;). A lightweight provider is always authored using Ruby. Anything that can be done using Ruby can be done in a lightweight provider. In addition to using Ruby, the Provider DSL provides additional methods that are specific to Chef.</p>
<div class="section" id="syntax">
<h2>Syntax<a class="headerlink" href="#syntax" title="Permalink to this headline">¶</a></h2>
<p>This section shows some of the common structural elements that appear a lightweight provider that is built using custom Ruby code. Remember:</p>
<ul class="simple">
<li>A lightweight provider tells Chef how to complete a task</li>
<li>The structure of a lightweight provider will vary, depending on the complexity of the tasks required to complete an action</li>
<li>At its core, a lightweight provider is just Ruby code, which means that anything that can be done in Ruby can be done in a lightweight provider</li>
</ul>
<p>The basic syntax for a lightweight provider that is built using custom Ruby code is as follows:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="nb">require</span> <span class="sr">/path/</span><span class="n">to</span><span class="o">/</span><span class="n">file</span>

<span class="kp">include</span> <span class="no">Include</span><span class="o">::</span><span class="no">Class</span><span class="o">::</span><span class="no">Here</span>

<span class="k">def</span> <span class="nf">whyrun_supported?</span>
  <span class="kp">true</span>
<span class="k">end</span>

<span class="n">action</span> <span class="ss">:action_name</span> <span class="k">do</span>
  <span class="n">converge_by</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">condition</span> <span class="nb">test</span>
      <span class="c1"># some Ruby code</span>
    <span class="k">end</span>
    <span class="no">Chef</span><span class="o">::</span><span class="no">Log</span><span class="o">.</span><span class="n">log_type</span> <span class="s2">&quot;log_message&quot;</span>
  <span class="k">end</span>
  <span class="n">new_resource</span><span class="o">.</span><span class="n">updated_by_last_action</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
<span class="k">end</span>

<span class="o">.</span><span class="n">.</span><span class="o">.</span>

<span class="k">def</span> <span class="nf">test?</span><span class="p">()</span>
  <span class="c1"># some Ruby code</span>
<span class="k">end</span>
</pre></div>
</div>
<p>where:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">require</span></tt> is a standard Ruby method that allows a lightweight provider to require modules that are not located in the current cookbook, such as a file located in the <tt class="docutils literal"><span class="pre">chef/mixin</span></tt> directory</li>
<li><tt class="docutils literal"><span class="pre">include</span></tt> is a standard Ruby method that allows a lightweight provider to include a class, such as <tt class="docutils literal"><span class="pre">Chef::Mixin::ShellOut</span></tt> or <tt class="docutils literal"><span class="pre">Windows::Helper</span></tt></li>
<li><tt class="docutils literal"><span class="pre">whyrun_supported?</span></tt> indicates whether a lightweight provider can be run in why-run mode</li>
<li><tt class="docutils literal"><span class="pre">action</span></tt> is the code block that tells Chef what to do when the <tt class="docutils literal"><span class="pre">:action_name</span></tt> is used in a recipe</li>
<li><tt class="docutils literal"><span class="pre">converge_by()</span></tt> is used to provide Chef a <tt class="docutils literal"><span class="pre">&quot;message&quot;</span></tt> to be returned when a resource is run in why-run mode</li>
<li><tt class="docutils literal"><span class="pre">condition</span></tt> is a Ruby condition statement (<tt class="docutils literal"><span class="pre">if</span></tt>, <tt class="docutils literal"><span class="pre">else</span></tt>, <tt class="docutils literal"><span class="pre">elseif</span></tt>, <tt class="docutils literal"><span class="pre">unless</span></tt>, <tt class="docutils literal"><span class="pre">while</span></tt>, <tt class="docutils literal"><span class="pre">until</span></tt>, <tt class="docutils literal"><span class="pre">case</span></tt>, or <tt class="docutils literal"><span class="pre">for</span></tt>)</li>
<li><tt class="docutils literal"><span class="pre">test</span></tt> is used to test for idempotence; <tt class="docutils literal"><span class="pre">test</span></tt> can be defined inline within the <tt class="docutils literal"><span class="pre">action</span></tt> block, defined as a method using a <tt class="docutils literal"><span class="pre">def</span></tt> block elsewhere in the lightweight provider (shown as <tt class="docutils literal"><span class="pre">def</span> <span class="pre">test()</span></tt>), or defined using any other pattern that is available in Ruby</li>
<li><tt class="docutils literal"><span class="pre">Chef::Log.log_type</span></tt> is used to tell Chef to create a log entry, where <tt class="docutils literal"><span class="pre">log_type</span></tt> is one of the following types: <tt class="docutils literal"><span class="pre">debug</span></tt>, <tt class="docutils literal"><span class="pre">info</span></tt>, <tt class="docutils literal"><span class="pre">warn</span></tt>, <tt class="docutils literal"><span class="pre">error</span></tt>, or <tt class="docutils literal"><span class="pre">fatal</span></tt></li>
<li><tt class="docutils literal"><span class="pre">updated_by_last_action</span></tt> is used to notify that a node was updated successfully</li>
</ul>
<p>Also, commonly used methods (but not shown in the previous example) are <tt class="docutils literal"><span class="pre">current_resource</span></tt>, <tt class="docutils literal"><span class="pre">load_current_resource</span></tt>, and <tt class="docutils literal"><span class="pre">new_resource</span></tt>.</p>
<p>For example:</p>
<div class="highlight-ruby"><div class="highlight"><pre>
</pre></div>
</div>
<div class="highlight-ruby"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;chef/mixin/shell_out&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;chef/mixin/language&#39;</span>
<span class="kp">include</span> <span class="no">Chef</span><span class="o">::</span><span class="no">Mixin</span><span class="o">::</span><span class="no">ShellOut</span>

<span class="n">action</span> <span class="ss">:install</span> <span class="k">do</span>
  <span class="k">unless</span> <span class="vi">@pmgroup</span><span class="o">.</span><span class="n">exists</span>
    <span class="n">run_command_with_systems_locale</span><span class="p">(</span>
      <span class="ss">:command</span> <span class="o">=&gt;</span> <span class="s2">&quot;pacman --sync --noconfirm --noprogressbar</span><span class="si">#{</span><span class="n">expand_options</span><span class="p">(</span><span class="vi">@new_resource</span><span class="o">.</span><span class="n">options</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">new_resource</span><span class="o">.</span><span class="n">updated_by_last_action</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">action</span> <span class="ss">:remove</span> <span class="k">do</span>
  <span class="k">if</span> <span class="vi">@pmgroup</span><span class="o">.</span><span class="n">exists</span>
    <span class="n">run_command_with_systems_locale</span><span class="p">(</span>
      <span class="ss">:command</span> <span class="o">=&gt;</span> <span class="s2">&quot;pacman --remove --noconfirm --noprogressbar</span><span class="si">#{</span><span class="n">expand_options</span><span class="p">(</span><span class="vi">@new_resource</span><span class="o">.</span><span class="n">options</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">new_resource</span><span class="o">.</span><span class="n">updated_by_last_action</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">load_current_resource</span>
  <span class="vi">@pmgroup</span> <span class="o">=</span> <span class="no">Chef</span><span class="o">::</span><span class="no">Resource</span><span class="o">::</span><span class="no">PacmanGroup</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@new_resource</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
  <span class="vi">@pmgroup</span><span class="o">.</span><span class="n">package_name</span><span class="p">(</span><span class="vi">@new_resource</span><span class="o">.</span><span class="n">package_name</span><span class="p">)</span>
  <span class="no">Chef</span><span class="o">::</span><span class="no">Log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Checking pacman for </span><span class="si">#{</span><span class="vi">@new_resource</span><span class="o">.</span><span class="n">package_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="nb">p</span> <span class="o">=</span> <span class="n">shell_out</span><span class="p">(</span><span class="s2">&quot;pacman -Qg </span><span class="si">#{</span><span class="vi">@new_resource</span><span class="o">.</span><span class="n">package_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="n">exists</span> <span class="o">=</span> <span class="nb">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="vi">@new_resource</span><span class="o">.</span><span class="n">package_name</span><span class="p">)</span>
  <span class="vi">@pmgroup</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">exists</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="dsl-provider-methods">
<h2>Provider DSL Methods<a class="headerlink" href="#dsl-provider-methods" title="Permalink to this headline">¶</a></h2>
<p>The Provider DSL is a Ruby DSL that is used to help define a lightweight provider and to ensure that a lightweight provider takes the correct actions when it is called from a recipe. The Provider DSL is a small DSL with just a few methods that are specific to Chef. Because the Provider DSL is a Ruby DSL, anything that can be done using Ruby can also be done when defining a lightweight provider.</p>
<div class="section" id="action">
<h3>action<a class="headerlink" href="#action" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">action</span></tt> method is used to define the steps that will be taken for each of the possible actions defined by the lightweight resource. Each action must be defined in separate <tt class="docutils literal"><span class="pre">action</span></tt> blocks within the same file. The syntax for the <tt class="docutils literal"><span class="pre">action</span></tt> method is as follows:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">action</span> <span class="ss">:action_name</span> <span class="k">do</span>
  <span class="k">if</span> <span class="vi">@current_resource</span><span class="o">.</span><span class="n">exists</span>
    <span class="no">Chef</span><span class="o">::</span><span class="no">Log</span><span class="o">.</span><span class="n">info</span> <span class="s2">&quot;</span><span class="si">#{</span> <span class="vi">@new_resource</span> <span class="si">}</span><span class="s2"> already exists - nothing to do.&quot;</span>
  <span class="k">else</span>
    <span class="n">converge_by</span><span class="p">(</span><span class="s2">&quot;Create resource </span><span class="si">#{</span> <span class="vi">@new_resource</span> <span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="n">resource</span> <span class="s2">&quot;resource_name&quot;</span> <span class="k">do</span>
        <span class="no">Chef</span><span class="o">::</span><span class="no">Log</span><span class="o">.</span><span class="n">info</span> <span class="s2">&quot;</span><span class="si">#{</span> <span class="vi">@new_resource</span> <span class="si">}</span><span class="s2"> created.&quot;</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="n">new_resource</span><span class="o">.</span><span class="n">updated_by_last_action</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
<p>where:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">:action_name</span></tt> corresponds to an action defined by a lightweight resource</li>
<li><tt class="docutils literal"><span class="pre">if</span> <span class="pre">&#64;current_resource.exists</span></tt> is a condition test that is using an instance variable to see if the object already exists; this is an example of a test for idempotency</li>
<li>If the object already exists, a <tt class="docutils literal"><span class="pre">#{</span> <span class="pre">&#64;new_resource</span> <span class="pre">}</span> <span class="pre">already</span> <span class="pre">exists</span> <span class="pre">-</span> <span class="pre">nothing</span> <span class="pre">to</span> <span class="pre">do.</span></tt> log entry is created</li>
<li>If the object does not already exists, the <tt class="docutils literal"><span class="pre">resource</span></tt> block is run. This block is a recipe that tells Chef what to do. A <tt class="docutils literal"><span class="pre">#{</span> <span class="pre">&#64;new_resource</span> <span class="pre">}</span> <span class="pre">created.</span></tt> log entry is created</li>
<li><tt class="docutils literal"><span class="pre">converge_by</span></tt> tells Chef which message to provide when Chef is run in why-run mode</li>
</ul>
</div>
<div class="section" id="converge-by">
<h3>converge_by<a class="headerlink" href="#converge-by" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">converge_by</span></tt> method is a wrapper that is used to tell Chef what do if a resource is run in why-run mode. The syntax for the <tt class="docutils literal"><span class="pre">converge_by</span></tt> method is:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">converge_by</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>where:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">converge_by()</span></tt> is added to an <tt class="docutils literal"><span class="pre">action</span></tt> block as a wrapper</li>
<li><tt class="docutils literal"><span class="pre">&quot;message&quot;</span></tt> is the message that Chef returns when it is run in why-run mode</li>
</ul>
<p>Some examples:</p>
<p>where the last example shows using a variable (<tt class="docutils literal"><span class="pre">description</span></tt>) as the <tt class="docutils literal"><span class="pre">&quot;message&quot;</span></tt> in the <tt class="docutils literal"><span class="pre">converge_by</span></tt> block.</p>
<p>An example of the <tt class="docutils literal"><span class="pre">converge_by</span></tt> method being used in the <a class="reference external" href="https://github.com/opscode/chef/blob/master/lib/chef/provider/directory.rb">directory</a> provider, which is a core Chef resource:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">def</span> <span class="nf">whyrun_supported?</span>
  <span class="kp">true</span>
<span class="k">end</span>

<span class="o">.</span><span class="n">.</span><span class="o">.</span>

<span class="k">def</span> <span class="nf">action_create</span>
  <span class="k">unless</span> <span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">exist?</span><span class="p">(</span><span class="vi">@new_resource</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
    <span class="n">converge_by</span><span class="p">(</span><span class="s2">&quot;create new directory </span><span class="si">#{</span><span class="vi">@new_resource</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">do</span>
      <span class="k">if</span> <span class="vi">@new_resource</span><span class="o">.</span><span class="n">recursive</span> <span class="o">==</span> <span class="kp">true</span>
        <span class="o">::</span><span class="no">FileUtils</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="vi">@new_resource</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="o">::</span><span class="no">Dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="vi">@new_resource</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
      <span class="k">end</span>
      <span class="no">Chef</span><span class="o">::</span><span class="no">Log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@new_resource</span><span class="si">}</span><span class="s2"> created directory </span><span class="si">#{</span><span class="vi">@new_resource</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="n">set_all_access_controls</span>
  <span class="n">update_new_file_state</span>
<span class="k">end</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">why-run mode is already enabled for core Chef resources. When core Chef resources are used as part of the <tt class="docutils literal"><span class="pre">action</span></tt> block in a lightweight provider, only the <tt class="docutils literal"><span class="pre">whyrun_supported?</span></tt> is required to allow Chef to run in why-run mode.</p>
</div>
</div>
<div class="section" id="current-resource">
<h3>current_resource<a class="headerlink" href="#current-resource" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">current_resource</span></tt> method is used to represent a resource as it exists on the node at the beginning of the Chef run. In other words: what the resource is currently. Chef compares the resource as it exists on the node to the resource that is created during the Chef run to determine what steps need to be taken to bring the resource into the desired state. This method is often used as an instance variable (<tt class="docutils literal"><span class="pre">&#64;current_resource</span></tt>).</p>
<p>For example:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">action</span> <span class="ss">:add</span> <span class="k">do</span>
  <span class="k">unless</span> <span class="vi">@current_resource</span><span class="o">.</span><span class="n">exists</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">appcmd</span><span class="si">}</span><span class="s2"> add app /site.name:</span><span class="se">\&quot;</span><span class="si">#{</span><span class="vi">@new_resource</span><span class="o">.</span><span class="n">app_name</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
    <span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot; /path:</span><span class="se">\&quot;</span><span class="si">#{</span><span class="vi">@new_resource</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
    <span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot; /applicationPool:</span><span class="se">\&quot;</span><span class="si">#{</span><span class="vi">@new_resource</span><span class="o">.</span><span class="n">application_pool</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="vi">@new_resource</span><span class="o">.</span><span class="n">application_pool</span>
    <span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot; /physicalPath:</span><span class="se">\&quot;</span><span class="si">#{</span><span class="vi">@new_resource</span><span class="o">.</span><span class="n">physical_path</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="vi">@new_resource</span><span class="o">.</span><span class="n">physical_path</span>
    <span class="no">Chef</span><span class="o">::</span><span class="no">Log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="n">shell_out!</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="no">Chef</span><span class="o">::</span><span class="no">Log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;App created&quot;</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="no">Chef</span><span class="o">::</span><span class="no">Log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@new_resource</span><span class="si">}</span><span class="s2"> app already exists - nothing to do&quot;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>where the <tt class="docutils literal"><span class="pre">unless</span></tt> conditional statement checks to make sure the resource doesn&#8217;t already exist on a node, and then runs a series of commands when it doesn&#8217;t. If the resource already exists, the log entry would be &#8220;Foo app already exists - nothing to do.&#8221;</p>
</div>
<div class="section" id="load-current-resource">
<h3>load_current_resource<a class="headerlink" href="#load-current-resource" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">load_current_resource</span></tt> method is used to find a resource on a node based on a collection of attributes. These attributes are defined in a lightweight resource and are loaded by Chef when processing a recipe during a Chef run. This method will ask Chef to look on the node to see if a resource exists with specific matching attributes.</p>
<p>For example:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">def</span> <span class="nf">load_current_resource</span>
  <span class="vi">@current_resource</span> <span class="o">=</span> <span class="no">Chef</span><span class="o">::</span><span class="no">Resource</span><span class="o">::</span><span class="no">TransmissionTorrentFile</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@new_resource</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
  <span class="no">Chef</span><span class="o">::</span><span class="no">Log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@new_resource</span><span class="si">}</span><span class="s2"> torrent hash = </span><span class="si">#{</span><span class="n">torrent_hash</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="vi">@transmission</span> <span class="o">=</span> <span class="no">Opscode</span><span class="o">::</span><span class="no">Transmission</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;foo:</span><span class="si">#{</span><span class="vi">@new_resource</span><span class="o">.</span><span class="n">att1</span><span class="si">}</span><span class="s2">@</span><span class="si">#{</span><span class="vi">@new_resource</span><span class="o">.</span><span class="n">att2</span><span class="si">}</span><span class="s2">:</span><span class="si">#{</span><span class="vi">@new_resource</span><span class="o">.</span><span class="n">att3</span><span class="si">}</span><span class="s2">/path&quot;</span><span class="p">)</span>
  <span class="vi">@torrent</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="k">begin</span>
    <span class="vi">@torrent</span> <span class="o">=</span> <span class="vi">@transmission</span><span class="o">.</span><span class="n">get_torrent</span><span class="p">(</span><span class="n">torrent_hash</span><span class="p">)</span>
    <span class="no">Chef</span><span class="o">::</span><span class="no">Log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Found existing </span><span class="si">#{</span><span class="vi">@new_resource</span><span class="si">}</span><span class="s2"> in swarm with name of &#39;</span><span class="si">#{</span><span class="vi">@torrent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; and status of &#39;</span><span class="si">#{</span><span class="vi">@torrent</span><span class="o">.</span><span class="n">status_message</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="vi">@current_resource</span><span class="o">.</span><span class="n">torrent</span><span class="p">(</span><span class="vi">@new_resource</span><span class="o">.</span><span class="n">torrent</span><span class="p">)</span>
  <span class="k">rescue</span>
    <span class="no">Chef</span><span class="o">::</span><span class="no">Log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Cannot find </span><span class="si">#{</span><span class="vi">@new_resource</span><span class="si">}</span><span class="s2"> in the swarm&quot;</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="vi">@current_resource</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="new-resource">
<h3>new_resource<a class="headerlink" href="#new-resource" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">new_resource</span></tt> method is used to represent a resource as loaded by Chef during the Chef run. In other words: what the resource should be. Chef compares the resource as it exists on the node to the resource that is created during the Chef run to determine what steps need to be taken to bring the resource into the desired state. This method can be used as an instance variable (<tt class="docutils literal"><span class="pre">&#64;new_resource</span></tt>).</p>
<p>For example:</p>
<div class="highlight-ruby"><div class="highlight"><pre> <span class="n">action</span> <span class="ss">:delete</span> <span class="k">do</span>
  <span class="k">if</span> <span class="n">exists?</span>
    <span class="k">if</span> <span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">writable?</span><span class="p">(</span><span class="vi">@new_resource</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
      <span class="no">Chef</span><span class="o">::</span><span class="no">Log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleting </span><span class="si">#{</span><span class="vi">@new_resource</span><span class="si">}</span><span class="s2"> at </span><span class="si">#{</span><span class="vi">@new_resource</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="vi">@new_resource</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
      <span class="n">new_resource</span><span class="o">.</span><span class="n">updated_by_last_action</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="k">raise</span> <span class="s2">&quot;Cannot delete </span><span class="si">#{</span><span class="vi">@new_resource</span><span class="si">}</span><span class="s2"> at </span><span class="si">#{</span><span class="vi">@new_resource</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">!&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>where Chef checks to see if the file exists, then if the file is writable, and then attempts to delete the resource. <tt class="docutils literal"><span class="pre">path</span></tt> is an attribute of the new resource that is defined by the lightweight resource.</p>
</div>
<div class="section" id="updated-by-last-action">
<h3>updated_by_last_action<a class="headerlink" href="#updated-by-last-action" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">updated_by_last_action</span></tt> method is used to notify a lightweight resource that a node was updated successfully. For example, the <tt class="docutils literal"><span class="pre">bluepill_service</span></tt> lightweight resource in the <strong>bluepill</strong> cookbook uses this method:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">action</span> <span class="ss">:load</span> <span class="k">do</span>
  <span class="k">unless</span> <span class="vi">@current_resource</span><span class="o">.</span><span class="n">running</span>
    <span class="n">shell_out!</span><span class="p">(</span><span class="n">load_command</span><span class="p">)</span>
    <span class="n">new_resource</span><span class="o">.</span><span class="n">updated_by_last_action</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="o">.</span><span class="n">.</span><span class="o">.</span>

<span class="k">def</span> <span class="nf">load_command</span>
  <span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;bluepill&#39;</span><span class="o">][</span><span class="s1">&#39;bin&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2"> load </span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;bluepill&#39;</span><span class="o">][</span><span class="s1">&#39;conf_dir&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">new_resource</span><span class="o">.</span><span class="n">service_name</span><span class="si">}</span><span class="s2">.pill&quot;</span>
<span class="k">end</span>

<span class="o">.</span><span class="n">.</span><span class="o">.</span>
</pre></div>
</div>
</div>
<div class="section" id="whyrun-supported">
<h3>whyrun_supported?<a class="headerlink" href="#whyrun-supported" title="Permalink to this headline">¶</a></h3>
<p>why-run mode is a way to see what Chef would have configured, had an actual Chef run occurred. This approach is similar to the concept of &#8220;no-operation&#8221; (or &#8220;no-op&#8221;): decide what should be done, but then don&#8217;t actually do anything until it&#8217;s done right. This approach to configuration management can help identify where complexity exists in the system, where inter-dependencies may be located, and to verify that everything will be configured in the desired manner.</p>
<p>When why-run mode is enabled, a Chef run will occur that does everything up to the point at which configuration would normally occur. This includes getting the configuration data, authenticating to the Chef Server, rebuilding the node object, expanding the run list, getting the necessary cookbook files, resetting node attributes, identifying the resources, and building the resource collection and does not include mapping each resource to a provider or configuring any part of the system.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">why-run mode is not a replacement for running cookbooks in a test environment that mirrors the production environment. Opscode uses why-run mode to learn more about what is going on, but also test-kitchen on developer systems, along with an internal OpenStack cloud and external cloud providers to test more thoroughly.</p>
</div>
<p>When Chef is run in why-run mode, certain assumptions are made:</p>
<ul class="simple">
<li>If the <strong>service</strong> resource cannot find the appropriate command to verify the status of a service, why-run mode will assume that the command would have been installed by a previous resource and that the service would not be running</li>
<li>For <tt class="docutils literal"><span class="pre">not_if</span></tt> and <tt class="docutils literal"><span class="pre">only_if</span></tt> attribute, why-run mode will assume these are commands or blocks that are safe to run. These conditions are not designed to be used to change the state of the system, but rather to help facilitate idempotency for the resource itself. That said, it may be possible that these attributes are being used in a way that modifies the system state</li>
<li>The closer the current state of the system is to the desired state, the more useful why-run mode will be. For example, if a full run-list is run against a fresh system, that run-list may not be completely correct on the first try, but also that run-list will produce more output than smaller run-list</li>
</ul>
<p>The <tt class="docutils literal"><span class="pre">whyrun_supported?</span></tt> method is used to set a lightweight provider to support why-run mode. The syntax for the <tt class="docutils literal"><span class="pre">whyrun_supported?</span></tt> method is as follows:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">def</span> <span class="nf">whyrun_supported?</span>
  <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">whyrun_supported?</span></tt> is set to <tt class="docutils literal"><span class="pre">true</span></tt> for any lightweight provider that supports using why-run mode. When why-run mode is supported by the a lightweight provider, the <tt class="docutils literal"><span class="pre">converge_by</span></tt> method is used to define the strings that are logged by Chef when it is run in why-run mode.</p>
</div>
</div>
<div class="section" id="condition-statements">
<h2>Condition Statements<a class="headerlink" href="#condition-statements" title="Permalink to this headline">¶</a></h2>
<p>A lightweight provider can use any conditional statement that can be used in Ruby: <tt class="docutils literal"><span class="pre">if</span></tt>, <tt class="docutils literal"><span class="pre">else</span></tt>, <tt class="docutils literal"><span class="pre">elseif</span></tt>, <tt class="docutils literal"><span class="pre">unless</span></tt>, <tt class="docutils literal"><span class="pre">while</span></tt>, <tt class="docutils literal"><span class="pre">until</span></tt>, <tt class="docutils literal"><span class="pre">case</span></tt>, and <tt class="docutils literal"><span class="pre">for</span></tt>. A condition statement can test for:</p>
<ul class="simple">
<li>A Ruby class (such as <tt class="docutils literal"><span class="pre">::File</span></tt> or <tt class="docutils literal"><span class="pre">::String</span></tt>)</li>
<li>A Chef class (such as <tt class="docutils literal"><span class="pre">::Chef::Mixin::ShellOut</span></tt>)</li>
<li>Conditions present on the node by using <tt class="docutils literal"><span class="pre">&#64;current_resource</span></tt></li>
<li>Conditions present within the resource being processed by Chef during the Chef run by using <tt class="docutils literal"><span class="pre">new_resource</span></tt> or <tt class="docutils literal"><span class="pre">&#64;new_resource</span></tt></li>
<li>To verify if a resource was updated by using <tt class="docutils literal"><span class="pre">updated_by_last_action</span></tt>, for example: <tt class="docutils literal"><span class="pre">&#64;new_resource.updated_by_last_action</span></tt></li>
</ul>
<p>and so on.</p>
<p>For example, an <tt class="docutils literal"><span class="pre">if</span></tt> statement is used to check if a file exists (<tt class="docutils literal"><span class="pre">::File.exists?</span></tt>), and then if the file exists to delete a key from that file.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">action</span> <span class="ss">:remove</span> <span class="k">do</span>
  <span class="k">if</span> <span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="s2">&quot;/etc/pki/rpm-gpg/</span><span class="si">#{</span><span class="n">new_resource</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="no">Chef</span><span class="o">::</span><span class="no">Log</span><span class="o">.</span><span class="n">info</span> <span class="s2">&quot;Removing </span><span class="si">#{</span><span class="n">new_resource</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2"> key from /etc/pki/rpm-gpg/&quot;</span>
    <span class="n">file</span> <span class="s2">&quot;/etc/pki/rpm-gpg/</span><span class="si">#{</span><span class="n">new_resource</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
      <span class="n">action</span> <span class="ss">:delete</span>
    <span class="k">end</span>
    <span class="n">new_resource</span><span class="o">.</span><span class="n">updated_by_last_action</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>In the following example an <tt class="docutils literal"><span class="pre">unless</span></tt> statement is used to add a key, unless that node object already has that key assigned to it:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">unless</span> <span class="n">new_resource</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">nil?</span>
  <span class="n">remote_file</span> <span class="s2">&quot;/etc/pki/rpm-gpg/</span><span class="si">#{</span><span class="n">new_resource</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
    <span class="n">source</span> <span class="n">new_resource</span><span class="o">.</span><span class="n">url</span>
    <span class="n">mode</span> <span class="s2">&quot;0644&quot;</span>
    <span class="n">notifies</span> <span class="ss">:run</span><span class="p">,</span> <span class="s2">&quot;execute[import-rpm-gpg-key-</span><span class="si">#{</span><span class="n">new_resource</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="ss">:immediately</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">action</span> <span class="ss">:add</span> <span class="k">do</span>
  <span class="k">unless</span> <span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="s2">&quot;/etc/yum.repos.d/</span><span class="si">#{</span><span class="n">new_resource</span><span class="o">.</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">.repo&quot;</span><span class="p">)</span>
    <span class="no">Chef</span><span class="o">::</span><span class="no">Log</span><span class="o">.</span><span class="n">info</span> <span class="s2">&quot;Adding </span><span class="si">#{</span><span class="n">new_resource</span><span class="o">.</span><span class="n">repo_name</span><span class="si">}</span><span class="s2"> repository to /etc/yum.repos.d/</span><span class="si">#{</span><span class="n">new_resource</span><span class="o">.</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">.repo&quot;</span>
    <span class="n">repo_config</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="log-entries">
<h2>Log Entries<a class="headerlink" href="#log-entries" title="Permalink to this headline">¶</a></h2>
<p>Use the <tt class="docutils literal"><span class="pre">Chef::Log</span></tt> class in a lightweight provider to define log entries that are created during a Chef run. The syntax for a log message is as follows:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="no">Chef</span><span class="o">::</span><span class="no">Log</span><span class="o">.</span><span class="n">log_type</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>where</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">log_type</span></tt> can be <tt class="docutils literal"><span class="pre">.debug</span></tt>, <tt class="docutils literal"><span class="pre">.info</span></tt>, <tt class="docutils literal"><span class="pre">.warn</span></tt>, <tt class="docutils literal"><span class="pre">.error</span></tt>, or <tt class="docutils literal"><span class="pre">.fatal</span></tt></li>
<li><tt class="docutils literal"><span class="pre">&quot;message&quot;</span></tt> is the message that is logged. For example: <tt class="docutils literal"><span class="pre">&quot;#{&#64;new_resource}</span> <span class="pre">added</span> <span class="pre">module</span> <span class="pre">'#{&#64;new_resource.module_name}'&quot;</span></tt> or <tt class="docutils literal"><span class="pre">&quot;#{&#64;new_resource}</span> <span class="pre">module</span> <span class="pre">already</span> <span class="pre">exists</span> <span class="pre">-</span> <span class="pre">nothing</span> <span class="pre">to</span> <span class="pre">do&quot;</span></tt></li>
</ul>
<p>For example, from the <tt class="docutils literal"><span class="pre">repository.rb</span></tt> provider in the <strong>yum</strong> cookbook:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">action</span> <span class="ss">:add</span> <span class="k">do</span>
  <span class="k">unless</span> <span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="s2">&quot;/etc/yum.repos.d/</span><span class="si">#{</span><span class="n">new_resource</span><span class="o">.</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">.repo&quot;</span><span class="p">)</span>
    <span class="no">Chef</span><span class="o">::</span><span class="no">Log</span><span class="o">.</span><span class="n">info</span> <span class="s2">&quot;Adding </span><span class="si">#{</span><span class="n">new_resource</span><span class="o">.</span><span class="n">repo_name</span><span class="si">}</span><span class="s2"> repository to /etc/yum.repos.d/</span><span class="si">#{</span><span class="n">new_resource</span><span class="o">.</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">.repo&quot;</span>
    <span class="n">repo_config</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>where the <tt class="docutils literal"><span class="pre">Chef::Log</span></tt> class appends <tt class="docutils literal"><span class="pre">.info</span></tt> as the log type. If the name of the repo was &#8220;foo&#8221;, then the log message would be &#8220;Adding foo repository to /etc/yum.repos.d/foo.repo&#8221;.</p>
<p>Another example shows two log entries, one that is triggered when a service is being restarted, and then another that is triggered after the service has been restarted:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">action</span> <span class="ss">:restart</span> <span class="k">do</span>
  <span class="k">if</span> <span class="vi">@current_resource</span><span class="o">.</span><span class="n">running</span>
    <span class="no">Chef</span><span class="o">::</span><span class="no">Log</span><span class="o">.</span><span class="n">debug</span> <span class="s2">&quot;Restarting </span><span class="si">#{</span><span class="n">new_resource</span><span class="o">.</span><span class="n">service_name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">shell_out!</span><span class="p">(</span><span class="n">restart_command</span><span class="p">)</span>
    <span class="n">new_resource</span><span class="o">.</span><span class="n">updated_by_last_action</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
    <span class="no">Chef</span><span class="o">::</span><span class="no">Log</span><span class="o">.</span><span class="n">debug</span> <span class="s2">&quot;Restarted </span><span class="si">#{</span><span class="n">new_resource</span><span class="o">.</span><span class="n">service_name</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<div class="section" id="rescue">
<h3>rescue<a class="headerlink" href="#rescue" title="Permalink to this headline">¶</a></h3>
<p>Use the <tt class="docutils literal"><span class="pre">rescue</span></tt> clause to make sure that a log message is always provided. For example:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">def</span> <span class="nf">load_current_resource</span>
  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
  <span class="k">begin</span>
    <span class="o">.</span><span class="n">.</span><span class="o">.</span>
  <span class="k">rescue</span>
    <span class="no">Chef</span><span class="o">::</span><span class="no">Log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Cannot find </span><span class="si">#{</span><span class="vi">@new_resource</span><span class="si">}</span><span class="s2"> in the swarm&quot;</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="libraries">
<h2>Libraries<a class="headerlink" href="#libraries" title="Permalink to this headline">¶</a></h2>
<p>A lightweight provider can extend another provider class. This can be done as a <tt class="docutils literal"><span class="pre">mixin</span></tt>, which is then placed in a library under the <tt class="docutils literal"><span class="pre">library/</span></tt> directory of any cookbook that will use the extended provider class. The lightweight provider is then written to include that library in its implementation so that it has access to the extended core resource. Use the <tt class="docutils literal"><span class="pre">include</span></tt> method in the lightweight provider to ensure that a lightweight provider has access to an external library.</p>
<p>For example:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="kp">include</span> <span class="no">Chef</span><span class="o">::</span><span class="no">Mixin</span><span class="o">::</span><span class="no">ShellOut</span>
</pre></div>
</div>
</div>
<div class="section" id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<p>The following examples show various lightweight providers that rely on custom Ruby code.</p>
<div class="section" id="rbenv-global">
<h3>rbenv_global<a class="headerlink" href="#rbenv-global" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">rbenv_global</span></tt> lightweight provider from the <a class="reference external" href="https://github.com/fnichol/chef-rbenv">chef-rbenv</a> cookbook shows a custom lightweight provider that  sets the global version of Ruby:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="kp">include</span> <span class="no">Chef</span><span class="o">::</span><span class="no">Rbenv</span><span class="o">::</span><span class="no">ScriptHelpers</span>

<span class="n">action</span> <span class="ss">:create</span> <span class="k">do</span>
  <span class="k">if</span> <span class="n">current_global_version</span> <span class="o">!=</span> <span class="n">new_resource</span><span class="o">.</span><span class="n">rbenv_version</span>
    <span class="n">command</span> <span class="o">=</span> <span class="sx">%{rbenv global </span><span class="si">#{</span><span class="n">new_resource</span><span class="o">.</span><span class="n">rbenv_version</span><span class="si">}</span><span class="sx">}</span>
    <span class="n">rbenv_script</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">command</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">which_rbenv</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
      <span class="n">code</span>        <span class="n">command</span>
      <span class="n">user</span>        <span class="n">new_resource</span><span class="o">.</span><span class="n">user</span>       <span class="k">if</span> <span class="n">new_resource</span><span class="o">.</span><span class="n">user</span>
      <span class="n">root_path</span>   <span class="n">new_resource</span><span class="o">.</span><span class="n">root_path</span>  <span class="k">if</span> <span class="n">new_resource</span><span class="o">.</span><span class="n">root_path</span>
      <span class="n">action</span>      <span class="ss">:nothing</span>
    <span class="k">end</span><span class="o">.</span><span class="n">run_action</span><span class="p">(</span><span class="ss">:run</span><span class="p">)</span>

    <span class="n">new_resource</span><span class="o">.</span><span class="n">updated_by_last_action</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="no">Chef</span><span class="o">::</span><span class="no">Log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">new_resource</span><span class="si">}</span><span class="s2"> is already set - nothing to do&quot;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="lwrp_custom_resource.html" title="Lightweight Resources"
             >next</a></li>
        <li class="right" >
          <a href="lwrp_custom_provider.html" title="Lightweight Providers w/Chef Resources"
             >previous</a> |</li>
        <li><a href="http://docs.opscode.com/chef/knife.html" target="_products">Knife</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/resources.html" target="_products">Resources</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/dsl_recipe.html" target="_products">Recipe DSL</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/lwrps_custom.html" target="_products">LWRPs</a>&#149;</li>
        <li><a href="http://docs.opscode.com/search.html">Search the Docs</a>&#149;</li>
        <li><a href="http://docs.opscode.com/">Home</a> &raquo;</li>

          <li><a href="lwrp.html" >About LWRPs</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
    This work is licensed under a Creative Commons Attribution 3.0 Unported License.
    </div>


    <div class="footer">
        &copy; Copyright This work is licensed under a Creative Commons Attribution 3.0 Unported License.
    </div>

<!-- Start of Async Google Analytics Code -->
<script type="text/javascript">
var _gaq = _gaq || [];
var pluginUrl = (('https:' == document.location.protocol) ? 'https://ssl.' : 'http://www.') + 'google-analytics.com/plugins/ga/inpage_linkid.js';
_gaq.push(['_setAccount', 'UA-6369228-7']);
_gaq.push(['_setDomainName', '.opscode.com']);
_gaq.push(['_setAllowHash', false]);
_gaq.push(['_setAllowLinker', true]);
_gaq.push(['_addIgnoredRef','opscode.com']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript';
  ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0];
  s.parentNode.insertBefore(ga, s); })();
</script>
<!-- End of Async HubSpot Analytics Code -->

<!-- Start of Async HubSpot Analytics Code -->
<script type="text/javascript">
(function(d,s,i,r) {
            if (d.getElementById(i)){return;}
            var n=d.createElement(s),e=d.getElementsByTagName(s)[0];
            n.id=i;n.src='//js.hubspot.com/analytics/'+(Math.ceil(new Date()/r)*r)+'/57718.js';
            e.parentNode.insertBefore(n, e);
        })(document,"script","hs-analytics",300000);
    </script>
<!-- End of Async HubSpot Analytics Code -->

<!-- Start of Contact Analytics Code -->
<script type="text/javascript">
(function() {
  var didInit = false;
  function initMunchkin() {
    if(didInit === false) {
      didInit = true;
      Munchkin.init('255-VFB-268');
    }
  }
  var s = document.createElement('script');
  s.type = 'text/javascript';
  s.async = true;
  s.src = document.location.protocol + '//munchkin.marketo.net/munchkin.js';
  s.onreadystatechange = function() {
    if (this.readyState == 'complete' || this.readyState == 'loaded') {
      initMunchkin();
    }
  };
  s.onload = initMunchkin;
  document.getElementsByTagName('head')[0].appendChild(s);
})();
</script>
<!-- End of Contact Analytics Code -->


  </body>
</html>
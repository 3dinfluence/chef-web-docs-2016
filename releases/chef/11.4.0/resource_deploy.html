

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>deploy &mdash; Chef Docs</title>
    
    <link rel="stylesheet" href="_static/opscode.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.0.1-1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="shortcut icon" href="_static/opscode.ico"/>
    <link rel="top" title="Chef Docs" href="index.html" />
    <link rel="up" title="About Resources and Providers" href="resource.html" />
    <link rel="next" title="directory" href="resource_directory.html" />
    <link rel="prev" title="csh" href="resource_csh.html" /> 
  </head>
  <body>
<div style="background-color: #212c35; text-align: left; padding: 0px 0px 0px 0px">
<a href="http://docs.opscode.com/"><img src="_static/opscode_html_logo.png" border="0" alt="Opscode"/></a>
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="resource_directory.html" title="directory"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="resource_csh.html" title="csh"
             accesskey="P">previous</a> |</li>
        <li><a href="http://docs.opscode.com/chef/knife.html" target="_products">Knife</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/resources.html" target="_products">Resources</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/dsl_recipe.html" target="_products">Recipe DSL</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/lwrps_custom.html" target="_products">LWRPs</a>&#149;</li>
        <li><a href="http://docs.opscode.com/search.html">Search the Docs</a>&#149;</li>
        <li><a href="http://docs.opscode.com/">Home</a> &raquo;</li>

          <li><a href="resource.html" accesskey="U">About Resources and Providers</a> &raquo;</li> 
      </ul>
    </div>

      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/opscode_chef_html_logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">deploy</a><ul>
<li><a class="reference internal" href="#syntax">Syntax</a></li>
<li><a class="reference internal" href="#deploy-strategies">Deploy Strategies</a><ul>
<li><a class="reference internal" href="#deploy-phases">Deploy Phases</a><ul>
<li><a class="reference internal" href="#deploy-cache-file">Deploy Cache File</a></li>
</ul>
</li>
<li><a class="reference internal" href="#callbacks">Callbacks</a></li>
<li><a class="reference internal" href="#layout-modifiers">Layout Modifiers</a></li>
</ul>
</li>
<li><a class="reference internal" href="#actions">Actions</a></li>
<li><a class="reference internal" href="#attributes">Attributes</a></li>
<li><a class="reference internal" href="#providers">Providers</a><ul>
<li><a class="reference internal" href="#deploy-branch">deploy_branch</a></li>
<li><a class="reference internal" href="#deploy-revision">deploy_revision</a></li>
<li><a class="reference internal" href="#timestamped-deploy">timestamped_deploy</a></li>
</ul>
</li>
<li><a class="reference internal" href="#examples">Examples</a></li>
</ul>
</li>
</ul>

        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="deploy">
<h1>deploy<a class="headerlink" href="#deploy" title="Permalink to this headline">¶</a></h1>
<p>A <a class="reference external" href="http://docs.opscode.com/resource.html">resource</a> is a key part of a <a class="reference external" href="http://docs.opscode.com/essentials_cookbook_recipes.html">recipe</a> that defines the actions that can be taken against a piece of the system. These actions are identified during each <a class="reference external" href="http://docs.opscode.com/essentials_nodes_chef_run.html">Chef run</a> as the resource collection is compiled. Once identified, each resource (in turn) is mapped to a provider, which then configures each piece of the system.</p>
<p>The <strong>deploy</strong> resource is used to manage and control deployments. It is one of the most popular resources available in Chef and is also the most complex, having the most attributes, multiple providers, the added complexity of callbacks, plus four attributes that support layout modifications from within a recipe.</p>
<p>The <strong>deploy</strong> resource is modeled after Capistrano, a utility and framework for executing commands in parallel on multiple remote machines via SSH. The <strong>deploy</strong> resource in Chef is designed to behave in a way that is similar to the <tt class="docutils literal"><span class="pre">deploy</span></tt> and <tt class="docutils literal"><span class="pre">deploy:migration</span></tt> tasks in Capistrano.</p>
<div class="section" id="syntax">
<h2>Syntax<a class="headerlink" href="#syntax" title="Permalink to this headline">¶</a></h2>
<p>The syntax for using the <strong>deploy</strong> resource in a recipe is as follows:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">deploy</span> <span class="s2">&quot;name&quot;</span> <span class="k">do</span>
  <span class="n">some_attribute</span> <span class="s2">&quot;value&quot;</span> <span class="c1"># see attributes section below</span>
  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
  <span class="n">callback</span> <span class="k">do</span>
    <span class="c1"># callback, including release_path or new_resource</span>
  <span class="k">end</span>
  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
  <span class="n">purge_before_symlink</span>
  <span class="n">create_dirs_before_symlink</span>
  <span class="n">symlink</span>
  <span class="n">action</span> <span class="ss">:action</span> <span class="c1"># see actions section below</span>
<span class="k">end</span>
</pre></div>
</div>
<p>where</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">deploy</span></tt> tells Chef to use either the <tt class="docutils literal"><span class="pre">Chef::Provider::Deploy::Revision</span></tt> or <tt class="docutils literal"><span class="pre">Chef::Provider::Deploy::Timestamped</span></tt> provider during the Chef run. More specific short names&#8212;<tt class="docutils literal"><span class="pre">timestamped_deploy</span></tt>, <tt class="docutils literal"><span class="pre">deploy_revision</span></tt>, or <tt class="docutils literal"><span class="pre">deploy_branch</span></tt>&#8212;can be used instead of the <tt class="docutils literal"><span class="pre">deploy</span></tt> short name.</li>
<li><tt class="docutils literal"><span class="pre">&quot;name&quot;</span></tt> is the path to the location in which the deployment steps will occur</li>
<li><tt class="docutils literal"><span class="pre">attribute</span></tt> is zero (or more) of the attributes that are available for this resource</li>
<li><tt class="docutils literal"><span class="pre">callback</span></tt> represents additional Ruby code that is used to pass a block or to specify a file, and then provide additional information to Chef at specific times during the deployment process</li>
<li><tt class="docutils literal"><span class="pre">purge_before_symlink</span></tt>, <tt class="docutils literal"><span class="pre">create_dirs_before_symlink</span></tt>, and <tt class="docutils literal"><span class="pre">symlink</span></tt> are attributes that are used to link configuration files, remove directories, create directories, or map files and directories during the deployment process</li>
<li><tt class="docutils literal"><span class="pre">:action</span></tt> is the step that the resource will ask the provider to take during the Chef run</li>
</ul>
<p>The following is an example of how the <tt class="docutils literal"><span class="pre">deploy_revision</span></tt> resource can work when used in a recipe. In this example, an application will be deployed to a folder named &#8220;/path/to/application&#8221;:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">deploy_revision</span> <span class="s2">&quot;/path/to/application&quot;</span> <span class="k">do</span>
  <span class="n">repo</span> <span class="s1">&#39;ssh://name-of-git-repo/repos/repo.git&#39;</span>
  <span class="n">migrate</span> <span class="kp">false</span>
  <span class="n">purge_before_symlink</span> <span class="sx">%w{one two folder/three}</span>
  <span class="n">create_dirs_before_symlink</span> <span class="o">[]</span>
  <span class="n">symlinks</span><span class="p">(</span>
    <span class="s2">&quot;one&quot;</span>   <span class="o">=&gt;</span> <span class="s2">&quot;one&quot;</span><span class="p">,</span>
    <span class="s2">&quot;two&quot;</span>   <span class="o">=&gt;</span> <span class="s2">&quot;two&quot;</span><span class="p">,</span>
    <span class="s2">&quot;three&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;folder/three&quot;</span>
  <span class="p">)</span>
  <span class="n">before_restart</span> <span class="k">do</span>
    <span class="c1"># some Ruby code</span>
  <span class="k">end</span>
  <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="s2">&quot;service[foo]&quot;</span>
  <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="s2">&quot;service[bar]&quot;</span>
<span class="k">end</span>
</pre></div>
</div>
<p>For the example shown above:</p>
<ul class="simple">
<li>Because an action is not explicitly specified, Chef will use the default action: <tt class="docutils literal"><span class="pre">:deploy</span></tt></li>
<li>The <tt class="docutils literal"><span class="pre">purge_before_symlink</span></tt> application layout is an array of paths that will be cleared before the <tt class="docutils literal"><span class="pre">symlinks</span></tt> attribute is run</li>
<li>The <tt class="docutils literal"><span class="pre">create_dirs_before_symlink</span></tt> attribute is empty, which is different from the default</li>
<li>The <tt class="docutils literal"><span class="pre">symlinks</span></tt> attribute is creating three symbolic links</li>
<li>The <tt class="docutils literal"><span class="pre">before_restart</span></tt> callback is being used to add custom actions that will occur at the end of the deployment process, but before any services have been notified</li>
<li>At the end, the recipe is using the <tt class="docutils literal"><span class="pre">notifies</span></tt> attribute&#8212;a common attribute available to all resources in Chef&#8212;to alert two services (named &#8220;foo&#8221; and &#8220;bar&#8221;) that they should restart.</li>
</ul>
</div>
<div class="section" id="deploy-strategies">
<h2>Deploy Strategies<a class="headerlink" href="#deploy-strategies" title="Permalink to this headline">¶</a></h2>
<p>In the <tt class="docutils literal"><span class="pre">deploy</span></tt> directory, a sub-directory named <tt class="docutils literal"><span class="pre">shared</span></tt> must be created. This sub-directory is where configuration and temporary files will be kept. A typical Ruby on Rails application will have <tt class="docutils literal"><span class="pre">config</span></tt>, <tt class="docutils literal"><span class="pre">log</span></tt>, <tt class="docutils literal"><span class="pre">pids</span></tt>, and <tt class="docutils literal"><span class="pre">system</span></tt> directories within the <tt class="docutils literal"><span class="pre">shared</span></tt> directory to keep the files stored there independent of the code in the source repository.</p>
<p>In addition to the <tt class="docutils literal"><span class="pre">shared</span></tt> sub-directory, the deploy process will create sub-directories named <tt class="docutils literal"><span class="pre">releases</span></tt> and <tt class="docutils literal"><span class="pre">current</span></tt> (also in the <tt class="docutils literal"><span class="pre">deploy</span></tt> directory). The <tt class="docutils literal"><span class="pre">release</span></tt> directory holds (up to) five most recently deployed versions of an application. The <tt class="docutils literal"><span class="pre">current</span></tt> directory holds the currently-released version.</p>
<p>For example:</p>
<div class="highlight-python"><pre>deploy_directory/
  current/
  releases/
  shared/
    config/
    log/
    pids/
    system/</pre>
</div>
<div class="section" id="deploy-phases">
<h3>Deploy Phases<a class="headerlink" href="#deploy-phases" title="Permalink to this headline">¶</a></h3>
<p>A deployment happens in four phases:</p>
<ol class="arabic simple">
<li><strong>Checkout</strong>&#8212;Chef uses the <strong>scm</strong> resource to get the specified application revision, placing a clone or checkout in the sub-directory of the <tt class="docutils literal"><span class="pre">deploy</span></tt> directory named <tt class="docutils literal"><span class="pre">cached-copy</span></tt>. A copy of the application is then placed in a sub-directory under <tt class="docutils literal"><span class="pre">releases</span></tt>.</li>
<li><strong>Migrate</strong>&#8212;If a migration is to be run, Chef symlinks the database configuration file into the checkout (<tt class="docutils literal"><span class="pre">config/database.yml</span></tt> by default) and runs the migration command. For a Ruby on Rails application, the <tt class="docutils literal"><span class="pre">migration_command</span></tt> is usually set to <tt class="docutils literal"><span class="pre">rake</span> <span class="pre">db:migrate</span></tt>.</li>
<li><strong>Symlink</strong>&#8212;Directories for shared and temporary files are removed from the checkout (<tt class="docutils literal"><span class="pre">log</span></tt>, <tt class="docutils literal"><span class="pre">tmp/pids</span></tt>, and <tt class="docutils literal"><span class="pre">public/system</span></tt> by default). After this step, any needed directories (<tt class="docutils literal"><span class="pre">tmp</span></tt>, <tt class="docutils literal"><span class="pre">public</span></tt>, and <tt class="docutils literal"><span class="pre">config</span></tt> by default) are created if they don&#8217;t already exist. This step is completed by symlinking shared directories into the current <tt class="docutils literal"><span class="pre">release</span></tt>, <tt class="docutils literal"><span class="pre">public/system</span></tt>, <tt class="docutils literal"><span class="pre">tmp/pids</span></tt>, and <tt class="docutils literal"><span class="pre">log</span></tt> directories, and then symlinking the <tt class="docutils literal"><span class="pre">release</span></tt> directory to <tt class="docutils literal"><span class="pre">current</span></tt>.</li>
<li><strong>Restart</strong>&#8212;The application is restarted according to the restart command set in the recipe.</li>
</ol>
<div class="section" id="deploy-cache-file">
<h4>Deploy Cache File<a class="headerlink" href="#deploy-cache-file" title="Permalink to this headline">¶</a></h4>
<p>Chef uses a cache file to keep track of the order in which each revision of an application is deployed. If a re-deployment must be forced&#8212;by deleting the deployed code from a node, for example&#8212;the cache file must be deleted as well. The cache file is located in the default configuration at /var/chef/cache/revision-deploys/APPNAME/.</p>
</div>
</div>
<div class="section" id="callbacks">
<h3>Callbacks<a class="headerlink" href="#callbacks" title="Permalink to this headline">¶</a></h3>
<p>In-between each step in a deployment process, callbacks can be run using arbitrary Ruby code, including recipes. All callbacks support embedded recipes given in a block, but each callback assumes a shell command (instead of a deploy hook filename) when given a string.</p>
<p>The following callback types are available:</p>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Callback</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">after_restart</span></tt></td>
<td>A block of code or a path to a file that contains code that is run after restarting. Default value: <tt class="docutils literal"><span class="pre">deploy/after_restart.rb</span></tt>.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">before_migrate</span></tt></td>
<td>A block of code or a path to a file that contains Chef code that is run before a migration. Default value: <tt class="docutils literal"><span class="pre">deploy/before_migrate.rb</span></tt>.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">before_restart</span></tt></td>
<td>A block of code or a path to a file that contains Chef code that is run before restarting. Default value: <tt class="docutils literal"><span class="pre">deploy/before_restart.rb</span></tt>.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">before_symlink</span></tt></td>
<td>A block of code or a path to a file that contains Chef code that is run before symbolic linking. Default value: <tt class="docutils literal"><span class="pre">deploy/before_symlink.rb</span></tt>.</td>
</tr>
</tbody>
</table>
<p>Each of these callback types can be used in one of three ways:</p>
<ul class="simple">
<li>To pass a block of code, such as Ruby or Python</li>
<li>To specify a file</li>
<li>To do neither; Chef will look for a callback file named after one of the callback types (<tt class="docutils literal"><span class="pre">before_migrate.rb</span></tt>, for example) and if the file exists, to evaluate it as if it were a specified file</li>
</ul>
<p>Within a callback, there are two ways to get access to information about the deployment:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">release_path</span></tt> can be used to get the path to the current release</li>
<li><tt class="docutils literal"><span class="pre">new_resource</span></tt> can be used to access the deploy resource, including environment variables that have been set there (using <tt class="docutils literal"><span class="pre">new_resource</span></tt> is a preferred approach over using the <tt class="docutils literal"><span class="pre">&#64;configuration</span></tt> variable)</li>
</ul>
<p>Both of these options must be available at the top-level within the callback, along with any assigned values that will be used later in the callback.</p>
<p><strong>Callbacks and Capistrano</strong></p>
<p>If you are familiar with Capistrano, the following examples should help you know when to use the various callbacks that are available in Chef. If you are not familiar with Capistrano, then follow the semantic names of these callbacks to help you determine when to use each of the callbacks within a recipe that is built with the <strong>deploy</strong> resource.</p>
<p>The following example shows where callbacks in Chef fit in relation to the steps taken by the <tt class="docutils literal"><span class="pre">deploy</span></tt> process in Capistrano:</p>
<img alt="_images/includes_resource_deploy_strategy_callbacks_example1.png" src="_images/includes_resource_deploy_strategy_callbacks_example1.png" />
<p>and the following example shows the same comparison, but with the <tt class="docutils literal"><span class="pre">deploy:migrations</span></tt> process:</p>
<img alt="_images/includes_resource_deploy_strategy_callbacks_example2.png" src="_images/includes_resource_deploy_strategy_callbacks_example2.png" />
</div>
<div class="section" id="layout-modifiers">
<h3>Layout Modifiers<a class="headerlink" href="#layout-modifiers" title="Permalink to this headline">¶</a></h3>
<p>The <strong>deploy</strong> resource expects an application to be structured like a Ruby on Rails application, but the layout can be modified to meet custom requirements as needed. Use the following attributes within a recipe to modify the layout of a recipe that is using the <strong>deploy</strong> resource:</p>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Layout Modifiers</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">create_dirs_before_symlink</span></tt></td>
<td>Use this attribute to create directories before symbolic links are created. This attribute runs after <tt class="docutils literal"><span class="pre">purge_before_symlink</span></tt> and before <tt class="docutils literal"><span class="pre">symlink</span></tt>. Default value: <tt class="docutils literal"><span class="pre">%w{tmp</span> <span class="pre">public</span> <span class="pre">config}</span></tt> (or the same as <tt class="docutils literal"><span class="pre">[&quot;tmp&quot;,</span> <span class="pre">&quot;public&quot;,</span> <span class="pre">&quot;config&quot;]</span></tt>).</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">purge_before_symlink</span></tt></td>
<td>Use this attribute to specify an array of directories (relative to the application root) that should be removed from a checkout before symbolic links are created. This attribute runs before <tt class="docutils literal"><span class="pre">create_dirs_before_symlink</span></tt> and before <tt class="docutils literal"><span class="pre">symlink</span></tt>. Default value: <tt class="docutils literal"><span class="pre">%w{log</span> <span class="pre">tmp/pids</span> <span class="pre">public/system}</span></tt> (or the same as <tt class="docutils literal"><span class="pre">[&quot;log&quot;,</span> <span class="pre">&quot;tmp/pids&quot;,</span> <span class="pre">&quot;public/system&quot;]</span></tt>.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">symlink_before_migrate</span></tt></td>
<td>Use this attribute to map files in a shared directory to the current release directory. The symbolic links for these files will be created before any migration is run. Use <tt class="docutils literal"><span class="pre">symlink_before_migrate({})</span></tt> or <tt class="docutils literal"><span class="pre">symlink_before_migrate</span> <span class="pre">nil</span></tt> instead of <tt class="docutils literal"><span class="pre">symlink_before_migrate</span> <span class="pre">{}</span></tt> because <tt class="docutils literal"><span class="pre">{}</span></tt> will be interpreted as a block rather than an empty hash. Default value: <tt class="docutils literal"><span class="pre">{&quot;config/database.yml&quot;</span> <span class="pre">=&gt;</span> <span class="pre">&quot;config/database.yml&quot;}</span></tt>.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">symlinks</span></tt></td>
<td>Use this attribute to map files in a shared directory to their paths in the current release directory. This attribute runs after <tt class="docutils literal"><span class="pre">create_dirs_before_symlink</span></tt> and <tt class="docutils literal"><span class="pre">purge_before_symlink</span></tt>. Default value: <tt class="docutils literal"><span class="pre">{&quot;system&quot;</span> <span class="pre">=&gt;</span> <span class="pre">&quot;public/system&quot;,</span> <span class="pre">&quot;pids&quot;</span> <span class="pre">=&gt;</span> <span class="pre">&quot;tmp/pids&quot;,</span> <span class="pre">&quot;log&quot;</span> <span class="pre">=&gt;</span> <span class="pre">&quot;log&quot;}</span></tt>.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="actions">
<h2>Actions<a class="headerlink" href="#actions" title="Permalink to this headline">¶</a></h2>
<p>This resource has the following actions:</p>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Action</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">:deploy</span></tt></td>
<td>Default. Use to deploy an application.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">:force_deploy</span></tt></td>
<td>Use to remove any existing release of the same code version and re-deploy a new one in its place.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">:rollback</span></tt></td>
<td>Use to roll an application back to the previous release.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="attributes">
<h2>Attributes<a class="headerlink" href="#attributes" title="Permalink to this headline">¶</a></h2>
<p>This resource has the following attributes:</p>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Attribute</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">after_restart</span></tt></td>
<td>A block of code or a path to a file that contains code that is run after restarting. Default value: <tt class="docutils literal"><span class="pre">deploy/after_restart.rb</span></tt>.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">before_migrate</span></tt></td>
<td>A block of code or a path to a file that contains Chef code that is run before a migration. Default value: <tt class="docutils literal"><span class="pre">deploy/before_migrate.rb</span></tt>.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">before_restart</span></tt></td>
<td>A block of code or a path to a file that contains Chef code that is run before restarting. Default value: <tt class="docutils literal"><span class="pre">deploy/before_restart.rb</span></tt>.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">before_symlink</span></tt></td>
<td>A block of code or a path to a file that contains Chef code that is run before symbolic linking. Default value: <tt class="docutils literal"><span class="pre">deploy/before_symlink.rb</span></tt>.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">branch</span></tt></td>
<td>The alias for the revision.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">create_dirs_before_symlink</span></tt></td>
<td>Use this attribute to create directories before symbolic links are created. This attribute runs after <tt class="docutils literal"><span class="pre">purge_before_symlink</span></tt> and before <tt class="docutils literal"><span class="pre">symlink</span></tt>. Default value: <tt class="docutils literal"><span class="pre">%w{tmp</span> <span class="pre">public</span> <span class="pre">config}</span></tt> (or the same as <tt class="docutils literal"><span class="pre">[&quot;tmp&quot;,</span> <span class="pre">&quot;public&quot;,</span> <span class="pre">&quot;config&quot;]</span></tt>).</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">deploy_to</span></tt></td>
<td>The &#8220;meta root&#8221; for the application, if different from the path that is used to specify the name of a resource.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">environment</span></tt></td>
<td>A hash of environment variables: <tt class="docutils literal"><span class="pre">{&quot;ENV_VARIABLE&quot;=&gt;&quot;VALUE&quot;}</span></tt>. (These environment variables must exist for a command to execute successfully.)</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">group</span></tt></td>
<td>The system group that is responsible for the checked-out code. Default value: <tt class="docutils literal"><span class="pre">nil</span></tt>.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">keep_releases</span></tt></td>
<td>The number of releases for which a backup is kept. Default value: <tt class="docutils literal"><span class="pre">5</span></tt>.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">migrate</span></tt></td>
<td>Indicates that the migration command will be run. Default value: <tt class="docutils literal"><span class="pre">false</span></tt>.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">migration_command</span></tt></td>
<td>A string that contains a shell command that can be executed to run a migration operation.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">provider</span></tt></td>
<td>Optional. Use to specify a provider by using its long name. For example: <tt class="docutils literal"><span class="pre">provider</span> <span class="pre">Chef::Provider::Long::Name</span></tt>. See the Providers section below for the list of providers available to this resource.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">purge_before_symlink</span></tt></td>
<td>Use this attribute to specify an array of directories (relative to the application root) that should be removed from a checkout before symbolic links are created. This attribute runs before <tt class="docutils literal"><span class="pre">create_dirs_before_symlink</span></tt> and before <tt class="docutils literal"><span class="pre">symlink</span></tt>. Default value: <tt class="docutils literal"><span class="pre">%w{log</span> <span class="pre">tmp/pids</span> <span class="pre">public/system}</span></tt> (or the same as <tt class="docutils literal"><span class="pre">[&quot;log&quot;,</span> <span class="pre">&quot;tmp/pids&quot;,</span> <span class="pre">&quot;public/system&quot;]</span></tt>.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">repo</span></tt></td>
<td>The alias for the repository.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">repository</span></tt></td>
<td>The URI for the repository.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">repository_cache</span></tt></td>
<td>The name of the sub-directory in which the pristine copy of an application&#8217;s source is kept. Default value: <tt class="docutils literal"><span class="pre">cached-copy</span></tt>.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">restart_command</span></tt></td>
<td>A string that contains a shell command that can be executed to run a restart operation. Default value: <tt class="docutils literal"><span class="pre">nil</span></tt>.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">revision</span></tt></td>
<td>The revision to be checked out. This can be symbolic, like <tt class="docutils literal"><span class="pre">HEAD</span></tt> or it can be a source control management-specific revision identifier. Default value: <tt class="docutils literal"><span class="pre">HEAD</span></tt>.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">rollback_on_error</span></tt></td>
<td>Indicates whether a deploy resource will rollback to a previously-deployed release if an error occurs when deploying a new release. Default value: <tt class="docutils literal"><span class="pre">false</span></tt>.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">scm_provider</span></tt></td>
<td>The name of the source control management provider to be used. Default value: <tt class="docutils literal"><span class="pre">Chef::Provider::Git</span></tt>. Optional values: <tt class="docutils literal"><span class="pre">Chef::Provider::Subversion</span></tt>.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">symlinks</span></tt></td>
<td>Use this attribute to map files in a shared directory to their paths in the current release directory. This attribute runs after <tt class="docutils literal"><span class="pre">create_dirs_before_symlink</span></tt> and <tt class="docutils literal"><span class="pre">purge_before_symlink</span></tt>. Default value: <tt class="docutils literal"><span class="pre">{&quot;system&quot;</span> <span class="pre">=&gt;</span> <span class="pre">&quot;public/system&quot;,</span> <span class="pre">&quot;pids&quot;</span> <span class="pre">=&gt;</span> <span class="pre">&quot;tmp/pids&quot;,</span> <span class="pre">&quot;log&quot;</span> <span class="pre">=&gt;</span> <span class="pre">&quot;log&quot;}</span></tt>.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">symlink_before_migrate</span></tt></td>
<td>Use this attribute to map files in a shared directory to the current release directory. The symbolic links for these files will be created before any migration is run. Use <tt class="docutils literal"><span class="pre">symlink_before_migrate({})</span></tt> or <tt class="docutils literal"><span class="pre">symlink_before_migrate</span> <span class="pre">nil</span></tt> instead of <tt class="docutils literal"><span class="pre">symlink_before_migrate</span> <span class="pre">{}</span></tt> because <tt class="docutils literal"><span class="pre">{}</span></tt> will be interpreted as a block rather than an empty hash. Default value: <tt class="docutils literal"><span class="pre">{&quot;config/database.yml&quot;</span> <span class="pre">=&gt;</span> <span class="pre">&quot;config/database.yml&quot;}</span></tt>.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">user</span></tt></td>
<td>The system user that is responsible for the checked-out code. Default value: <tt class="docutils literal"><span class="pre">nil</span></tt>.</td>
</tr>
</tbody>
</table>
<p>The following attributes are for use with git only:</p>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Attribute</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">enable_submodules</span></tt></td>
<td>Use to perform a sub-module initialization and update. Default value: <tt class="docutils literal"><span class="pre">false</span></tt>.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">git_ssh_wrapper</span></tt></td>
<td>The alias for the <tt class="docutils literal"><span class="pre">ssh_wrapper</span></tt>.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">remote</span></tt></td>
<td>The remote repository to be used when synchronizing an existing clone. Default value: <tt class="docutils literal"><span class="pre">origin</span></tt>.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">shallow_clone</span></tt></td>
<td>Indicates that the clone depth is set to 5. Default value: <tt class="docutils literal"><span class="pre">true</span></tt>.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">ssh_wrapper</span></tt></td>
<td>The path to the wrapper script used when running SSH with git. The <tt class="docutils literal"><span class="pre">GIT_SSH</span></tt> environment variable is set to this.</td>
</tr>
</tbody>
</table>
<p>The following attributes are for use with Subversion only:</p>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Attribute</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">svn_arguments</span></tt></td>
<td>The extra arguments that are passed to the Subversion command.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">svn_password</span></tt></td>
<td>The password for the user that has access to the Subversion repository.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">svn_username</span></tt></td>
<td>The user name for a user that has access to the Subversion repository.</td>
</tr>
</tbody>
</table>
<p>For example:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">deploy</span> <span class="s2">&quot;/my/deploy/dir&quot;</span> <span class="k">do</span>
  <span class="n">repo</span> <span class="s2">&quot;git@github.com/whoami/project&quot;</span>
  <span class="n">revision</span> <span class="s2">&quot;abc123&quot;</span> <span class="c1"># or &quot;HEAD&quot; or &quot;TAG_for_1.0&quot; or (subversion) &quot;1234&quot;</span>
  <span class="n">user</span> <span class="s2">&quot;deploy_ninja&quot;</span>
  <span class="n">enable_submodules</span> <span class="kp">true</span>
  <span class="n">migrate</span> <span class="kp">true</span>
  <span class="n">migration_command</span> <span class="s2">&quot;rake db:migrate&quot;</span>
  <span class="n">environment</span> <span class="s2">&quot;RAILS_ENV&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;production&quot;</span><span class="p">,</span> <span class="s2">&quot;OTHER_ENV&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;foo&quot;</span>
  <span class="n">shallow_clone</span> <span class="kp">true</span>
  <span class="n">keep_releases</span> <span class="mi">10</span>
  <span class="n">action</span> <span class="ss">:deploy</span> <span class="c1"># or :rollback</span>
  <span class="n">restart_command</span> <span class="s2">&quot;touch tmp/restart.txt&quot;</span>
  <span class="n">git_ssh_wrapper</span> <span class="s2">&quot;wrap-ssh4git.sh&quot;</span>
  <span class="n">scm_provider</span> <span class="no">Chef</span><span class="o">::</span><span class="no">Provider</span><span class="o">::</span><span class="no">Git</span> <span class="c1"># is the default, for svn: Chef::Provider::Subversion</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="providers">
<h2>Providers<a class="headerlink" href="#providers" title="Permalink to this headline">¶</a></h2>
<p>The <strong>deploy</strong> resource providers are used to determine whether to deploy based on whether the release directory in which the deployment is to be made actually exists. The following providers are available. Use the short name to call the provider from a recipe:</p>
<table border="1" class="docutils">
<colgroup>
<col width="27%" />
<col width="15%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Long name</th>
<th class="head">Short name</th>
<th class="head">Notes</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">Chef::Provider::Deploy</span></tt></td>
<td><tt class="docutils literal"><span class="pre">deploy</span></tt></td>
<td>When this short name is used, Chef will determine the correct provider during the Chef run.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">Chef::Provider::Deploy::Revision</span></tt></td>
<td><tt class="docutils literal"><span class="pre">deploy_branch</span></tt></td>
<td>See below for more information.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">Chef::Provider::Deploy::Revision</span></tt></td>
<td><tt class="docutils literal"><span class="pre">deploy_revision</span></tt></td>
<td>See below for more information.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">Chef::Provider::Deploy::TimestampedDeploy</span></tt></td>
<td><tt class="docutils literal"><span class="pre">timestamped_deploy</span></tt></td>
<td>The default provider for all platforms. See below for more information.</td>
</tr>
</tbody>
</table>
<div class="section" id="deploy-branch">
<h3>deploy_branch<a class="headerlink" href="#deploy-branch" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">deploy_branch</span></tt> resource is used in the same way as the <tt class="docutils literal"><span class="pre">deploy_resource</span></tt> resource. It uses the <tt class="docutils literal"><span class="pre">Deploy::Revision</span></tt> provider and has uses the same set of actions and attributes.</p>
</div>
<div class="section" id="deploy-revision">
<h3>deploy_revision<a class="headerlink" href="#deploy-revision" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">deploy_revision</span></tt> provider is the recommended provider, even if it is not listed as the default. The <tt class="docutils literal"><span class="pre">deploy_revision</span></tt> provider is used to ensure that the name of a release sub-directory is based on a revision identifier. For users of git, this will be the familiar SHA checksum. For users of Subversion, it will be the integer revision number. If a name other than a revision identifier is provided&#8212;branch names, tags, and so on&#8212;Chef will ignore the alternate names and will look up the revision identifier and use it to name the release sub-directory. When the <tt class="docutils literal"><span class="pre">deploy_revision</span></tt> provider is given an exact revision to deploy, it will behave in an idempotent manner.</p>
<p>The <tt class="docutils literal"><span class="pre">deploy_revision</span></tt> provider results in deployed components under the destination location that is owned by the user who runs the application. This is sometimes an issue for certain workflows. If issues arise, consider the following:</p>
<ul class="simple">
<li>Incorporate changing permissions to the desired end state from within a recipe</li>
<li>Add a <tt class="docutils literal"><span class="pre">before_restart</span></tt> block to fix up the permissions</li>
<li>Have an unprivileged user (for example: <tt class="docutils literal"><span class="pre">opscode</span></tt>) be the owner of the <tt class="docutils literal"><span class="pre">deploy</span></tt> directory and another unprivileged user (for example: <tt class="docutils literal"><span class="pre">opscodeapp</span></tt>) run the application. Most often, this is the solution that works best</li>
</ul>
<p>When using the <tt class="docutils literal"><span class="pre">deploy_revision</span></tt> provider, and when the deploy fails for any reason, and when the same code is used to re-deploy, the action should be set manually to <tt class="docutils literal"><span class="pre">:force_deploy</span></tt>. Forcing the re-deploy will remove the old release directory, after which the deploy can proceed as usual. (Forcing a re-deploy over the current release can cause some downtime.) Deployed revisions are stored in <tt class="docutils literal"><span class="pre">(file_cache_path)/revision-deploys/(deploy_path)</span></tt>.</p>
</div>
<div class="section" id="timestamped-deploy">
<h3>timestamped_deploy<a class="headerlink" href="#timestamped-deploy" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">timestamped_deploy</span></tt> provider is the default <strong>deploy</strong> provider. It is used to name release directories with a timestamp in the form of <tt class="docutils literal"><span class="pre">YYYYMMDDHHMMSS</span></tt>. For example: <tt class="docutils literal"><span class="pre">/my/deploy/dir/releases/20121120162342</span></tt>. The <strong>deploy</strong> resource will determine whether or not to deploy code based on the existence of the release directory in which it is attempting to deploy. Because the timestamp is different for every Chef run, the <tt class="docutils literal"><span class="pre">timestamped_deploy</span></tt> provider is not idempotent. When the <tt class="docutils literal"><span class="pre">timestamped_deploy</span></tt> provider is used, it requires that the action setting on a resource be managed manually in order to prevent unintended continuous deployment.</p>
</div>
</div>
<div class="section" id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<p>The following examples demonstrate various approaches for using resources in recipes. If you want to see examples of how Opscode uses resources in recipes, take a closer look at the cookbooks that Opscode authors and maintains: <a class="reference external" href="https://github.com/opscode-cookbooks">https://github.com/opscode-cookbooks</a>.</p>
<p><strong>Modify the layout of a Ruby on Rails application</strong></p>
<p>The layout of the application matches a Rails app by default, but you can customize it to fit your needs. To customize the application layout:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">deploy</span> <span class="s2">&quot;/my/apps/dir/deploy&quot;</span> <span class="k">do</span>
  <span class="c1"># Use a local repo if you prefer</span>
  <span class="n">repo</span> <span class="s2">&quot;/path/to/gitrepo/typo/&quot;</span>
  <span class="n">environment</span> <span class="s2">&quot;RAILS_ENV&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;production&quot;</span>
  <span class="n">revision</span> <span class="s2">&quot;HEAD&quot;</span>
  <span class="n">action</span> <span class="ss">:deploy</span>
  <span class="n">migration_command</span> <span class="s2">&quot;rake db:migrate --trace&quot;</span>
  <span class="n">migrate</span> <span class="kp">true</span>
  <span class="n">restart_command</span> <span class="s2">&quot;touch tmp/restart.txt&quot;</span>
  <span class="n">create_dirs_before_symlink</span>  <span class="sx">%w{tmp public config deploy}</span>

  <span class="c1"># You can use this to customize if your app has extra configuration files</span>
  <span class="c1"># such as amqp.yml or app_config.yml</span>
  <span class="n">symlink_before_migrate</span>  <span class="s2">&quot;config/database.yml&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;config/database.yml&quot;</span>

  <span class="c1"># If your app has extra files in the shared folder, specify them here</span>
  <span class="n">symlinks</span>  <span class="s2">&quot;system&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;public/system&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pids&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;tmp/pids&quot;</span><span class="p">,</span>
            <span class="s2">&quot;log&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span>
            <span class="s2">&quot;deploy/before_migrate.rb&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;deploy/before_migrate.rb&quot;</span><span class="p">,</span>
            <span class="s2">&quot;deploy/before_symlink.rb&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;deploy/before_symlink.rb&quot;</span><span class="p">,</span>
            <span class="s2">&quot;deploy/before_restart.rb&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;deploy/before_restart.rb&quot;</span><span class="p">,</span>
            <span class="s2">&quot;deploy/after_restart.rb&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;deploy/after_restart.rb&quot;</span>
<span class="k">end</span>
</pre></div>
</div>
<p><strong>Use resources within callbacks</strong></p>
<p>Using resources from within your callbacks as blocks or within callback files distributed with your application&#8217;s source code. To use embedded recipes for callbacks:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">deploy</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;tmpdir&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">/deploy&quot;</span> <span class="k">do</span>
  <span class="n">repo</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;tmpdir&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">/gitrepo/typo/&quot;</span>
  <span class="n">environment</span> <span class="s2">&quot;RAILS_ENV&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;production&quot;</span>
  <span class="n">revision</span> <span class="s2">&quot;HEAD&quot;</span>
  <span class="n">action</span> <span class="ss">:deploy</span>
  <span class="n">migration_command</span> <span class="s2">&quot;rake db:migrate --trace&quot;</span>
  <span class="n">migrate</span> <span class="kp">true</span>

  <span class="c1"># Callback awesomeness:</span>
  <span class="n">before_migrate</span> <span class="k">do</span>
    <span class="n">current_release</span> <span class="o">=</span> <span class="n">release_path</span>

    <span class="n">directory</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">current_release</span><span class="si">}</span><span class="s2">/deploy&quot;</span> <span class="k">do</span>
      <span class="n">mode</span> <span class="mo">00755</span>
    <span class="k">end</span>

    <span class="c1"># creates a callback for before_symlink</span>
    <span class="n">template</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">current_release</span><span class="si">}</span><span class="s2">/deploy/before_symlink_callback.rb&quot;</span> <span class="k">do</span>
      <span class="n">source</span> <span class="s2">&quot;embedded_recipe_before_symlink.rb.erb&quot;</span>
      <span class="n">mode</span> <span class="mo">00644</span>
    <span class="k">end</span>

  <span class="k">end</span>

  <span class="c1"># This file can contain Chef recipe code, plain ruby also works</span>
  <span class="n">before_symlink</span> <span class="s2">&quot;deploy/before_symlink_callback.rb&quot;</span>

  <span class="n">restart</span> <span class="k">do</span>
    <span class="n">current_release</span> <span class="o">=</span> <span class="n">release_path</span>
    <span class="n">file</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">release_path</span><span class="si">}</span><span class="s2">/tmp/restart.txt&quot;</span> <span class="k">do</span>
      <span class="n">mode</span> <span class="mo">00644</span>
    <span class="k">end</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>
</div>
<p><strong>Deploy from a private git repository without using the application cookbook</strong></p>
<p>To deploy from a private git repository without using the application cookbook, first ensure that:</p>
<ul class="simple">
<li>the private key does not have a passphrase, as this will pause a Chef run to wait for input</li>
<li>an SSH wrapper is being used</li>
<li>a private key has been added to the node</li>
</ul>
<p>and then use code like the following to remove a passphrase from a private key:</p>
<div class="highlight-bash"><div class="highlight"><pre>ssh-keygen -p -P <span class="s1">&#39;YOURPASSPHRASE&#39;</span> -N <span class="s1">&#39;&#39;</span> -f id_deploy
</pre></div>
</div>
<p><strong>Use an SSH wrapper</strong></p>
<p>To write a recipe that uses an SSH wrapper:</p>
<ol class="arabic">
<li><p class="first">Create a file in the <tt class="docutils literal"><span class="pre">cookbooks/COOKBOOK_NAME/files/default</span></tt> directory that is named <tt class="docutils literal"><span class="pre">wrap-ssh4git.sh</span></tt> and which contains the following:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="c1">#!/usr/bin/env bash</span>
<span class="sr">/usr/</span><span class="n">bin</span><span class="o">/</span><span class="n">env</span> <span class="n">ssh</span> <span class="o">-</span><span class="n">o</span> <span class="s2">&quot;StrictHostKeyChecking=no&quot;</span> <span class="o">-</span><span class="n">i</span> <span class="s2">&quot;/tmp/private_code/.ssh/id_deploy&quot;</span> <span class="vg">$1</span> <span class="vg">$2</span>
</pre></div>
</div>
</li>
<li><p class="first">Set up the cookbook file.</p>
</li>
<li><p class="first">Add a recipe to the cookbook file similar to the following:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">directory</span> <span class="s2">&quot;/tmp/private_code/.ssh&quot;</span> <span class="k">do</span>
  <span class="n">owner</span> <span class="s2">&quot;ubuntu&quot;</span>
  <span class="n">recursive</span> <span class="kp">true</span>
<span class="k">end</span>

<span class="n">cookbook_file</span> <span class="s2">&quot;/tmp/private_code/wrap-ssh4git.sh&quot;</span> <span class="k">do</span>
  <span class="n">source</span> <span class="s2">&quot;wrap-ssh4git.sh&quot;</span>
  <span class="n">owner</span> <span class="s2">&quot;ubuntu&quot;</span>
  <span class="n">mode</span> <span class="mo">00700</span>
<span class="k">end</span>

<span class="n">deploy</span> <span class="s2">&quot;private_repo&quot;</span> <span class="k">do</span>
  <span class="n">repo</span> <span class="s2">&quot;git@github.com:acctname/private-repo.git&quot;</span>
  <span class="n">user</span> <span class="s2">&quot;ubuntu&quot;</span>
  <span class="n">deploy_to</span> <span class="s2">&quot;/tmp/private_code&quot;</span>
  <span class="n">action</span> <span class="ss">:deploy</span>
  <span class="n">ssh_wrapper</span> <span class="s2">&quot;/tmp/private_code/wrap-ssh4git.sh&quot;</span>
<span class="k">end</span>
</pre></div>
</div>
<p>This will deploy the git repository at <tt class="docutils literal"><span class="pre">git&#64;github.com:acctname/private-repo.git</span></tt> in the <tt class="docutils literal"><span class="pre">/tmp/private_code</span></tt> directory.</p>
</li>
</ol>
<p><strong>Use a callback to include a file that will be passed as a code block</strong></p>
<p>The code in a file that is included in a recipe using a callback is evaluated exactly as if the code had been put in the recipe as a block. Files are searched relative to the current release.</p>
<p>To specify a file that contains code to be used as a block:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">deploy</span> <span class="s2">&quot;/deploy/dir/&quot;</span> <span class="k">do</span>
  <span class="c1"># ...</span>

  <span class="n">before_migrate</span> <span class="s2">&quot;callbacks/do_this_before_migrate.rb&quot;</span>
<span class="k">end</span>
</pre></div>
</div>
<p><strong>Use a callback to pass a code block</strong></p>
<p>To pass a block of Python code before a migration is run:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">deploy_revision</span> <span class="s2">&quot;/deploy/dir/&quot;</span> <span class="k">do</span>
  <span class="c1"># other attributes</span>
  <span class="c1"># ...</span>

  <span class="n">before_migrate</span> <span class="k">do</span>
    <span class="c1"># release_path is the path to the timestamp dir</span>
    <span class="c1"># for the current release</span>
    <span class="n">current_release</span> <span class="o">=</span> <span class="n">release_path</span>

    <span class="c1"># Create a local variable for the node so we&#39;ll have access to</span>
    <span class="c1"># the attributes</span>
    <span class="n">deploy_node</span> <span class="o">=</span> <span class="n">node</span>

    <span class="c1"># A local variable with the deploy resource.</span>
    <span class="n">deploy_resource</span> <span class="o">=</span> <span class="n">new_resource</span>

    <span class="n">python</span> <span class="k">do</span>
      <span class="n">cwd</span> <span class="n">current_release</span>
      <span class="n">user</span> <span class="s2">&quot;myappuser&quot;</span>
      <span class="n">code</span><span class="o">&lt;&lt;-</span><span class="no">PYCODE</span>
        <span class="c1"># Woah, callbacks in python!</span>
        <span class="c1"># ...</span>
        <span class="c1"># current_release, deploy_node, and deploy_resource are all available</span>
        <span class="c1"># within the deploy hook now.</span>
      <span class="no">PYCODE</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p><strong>Use the same API for all recipes using the same gem</strong></p>
<p>Any recipes using the <tt class="docutils literal"><span class="pre">git-deploy</span></tt> gem can continue using the same API. To include this behavior in a recipe, do something like the following:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">deploy</span> <span class="s2">&quot;/srv/</span><span class="si">#{</span><span class="n">appname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
  <span class="n">repo</span> <span class="s2">&quot;git://github.com/radiant/radiant.git&quot;</span>
  <span class="n">revision</span> <span class="s2">&quot;HEAD&quot;</span>
  <span class="n">user</span> <span class="s2">&quot;railsdev&quot;</span>
  <span class="n">enable_submodules</span> <span class="kp">false</span>
  <span class="n">migrate</span> <span class="kp">true</span>
  <span class="n">migration_command</span> <span class="s2">&quot;rake db:migrate&quot;</span>
  <span class="c1"># Giving a string for environment sets RAILS_ENV, MERB_ENV, RACK_ENV</span>
  <span class="n">environment</span> <span class="s2">&quot;production&quot;</span>
  <span class="n">shallow_clone</span> <span class="kp">true</span>
  <span class="n">action</span> <span class="ss">:deploy</span>
  <span class="n">restart_command</span> <span class="s2">&quot;touch tmp/restart.txt&quot;</span>
<span class="k">end</span>
</pre></div>
</div>
<p><strong>Deploy without creating symbolic links to a shared folder</strong></p>
<p>To deploy without creating symbolic links to a shared folder:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">deploy</span> <span class="s2">&quot;/my/apps/dir/deploy&quot;</span> <span class="k">do</span>
  <span class="n">symlinks</span> <span class="p">{}</span>
<span class="k">end</span>
</pre></div>
</div>
<p>When deploying code that is not Ruby on Rails and symbolic links to a shared folder are not wanted, use parentheses () or <tt class="docutils literal"><span class="pre">Hash.new</span></tt> to avoid ambiguity. For example, using parentheses:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">deploy</span> <span class="s2">&quot;/my/apps/dir/deploy&quot;</span> <span class="k">do</span>
  <span class="n">symlinks</span><span class="p">({})</span>
<span class="k">end</span>
</pre></div>
</div>
<p>or using <tt class="docutils literal"><span class="pre">Hash.new</span></tt>:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">deploy</span> <span class="s2">&quot;/my/apps/dir/deploy&quot;</span> <span class="k">do</span>
  <span class="n">symlinks</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span>
<span class="k">end</span>
</pre></div>
</div>
<p><strong>Clear a layout modifier attribute</strong></p>
<p>Using the default attribute values that Chef provides is the recommended baseline when working with recipes. Then, depending on what each node requires, these default values can be overridden with node-, role-, environment-, and cookbook-specific values. The <strong>deploy</strong> resource has four layout modifiers: <tt class="docutils literal"><span class="pre">create_dirs_before_symlink</span></tt>, <tt class="docutils literal"><span class="pre">purge_before_symlink</span></tt>, <tt class="docutils literal"><span class="pre">symlink_before_migrate</span></tt>, and <tt class="docutils literal"><span class="pre">symlinks</span></tt>. These are Ruby hashes that behave as attributes of the <strong>deploy</strong> resource. When these layout modifiers are used in a recipe, they appear similar to the following:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">deploy</span> <span class="s2">&quot;name&quot;</span> <span class="k">do</span>
  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
  <span class="n">symlink_before_migrate</span>       <span class="p">{</span><span class="s2">&quot;config/database.yml&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;config/database.yml&quot;</span><span class="p">}</span>
  <span class="n">create_dirs_before_symlink</span>   <span class="sx">%w{tmp public config}</span>
  <span class="n">purge_before_symlink</span>         <span class="sx">%w{log tmp/pids public/system}</span>
  <span class="n">symlinks</span>                     <span class="p">{</span> <span class="s2">&quot;system&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;public/system&quot;</span><span class="p">,</span>
                                 <span class="s2">&quot;pids&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;tmp/pids&quot;</span><span class="p">,</span>
                                 <span class="s2">&quot;log&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;log&quot;</span>
                               <span class="p">}</span>
  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>
<p>and then what these layout modifiers look like if they were empty:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">deploy</span> <span class="s2">&quot;name&quot;</span> <span class="k">do</span>
  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
  <span class="n">symlink_before_migrate</span>       <span class="kp">nil</span>
  <span class="n">create_dirs_before_symlink</span>   <span class="o">[]</span>
  <span class="n">purge_before_symlink</span>         <span class="o">[]</span>
  <span class="n">symlinks</span>                     <span class="kp">nil</span>
  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>
<p>In most cases, using the empty values for the layout modifiers will prevent Chef from passing symbolic linking information to a node during the Chef run. However, in some cases, it may be preferable to ensure that one (or more) of these layout modifiers do not pass any symbolic linking information to a node during the Chef run at all. Because each of these layout modifiers are a hash, the <tt class="docutils literal"><span class="pre">clear</span></tt> instance method can be used to clear out these values.</p>
<p>To clear the default values for a layout modifier:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">deploy</span> <span class="s2">&quot;name&quot;</span> <span class="k">do</span>
  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
  <span class="n">symlink_before_migrate</span><span class="o">.</span><span class="n">clear</span>
  <span class="n">create_dirs_before_symlink</span><span class="o">.</span><span class="n">clear</span>
  <span class="n">purge_before_symlink</span><span class="o">.</span><span class="n">clear</span>
  <span class="n">symlinks</span><span class="o">.</span><span class="n">clear</span>
  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>
<p>In general, use this approach carefully and only after it is determined that nil or empty values won&#8217;t provide the expected result.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="resource_directory.html" title="directory"
             >next</a></li>
        <li class="right" >
          <a href="resource_csh.html" title="csh"
             >previous</a> |</li>
        <li><a href="http://docs.opscode.com/chef/knife.html" target="_products">Knife</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/resources.html" target="_products">Resources</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/dsl_recipe.html" target="_products">Recipe DSL</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/lwrps_custom.html" target="_products">LWRPs</a>&#149;</li>
        <li><a href="http://docs.opscode.com/search.html">Search the Docs</a>&#149;</li>
        <li><a href="http://docs.opscode.com/">Home</a> &raquo;</li>

          <li><a href="resource.html" >About Resources and Providers</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
    This work is licensed under a Creative Commons Attribution 3.0 Unported License.
    </div>


    <div class="footer">
        &copy; Copyright This work is licensed under a Creative Commons Attribution 3.0 Unported License.
    </div>

<!-- Start of Async Google Analytics Code -->
<script type="text/javascript">
var _gaq = _gaq || [];
var pluginUrl = (('https:' == document.location.protocol) ? 'https://ssl.' : 'http://www.') + 'google-analytics.com/plugins/ga/inpage_linkid.js';
_gaq.push(['_setAccount', 'UA-6369228-7']);
_gaq.push(['_setDomainName', '.opscode.com']);
_gaq.push(['_setAllowHash', false]);
_gaq.push(['_setAllowLinker', true]);
_gaq.push(['_addIgnoredRef','opscode.com']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript';
  ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0];
  s.parentNode.insertBefore(ga, s); })();
</script>
<!-- End of Async HubSpot Analytics Code -->

<!-- Start of Async HubSpot Analytics Code -->
<script type="text/javascript">
(function(d,s,i,r) {
            if (d.getElementById(i)){return;}
            var n=d.createElement(s),e=d.getElementsByTagName(s)[0];
            n.id=i;n.src='//js.hubspot.com/analytics/'+(Math.ceil(new Date()/r)*r)+'/57718.js';
            e.parentNode.insertBefore(n, e);
        })(document,"script","hs-analytics",300000);
    </script>
<!-- End of Async HubSpot Analytics Code -->

<!-- Start of Contact Analytics Code -->
<script type="text/javascript">
(function() {
  var didInit = false;
  function initMunchkin() {
    if(didInit === false) {
      didInit = true;
      Munchkin.init('255-VFB-268');
    }
  }
  var s = document.createElement('script');
  s.type = 'text/javascript';
  s.async = true;
  s.src = document.location.protocol + '//munchkin.marketo.net/munchkin.js';
  s.onreadystatechange = function() {
    if (this.readyState == 'complete' || this.readyState == 'loaded') {
      initMunchkin();
    }
  };
  s.onload = initMunchkin;
  document.getElementsByTagName('head')[0].appendChild(s);
})();
</script>
<!-- End of Contact Analytics Code -->


  </body>
</html>
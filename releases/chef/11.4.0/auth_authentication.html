

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Authentication &mdash; Chef Docs</title>
    
    <link rel="stylesheet" href="_static/opscode.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.0.1-1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="shortcut icon" href="_static/opscode.ico"/>
    <link rel="top" title="Chef Docs" href="index.html" />
    <link rel="up" title="Authentication and Authorization" href="auth.html" />
    <link rel="next" title="Authorization" href="auth_authorization.html" />
    <link rel="prev" title="Authentication and Authorization" href="auth.html" /> 
  </head>
  <body>
<div style="background-color: #212c35; text-align: left; padding: 0px 0px 0px 0px">
<a href="http://docs.opscode.com/"><img src="_static/opscode_html_logo.png" border="0" alt="Opscode"/></a>
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="auth_authorization.html" title="Authorization"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="auth.html" title="Authentication and Authorization"
             accesskey="P">previous</a> |</li>
        <li><a href="http://docs.opscode.com/chef/knife.html" target="_products">Knife</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/resources.html" target="_products">Resources</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/dsl_recipe.html" target="_products">Recipe DSL</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/lwrps_custom.html" target="_products">LWRPs</a>&#149;</li>
        <li><a href="http://docs.opscode.com/search.html">Search the Docs</a>&#149;</li>
        <li><a href="http://docs.opscode.com/">Home</a> &raquo;</li>

          <li><a href="auth.html" accesskey="U">Authentication and Authorization</a> &raquo;</li> 
      </ul>
    </div>

      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/opscode_chef_html_logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Authentication</a><ul>
<li><a class="reference internal" href="#chef-validator">chef-validator</a></li>
<li><a class="reference internal" href="#during-a-chef-run">During a Chef Run</a></li>
<li><a class="reference internal" href="#from-the-web-interface">From the Web Interface</a></li>
<li><a class="reference internal" href="#knife-exec">knife exec</a></li>
<li><a class="reference internal" href="#knife-plugins">Knife Plugins</a></li>
<li><a class="reference internal" href="#other-options">Other Options</a><ul>
<li><a class="reference internal" href="#curl">cURL</a></li>
<li><a class="reference internal" href="#pychef">PyChef</a></li>
<li><a class="reference internal" href="#ruby">Ruby</a></li>
</ul>
</li>
<li><a class="reference internal" href="#debug-authentication-issues">Debug Authentication Issues</a></li>
</ul>
</li>
</ul>

        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="authentication">
<h1>Authentication<a class="headerlink" href="#authentication" title="Permalink to this headline">¶</a></h1>
<p>The authentication process ensures the Chef Server responds only to requests made by trusted users. Chef uses public key encryption for all server types: Hosted Chef, Private Chef, and the open source Chef Server. When a node and/or a workstation is configured to run Chef, both public and private keys are created. The public key is stored on the Chef Server, while the private key is returned to the user for safe keeping. (The private key is a .pem file located in the .chef directory or in /etc/chef.) The following executables use the Chef Server API when communicating with the Chef Server:</p>
<ul class="simple">
<li>chef-client</li>
<li>Knife</li>
<li>chef-validator (only during the first Chef run on a node)</li>
</ul>
<p>Each request to the Chef Server from those executables encrypts a special group of HTTP headers along with the private key. The Chef Server then uses the public key to decrypt the headers and verify the contents.</p>
<div class="section" id="chef-validator">
<h2>chef-validator<a class="headerlink" href="#chef-validator" title="Permalink to this headline">¶</a></h2>
<p>Every request from the chef-client to the Chef Server must be an authenticated request using the Chef Server API. When the chef-client starts a Chef run, a check is done to see if the client key exists on the node at <tt class="docutils literal"><span class="pre">/etc/chef/client.pem</span></tt>. If the key exists, it is used as part of the authentication request to the Chef Server. If the key does not exist, Chef will use the key assigned to the chef-validator (<tt class="docutils literal"><span class="pre">/etc/chef/validation.pem</span></tt>) to ensure that each node can make an authenticated request to the Chef Server during its first Chef run. The key pair used by the chef-validator is created when Chef is installed on a node, either manually or using a Knife bootstrap operation. If the chef-validator is unable to make an authentication request to the Chef Server, the Chef run fails.</p>
</div>
<div class="section" id="during-a-chef-run">
<h2>During a Chef Run<a class="headerlink" href="#during-a-chef-run" title="Permalink to this headline">¶</a></h2>
<p>As part of <a class="reference external" href="http://docs.opscode.com/essentials_nodes_chef_run.html">every Chef run</a>, the chef-client authenticates to the Chef Server using an RSA private key and the Chef Server API.</p>
</div>
<div class="section" id="from-the-web-interface">
<h2>From the Web Interface<a class="headerlink" href="#from-the-web-interface" title="Permalink to this headline">¶</a></h2>
<p>The Chef Server user interface uses the Chef Server API to perform most operations. This ensures that authentication requests to the Chef Server are authorized. This authentication process is handled automatically and is not something that users of Hosted Chef or the open source Chef Server will need to manage. For Private Chef, the authentication keys used by the web interface will need to be maintained by the individual administrators who are responsible for managing the server.</p>
</div>
<div class="section" id="knife-exec">
<h2>knife exec<a class="headerlink" href="#knife-exec" title="Permalink to this headline">¶</a></h2>
<p>The <tt class="docutils literal"><span class="pre">knife</span> <span class="pre">exec</span></tt> subcommand can be used to make authenticated API requests to the Chef Server using the following methods:</p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="88%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Method</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">api.delete</span></tt></td>
<td>Use to delete an object from the Chef Server.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">api.get</span></tt></td>
<td>Use to get the details of an object on the Chef Server.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">api.post</span></tt></td>
<td>Use to add an object to the Chef Server.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">api.put</span></tt></td>
<td>Use to update an object on the Chef Server.</td>
</tr>
</tbody>
</table>
<p>These methods are used with the <tt class="docutils literal"><span class="pre">-E</span></tt> option, which executes that string locally on the workstation using chef-shell. These methods have the following syntax:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife <span class="nb">exec</span> -E <span class="s1">&#39;api.method(/endpoint)&#39;</span>
</pre></div>
</div>
<p>where:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">api.method</span></tt> is the corresponding authentication method &#8212; <tt class="docutils literal"><span class="pre">api.delete</span></tt>, <tt class="docutils literal"><span class="pre">api.get</span></tt>, <tt class="docutils literal"><span class="pre">api.post</span></tt>, or <tt class="docutils literal"><span class="pre">api.put</span></tt></li>
<li><tt class="docutils literal"><span class="pre">/endpoint</span></tt> is an endpoint in the Chef Server API</li>
</ul>
<p>For example, to get the data for a node named &#8220;Example_Node&#8221;:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife <span class="nb">exec</span> -E <span class="s1">&#39;puts api.get(&quot;/nodes/Example_Node&quot;)&#39;</span>
</pre></div>
</div>
<p>and to ensure that the output is visible in the console, add the <tt class="docutils literal"><span class="pre">puts</span></tt> in front of the API authorization request:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife <span class="nb">exec</span> -E <span class="s1">&#39;puts api.get(&quot;/nodes/Example_Node&quot;)&#39;</span>
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">puts</span></tt> is the shorter version of the <tt class="docutils literal"><span class="pre">$stdout.puts</span></tt> predefined variable in Ruby.</p>
<p>The following example shows how to add a client named &#8220;monkeypants&#8221; and the <tt class="docutils literal"><span class="pre">/clients</span></tt> endpoint, and then return the private key for that user in the console:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ client_desc</span> <span class="o">=</span> <span class="o">{</span>
    <span class="s2">&quot;name&quot;</span>  <span class="o">=</span>&gt; <span class="s2">&quot;monkeypants&quot;</span>,
    <span class="s2">&quot;admin&quot;</span> <span class="o">=</span>&gt; <span class="nb">false</span>
  <span class="o">}</span>

  <span class="nv">new_client</span> <span class="o">=</span> api.post<span class="o">(</span><span class="s2">&quot;/clients&quot;</span>, client_desc<span class="o">)</span>
  puts new_client<span class="o">[</span><span class="s2">&quot;private_key&quot;</span><span class="o">]</span>
</pre></div>
</div>
</div>
<div class="section" id="knife-plugins">
<h2>Knife Plugins<a class="headerlink" href="#knife-plugins" title="Permalink to this headline">¶</a></h2>
<p>A Knife plugin can be used to make authenticated API requests to the Chef Server using the following methods:</p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="88%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Method</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">rest.delete_rest</span></tt></td>
<td>Use to delete an object from the Chef Server.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">rest.get_rest</span></tt></td>
<td>Use to get the details of an object on the Chef Server.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">rest.post_rest</span></tt></td>
<td>Use to add an object to the Chef Server.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">rest.put_rest</span></tt></td>
<td>Use to update an object on the Chef Server.</td>
</tr>
</tbody>
</table>
<p>For example:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">module</span> <span class="nn">MyCommands</span>
  <span class="k">class</span> <span class="nc">MyNodeDelete</span> <span class="o">&lt;</span> <span class="no">Chef</span><span class="o">::</span><span class="no">Knife</span>
    <span class="c1">#An implementation of knife node delete</span>
    <span class="n">banner</span> <span class="s1">&#39;knife my node delete [NODE_NAME]&#39;</span>

  <span class="k">def</span> <span class="nf">run</span>
    <span class="k">if</span> <span class="n">name_args</span><span class="o">.</span><span class="n">length</span> <span class="o">&lt;</span> <span class="mi">1</span>
      <span class="n">show_usage</span>
      <span class="n">ui</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="s2">&quot;You must specify a node name.&quot;</span><span class="p">)</span>
      <span class="nb">exit</span> <span class="mi">1</span>
    <span class="k">end</span>
    <span class="n">nodename</span> <span class="o">=</span> <span class="n">name_args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
       <span class="n">api_endpoint</span> <span class="o">=</span> <span class="s2">&quot;nodes/</span><span class="si">#{</span><span class="n">nodename</span><span class="si">}</span><span class="s2">&quot;</span>
       <span class="c1"># Again, we could just call rest.delete_rest</span>
       <span class="n">nodey</span> <span class="o">=</span> <span class="n">rest</span><span class="o">.</span><span class="n">get_rest</span><span class="p">(</span><span class="n">api_endpoint</span><span class="p">)</span>
       <span class="n">ui</span><span class="o">.</span><span class="n">confirm</span><span class="p">(</span><span class="s2">&quot;Do you really want to delete </span><span class="si">#{</span><span class="n">nodey</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
       <span class="n">nodey</span><span class="o">.</span><span class="n">destroy</span>
     <span class="k">end</span>
   <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="other-options">
<h2>Other Options<a class="headerlink" href="#other-options" title="Permalink to this headline">¶</a></h2>
<p>The most common ways to interact with the Chef Server using the Chef Server API abstract the API from the user. That said, the Chef Server API can be interacted with directly. The following sections describe a few of the ways that are available for doing that.</p>
<div class="section" id="curl">
<h3>cURL<a class="headerlink" href="#curl" title="Permalink to this headline">¶</a></h3>
<p>An API request can be made using cURL, which is a Bash shell script that requires two utilities: awk and openssl. The following example shows how an authenticated request can be made using the Chef Server API and cURL:</p>
<div class="highlight-bash"><div class="highlight"><pre>_chef_dir <span class="o">()</span> <span class="o">{</span>
  <span class="c"># Helper function:</span>
  <span class="c"># Recursive function that searches for chef configuration directory</span>
  <span class="c"># It looks upward from the cwd until it hits /.  If no directory is found,</span>
  <span class="c"># ~/.chef is chosen if it exists</span>
  <span class="c"># You could simply hard-code the path below</span>

  <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$PWD&quot;</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">  if</span> <span class="o">[</span> -d <span class="s2">&quot;.chef&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;/.chef&quot;</span>
      <span class="k">elif</span> <span class="o">[</span> -d <span class="s2">&quot;$HOME/.chef&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;$HOME/.chef&quot;</span>
      <span class="k">fi</span>
<span class="k">    return</span>
<span class="k">  fi</span>

<span class="k">  if</span> <span class="o">[</span> -d <span class="s1">&#39;.chef&#39;</span> <span class="o">]</span>;<span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;${PWD}/.chef&quot;</span>
  <span class="k">else</span>
    <span class="o">(</span><span class="nb">cd</span> ..; _chef_dir<span class="o">)</span>
  <span class="k">fi</span>
<span class="o">}</span>

_chomp <span class="o">()</span> <span class="o">{</span>
  <span class="c"># helper function to remove newlines</span>
  awk <span class="s1">&#39;{printf &quot;%s&quot;, $0}&#39;</span>
<span class="o">}</span>

chef_api_request<span class="o">()</span> <span class="o">{</span>
  <span class="c"># This is the meat-and-potatoes, or rice-and-vegetables, your preference really.</span>

  <span class="nb">local </span>method path body timestamp chef_server_url client_name hashed_body hashed_path
  <span class="nb">local </span>canonical_request headers auth_headers

  <span class="nv">chef_server_url</span><span class="o">=</span><span class="s2">&quot;https://api.opscode.com/organizations/my_org&quot;</span>
  <span class="c"># &#39;/organizations/ORG_NAME&#39; is needed for Hosted Chef</span>
  <span class="k">if </span><span class="nb">echo</span> <span class="nv">$chef_server_url</span> | grep -q <span class="s2">&quot;https://api.opscode.com&quot;</span> ; <span class="k">then</span>
<span class="k">    </span><span class="nv">endpoint</span><span class="o">=</span>/<span class="k">${</span><span class="nv">chef_server_url</span><span class="p">##https://api.opscode.com/</span><span class="k">}</span><span class="nv">$2</span>
  <span class="k">else</span>
<span class="k">    </span><span class="nv">endpoint</span><span class="o">=</span><span class="nv">$2</span>
  <span class="k">fi</span>
<span class="k">  </span><span class="nv">path</span><span class="o">=</span><span class="k">${</span><span class="nv">chef_server_url</span><span class="k">}</span><span class="nv">$2</span>
  <span class="nv">client_name</span><span class="o">=</span><span class="s2">&quot;chef_user&quot;</span>
  <span class="nv">method</span><span class="o">=</span><span class="nv">$1</span>
  <span class="nv">body</span><span class="o">=</span><span class="nv">$3</span>

  <span class="nv">hashed_path</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> -n <span class="s2">&quot;$endpoint&quot;</span> | openssl dgst -sha1 -binary | openssl enc -base64<span class="k">)</span>
  <span class="nv">hashed_body</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> -n <span class="s2">&quot;$body&quot;</span> | openssl dgst -sha1 -binary | openssl enc -base64<span class="k">)</span>
  <span class="nv">timestamp</span><span class="o">=</span><span class="k">$(</span>date -u <span class="s2">&quot;+%Y-%m-%dT%H:%M:%SZ&quot;</span><span class="k">)</span>

  <span class="nv">canonical_request</span><span class="o">=</span><span class="s2">&quot;Method:$method\</span>
<span class="s2">    nHashed Path:$hashed_path\</span>
<span class="s2">    nX-Ops-Content-Hash:$hashed_body\</span>
<span class="s2">    nX-Ops-Timestamp:$timestamp\</span>
<span class="s2">    nX-Ops-UserId:$client_name&quot;</span>
  <span class="nv">headers</span><span class="o">=</span><span class="s2">&quot;-H X-Ops-Timestamp:$timestamp</span>
<span class="s2">    -H X-Ops-Userid:$client_name</span>
<span class="s2">    -H X-Chef-Version:0.10.4</span>
<span class="s2">    -H Accept:application/json</span>
<span class="s2">    -H X-Ops-Content-Hash:$hashed_body</span>
<span class="s2">    -H X-Ops-Sign:version=1.0&quot;</span>

  <span class="nv">auth_headers</span><span class="o">=</span><span class="k">$(</span><span class="nb">printf</span> <span class="s2">&quot;$canonical_request&quot;</span> | openssl rsautl -sign -inkey
    <span class="s2">&quot;$(_chef_dir)/${client_name}.pem&quot;</span> | openssl enc -base64 | _chomp |  awk <span class="s1">&#39;{ll=int(length/60);i=0;</span>
<span class="s1">    while (i&lt;=ll) {printf &quot; -H X-Ops-Authorization-%s:%s&quot;, i+1, substr($0,i*60+1,60);i=i+1}}&#39;</span><span class="k">)</span>

  <span class="k">case</span> <span class="nv">$method</span> in
    GET<span class="o">)</span>
      <span class="nv">curl_command</span><span class="o">=</span><span class="s2">&quot;curl $headers $auth_headers $path&quot;</span>
      <span class="nv">$curl_command</span>
      ;;
    *<span class="o">)</span>
      <span class="nb">echo</span> <span class="s2">&quot;Unknown Method. I only know: GET&quot;</span> &gt;&amp;2
      <span class="k">return </span>1
      ;;
    <span class="k">esac</span>
  <span class="o">}</span>
</pre></div>
</div>
<p>After this shell script is sourced into the local shell, use it similar to the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>chef_api_request GET <span class="s2">&quot;/clients&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="pychef">
<h3>PyChef<a class="headerlink" href="#pychef" title="Permalink to this headline">¶</a></h3>
<p>An API request can be made using PyChef, which is a Python library that meets the <tt class="docutils literal"><span class="pre">Mixlib::Authentication</span></tt> requirements so that it can easily interact with the Chef Server. The following example shows how an authenticated request can be made using the Chef Server API and PyChef:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">chef</span> <span class="kn">import</span> <span class="n">autoconfigure</span><span class="p">,</span> <span class="n">Node</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">autoconfigure</span><span class="p">()</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="s">&#39;web1&#39;</span><span class="p">)</span>
<span class="k">print</span> <span class="n">n</span><span class="p">[</span><span class="s">&#39;fqdn&#39;</span><span class="p">]</span>
<span class="n">n</span><span class="p">[</span><span class="s">&#39;myapp&#39;</span><span class="p">][</span><span class="s">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;1.0&#39;</span>
<span class="n">n</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>and the following example shows how to make API calls directly:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">chef</span> <span class="kn">import</span> <span class="n">autoconfigure</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">autoconfigure</span><span class="p">()</span>
<span class="k">print</span> <span class="n">api</span><span class="o">.</span><span class="n">api_request</span><span class="p">(</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;/clients&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The previous examples assume that the current working directory is such that PyChef can find a valid Chef configuration file in the same manner as the chef-client or Knife. For more about PyChef, see: <a class="reference external" href="https://github.com/coderanger/pychef">https://github.com/coderanger/pychef</a>.</p>
</div>
<div class="section" id="ruby">
<h3>Ruby<a class="headerlink" href="#ruby" title="Permalink to this headline">¶</a></h3>
<p>On a system with Chef installed use Ruby to make an authenticated request to the Chef Server using the Chef libraries:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;chef/config&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;chef/log&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;chef/rest&#39;</span>

<span class="n">chef_server_url</span><span class="o">=</span><span class="s2">&quot;https://chefserver.com&quot;</span>
<span class="n">client_name</span> <span class="o">=</span> <span class="s2">&quot;clientname&quot;</span>
<span class="n">signing_key_filename</span><span class="o">=</span><span class="s2">&quot;/path/to/pem/for/clientname&quot;</span>

<span class="n">rest</span> <span class="o">=</span> <span class="no">Chef</span><span class="o">::</span><span class="no">REST</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">chef_server_url</span><span class="p">,</span> <span class="n">client_name</span><span class="p">,</span> <span class="n">signing_key_filename</span><span class="p">)</span>
<span class="nb">puts</span> <span class="n">rest</span><span class="o">.</span><span class="n">get_rest</span><span class="p">(</span><span class="s2">&quot;/clients&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>or:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;mixlib/cli&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;chef&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;chef/node&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;chef/mixin/xml_escape&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;json&#39;</span>

<span class="n">config_file</span> <span class="o">=</span> <span class="s2">&quot;c:/chef/client.rb&quot;</span>
<span class="no">Chef</span><span class="o">::</span><span class="no">Config</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>
<span class="no">Chef</span><span class="o">::</span><span class="no">Log</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="no">Chef</span><span class="o">::</span><span class="no">Config</span><span class="o">[</span><span class="ss">:log_level</span><span class="o">]</span>

<span class="k">def</span> <span class="nf">Usage</span><span class="p">()</span>
  <span class="nb">puts</span> <span class="s2">&quot;/etc/chef/client.rb&quot;</span> <span class="c1">#The config file location, e.g. ~/home/.chef/knife.rb etc</span>
  <span class="n">config_file</span> <span class="o">=</span> <span class="nb">gets</span><span class="o">.</span><span class="n">chomp</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="n">config_file</span><span class="p">))</span>
    <span class="nb">puts</span> <span class="s2">&quot;config_file </span><span class="si">#{</span><span class="n">config_file</span><span class="si">}</span><span class="s2"> does not exist. Exiting.</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="nb">exit</span>
  <span class="k">end</span>
  <span class="no">STDOUT</span><span class="o">.</span><span class="n">puts</span> <span class="o">&lt;&lt;-</span><span class="no">EOF</span>
<span class="sh">    Choose options e.g. 1</span>

<span class="sh">    1 Display all nodes per environment</span>
<span class="sh">    2 Display all nodes in detail (can be slow if there a large number of nodes)</span>
<span class="sh">    9 Exit</span>
<span class="no">  EOF</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">ExecuteUserChoice</span><span class="p">()</span>
  <span class="n">testoption</span> <span class="o">=</span> <span class="nb">gets</span><span class="o">.</span><span class="n">chomp</span>
  <span class="k">case</span> <span class="n">testoption</span>
  <span class="k">when</span> <span class="s2">&quot;1&quot;</span>
    <span class="no">Execute</span><span class="p">(</span><span class="nb">method</span><span class="p">(</span><span class="ss">:DisplayNodesPerEnv</span><span class="p">))</span>
  <span class="k">when</span> <span class="s2">&quot;2&quot;</span>
    <span class="no">Execute</span><span class="p">(</span><span class="nb">method</span><span class="p">(</span><span class="ss">:DisplayNodesDetail</span><span class="p">))</span>
  <span class="k">when</span> <span class="s2">&quot;9&quot;</span>
    <span class="nb">puts</span> <span class="s2">&quot;exit&quot;</span>
  <span class="k">else</span>
    <span class="nb">puts</span> <span class="s2">&quot;Unknown option </span><span class="si">#{</span><span class="n">testoption</span><span class="si">}</span><span class="s2">. Exiting</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="nb">exit</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">DisplayNodesPerEnv</span><span class="p">()</span>
  <span class="no">Chef</span><span class="o">::</span><span class="no">Environment</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="kp">false</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">envr</span><span class="o">|</span>
    <span class="nb">print</span> <span class="s2">&quot;ENVIRONMENT: &quot;</span><span class="p">,</span> <span class="n">envr</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="no">Chef</span><span class="o">::</span><span class="no">Node</span><span class="o">.</span><span class="n">list_by_environment</span><span class="p">(</span><span class="n">envr</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span> <span class="kp">false</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">node_info</span><span class="o">|</span>
      <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">NODE: &quot;</span><span class="p">,</span> <span class="n">node_info</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
      <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">URL: &quot;</span><span class="p">,</span> <span class="n">node_info</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">DisplayNodesDetail</span><span class="p">()</span>
  <span class="no">Chef</span><span class="o">::</span><span class="no">Node</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">node_array</span><span class="o">|</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">node_array</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
    <span class="nb">print</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:fqdn</span><span class="o">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:kernel</span><span class="o">][</span><span class="ss">:machine</span><span class="o">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:kernel</span><span class="o">][</span><span class="ss">:os</span><span class="o">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:platform</span><span class="o">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:platform_version</span><span class="o">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="si">#{</span><span class="n">node</span><span class="o">.</span><span class="n">chef_environment</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="si">#{</span><span class="n">node</span><span class="o">.</span><span class="n">run_list</span><span class="o">.</span><span class="n">roles</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">Execute</span><span class="p">(</span><span class="n">option</span><span class="p">)</span>
  <span class="k">begin</span>
    <span class="n">profilestart</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
    <span class="n">option</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
    <span class="n">profileend</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
    <span class="n">timeofrun</span> <span class="o">=</span> <span class="n">profileend</span> <span class="o">-</span> <span class="n">profilestart</span>
    <span class="nb">print</span> <span class="s2">&quot;Time taken = </span><span class="si">#{</span><span class="n">timeofrun</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">rescue</span> <span class="no">Exception</span> <span class="o">=&gt;</span> <span class="n">ex</span>
    <span class="nb">print</span> <span class="s2">&quot;Error calling chef API&quot;</span>
    <span class="nb">print</span> <span class="n">ex</span><span class="o">.</span><span class="n">message</span>
    <span class="nb">print</span> <span class="n">ex</span><span class="o">.</span><span class="n">backtrace</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Usage</span><span class="p">()</span>
<span class="no">ExecuteUserChoice</span><span class="p">()</span>
</pre></div>
</div>
<p>Another way Ruby can be used with the Chef Server API is to get objects from the Chef Server, and then interact with the returned data using Ruby methods. Whenever possible, the Chef Server API will return an object of the relevant type. The returned object is then available to be called by other methods. For example, the <tt class="docutils literal"><span class="pre">api.get</span></tt> method can be used to return a node named &#8220;foobar&#8221;, and then <tt class="docutils literal"><span class="pre">.destroy</span></tt> can be used to delete that node:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">silly_node</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/nodes/foobar&quot;</span><span class="p">)</span>
<span class="n">silly_node</span><span class="o">.</span><span class="n">destroy</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="debug-authentication-issues">
<h2>Debug Authentication Issues<a class="headerlink" href="#debug-authentication-issues" title="Permalink to this headline">¶</a></h2>
<p>In some cases, the chef-client may receive a 401 response to the authentication request and a 403 response to an authorization request. An authentication error error may look like the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>Wed, 05 Oct 2011 15:43:34 -0700<span class="o">]</span> INFO: HTTP Request Returned 401
Unauthorized: Failed to authenticate as node_name. Ensure that your node_name and client key are correct.
</pre></div>
</div>
<p>To debug authentication problems, determine which chef-client is attempting to authenticate. This is often found in the log messages for that chef-client. Debug logging can be enabled on a chef-client using the following command:</p>
<blockquote>
<div><div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>chef-client -l debug
</pre></div>
</div>
<p>When debug logging is enabled, a log entry will look like the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>Wed, 05 Oct 2011 22:05:35 +0000<span class="o">]</span> DEBUG: Signing the request as SOMENODENAMEHERE
</pre></div>
</div>
</div></blockquote>
<p>If the authentication request occurs during the initial Chef run, the issue is most likely with the private key.</p>
<p>If the authentication is happening on the node, there are a number of common causes:</p>
<ul class="simple">
<li>The <tt class="docutils literal"><span class="pre">client.pem</span></tt> file is incorrect. This can be fixed by deleting the <tt class="docutils literal"><span class="pre">client.pem</span></tt> file and re-running the chef-client. When the chef-client re-runs, it will re-attempt to register with the Chef Server and generate the correct key.</li>
<li>A <tt class="docutils literal"><span class="pre">node_name</span></tt> is different from the one used during the initial Chef run. This can happen for a number of reasons. For example, if the <tt class="docutils literal"><span class="pre">client.rb</span></tt> file does not specify the correct node name and the host name has recently changed. This issue can be resolved by explicitly setting the node name in the <tt class="docutils literal"><span class="pre">client.rb</span></tt> file or by using the <tt class="docutils literal"><span class="pre">-N</span></tt> option for the chef-client executable.</li>
<li>The system clock has drifted from the actual time by more than 15 minutes. This can be fixed by syncing the clock with an NTP server.</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="auth_authorization.html" title="Authorization"
             >next</a></li>
        <li class="right" >
          <a href="auth.html" title="Authentication and Authorization"
             >previous</a> |</li>
        <li><a href="http://docs.opscode.com/chef/knife.html" target="_products">Knife</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/resources.html" target="_products">Resources</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/dsl_recipe.html" target="_products">Recipe DSL</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/lwrps_custom.html" target="_products">LWRPs</a>&#149;</li>
        <li><a href="http://docs.opscode.com/search.html">Search the Docs</a>&#149;</li>
        <li><a href="http://docs.opscode.com/">Home</a> &raquo;</li>

          <li><a href="auth.html" >Authentication and Authorization</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
    This work is licensed under a Creative Commons Attribution 3.0 Unported License.
    </div>


    <div class="footer">
        &copy; Copyright This work is licensed under a Creative Commons Attribution 3.0 Unported License.
    </div>

<!-- Start of Async Google Analytics Code -->
<script type="text/javascript">
var _gaq = _gaq || [];
var pluginUrl = (('https:' == document.location.protocol) ? 'https://ssl.' : 'http://www.') + 'google-analytics.com/plugins/ga/inpage_linkid.js';
_gaq.push(['_setAccount', 'UA-6369228-7']);
_gaq.push(['_setDomainName', '.opscode.com']);
_gaq.push(['_setAllowHash', false]);
_gaq.push(['_setAllowLinker', true]);
_gaq.push(['_addIgnoredRef','opscode.com']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript';
  ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0];
  s.parentNode.insertBefore(ga, s); })();
</script>
<!-- End of Async HubSpot Analytics Code -->

<!-- Start of Async HubSpot Analytics Code -->
<script type="text/javascript">
(function(d,s,i,r) {
            if (d.getElementById(i)){return;}
            var n=d.createElement(s),e=d.getElementsByTagName(s)[0];
            n.id=i;n.src='//js.hubspot.com/analytics/'+(Math.ceil(new Date()/r)*r)+'/57718.js';
            e.parentNode.insertBefore(n, e);
        })(document,"script","hs-analytics",300000);
    </script>
<!-- End of Async HubSpot Analytics Code -->

<!-- Start of Contact Analytics Code -->
<script type="text/javascript">
(function() {
  var didInit = false;
  function initMunchkin() {
    if(didInit === false) {
      didInit = true;
      Munchkin.init('255-VFB-268');
    }
  }
  var s = document.createElement('script');
  s.type = 'text/javascript';
  s.async = true;
  s.src = document.location.protocol + '//munchkin.marketo.net/munchkin.js';
  s.onreadystatechange = function() {
    if (this.readyState == 'complete' || this.readyState == 'loaded') {
      initMunchkin();
    }
  };
  s.onload = initMunchkin;
  document.getElementsByTagName('head')[0].appendChild(s);
})();
</script>
<!-- End of Contact Analytics Code -->


  </body>
</html>


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>search Method &mdash; Chef Docs</title>
    
    <link rel="stylesheet" href="_static/opscode.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.0.1-1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="shortcut icon" href="_static/opscode.ico"/>
    <link rel="top" title="Chef Docs" href="index.html" />
    <link rel="up" title="About the Recipe DSL" href="dsl_recipe.html" />
    <link rel="next" title="tag, tagged?, and untag Methods" href="dsl_recipe_method_tag.html" />
    <link rel="prev" title="resources Method" href="dsl_recipe_method_resources.html" /> 
  </head>
  <body>
<div style="background-color: #212c35; text-align: left; padding: 0px 0px 0px 0px">
<a href="http://docs.opscode.com/"><img src="_static/opscode_html_logo.png" border="0" alt="Opscode"/></a>
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="dsl_recipe_method_tag.html" title="tag, tagged?, and untag Methods"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="dsl_recipe_method_resources.html" title="resources Method"
             accesskey="P">previous</a> |</li>
        <li><a href="http://docs.opscode.com/chef/knife.html" target="_products">Knife</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/resources.html" target="_products">Resources</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/dsl_recipe.html" target="_products">Recipe DSL</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/lwrps_custom.html" target="_products">LWRPs</a>&#149;</li>
        <li><a href="http://docs.opscode.com/search.html">Search the Docs</a>&#149;</li>
        <li><a href="http://docs.opscode.com/">Home</a> &raquo;</li>

          <li><a href="dsl_recipe.html" accesskey="U">About the Recipe DSL</a> &raquo;</li> 
      </ul>
    </div>

      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/opscode_chef_html_logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">search Method</a><ul>
<li><a class="reference internal" href="#examples">Examples</a></li>
</ul>
</li>
</ul>

        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="search-method">
<h1>search Method<a class="headerlink" href="#search-method" title="Permalink to this headline">¶</a></h1>
<p>Search indexes allow queries to be made for any type of data that is indexed by the Chef Server, including data bags (and data bag items), environments, nodes, and roles. Chef has a defined query syntax that supports search patterns like exact, wildcard, range, and fuzzy. A search is a full-text query that can be done from several locations, including from within a recipe, by using the <tt class="docutils literal"><span class="pre">search</span></tt> subcommand in Knife, by using the search functionality in the Management Console, or by using the <tt class="docutils literal"><span class="pre">/search</span></tt> or <tt class="docutils literal"><span class="pre">/search/INDEX</span></tt> endpoints in the Chef Server API. The search engine is based on Apache Solr and is run from the Chef Server.</p>
<p>The results of a search query can be loaded into a recipe. For example, a very simple search query (in a recipe) might look like this:</p>
<div class="highlight-python"><pre>search(:node, "attribute:value")</pre>
</div>
<p>A search query can be assigned to variables and then used elsewhere in a recipe. For example, to search for all nodes that have a role assignment named &#8220;webserver&#8221;, and then render a template which includes those role assignments:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">webservers</span> <span class="o">=</span> <span class="n">search</span><span class="p">(</span><span class="ss">:node</span><span class="p">,</span> <span class="s2">&quot;role:webserver&quot;</span><span class="p">)</span>

<span class="n">template</span> <span class="s2">&quot;/tmp/list_of_webservers&quot;</span> <span class="k">do</span>
  <span class="n">source</span> <span class="s2">&quot;list_of_webservers.erb&quot;</span>
  <span class="n">variables</span><span class="p">(</span><span class="ss">:webservers</span> <span class="o">=&gt;</span> <span class="n">webservers</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
<div class="section" id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<p>The following examples show how the <tt class="docutils literal"><span class="pre">search</span></tt> method can be used in a recipe.</p>
<p><strong>Use the search recipe DSL method to find users</strong></p>
<p>The following example shows how to use the <tt class="docutils literal"><span class="pre">search</span></tt> method in the recipe DSL to search for users:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">search</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="s2">&quot;*:*&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">u</span><span class="o">|</span>
  <span class="n">execute</span> <span class="s2">&quot;generate-openvpn-</span><span class="si">#{</span><span class="n">u</span><span class="o">[</span><span class="s1">&#39;id&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
    <span class="n">command</span> <span class="s2">&quot;./pkitool </span><span class="si">#{</span><span class="n">u</span><span class="o">[</span><span class="s1">&#39;id&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">cwd</span> <span class="s2">&quot;/etc/openvpn/easy-rsa&quot;</span>
    <span class="n">environment</span><span class="p">(</span>
      <span class="s1">&#39;EASY_RSA&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;/etc/openvpn/easy-rsa&#39;</span><span class="p">,</span>
      <span class="s1">&#39;KEY_CONFIG&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;/etc/openvpn/easy-rsa/openssl.cnf&#39;</span><span class="p">,</span>
      <span class="s1">&#39;KEY_DIR&#39;</span> <span class="o">=&gt;</span> <span class="n">node</span><span class="o">[</span><span class="s2">&quot;openvpn&quot;</span><span class="o">][</span><span class="s2">&quot;key_dir&quot;</span><span class="o">]</span><span class="p">,</span>
      <span class="s1">&#39;CA_EXPIRE&#39;</span> <span class="o">=&gt;</span> <span class="n">node</span><span class="o">[</span><span class="s2">&quot;openvpn&quot;</span><span class="o">][</span><span class="s2">&quot;key&quot;</span><span class="o">][</span><span class="s2">&quot;ca_expire&quot;</span><span class="o">].</span><span class="n">to_s</span><span class="p">,</span>
      <span class="s1">&#39;KEY_EXPIRE&#39;</span> <span class="o">=&gt;</span> <span class="n">node</span><span class="o">[</span><span class="s2">&quot;openvpn&quot;</span><span class="o">][</span><span class="s2">&quot;key&quot;</span><span class="o">][</span><span class="s2">&quot;expire&quot;</span><span class="o">].</span><span class="n">to_s</span><span class="p">,</span>
      <span class="s1">&#39;KEY_SIZE&#39;</span> <span class="o">=&gt;</span> <span class="n">node</span><span class="o">[</span><span class="s2">&quot;openvpn&quot;</span><span class="o">][</span><span class="s2">&quot;key&quot;</span><span class="o">][</span><span class="s2">&quot;size&quot;</span><span class="o">].</span><span class="n">to_s</span><span class="p">,</span>
      <span class="s1">&#39;KEY_COUNTRY&#39;</span> <span class="o">=&gt;</span> <span class="n">node</span><span class="o">[</span><span class="s2">&quot;openvpn&quot;</span><span class="o">][</span><span class="s2">&quot;key&quot;</span><span class="o">][</span><span class="s2">&quot;country&quot;</span><span class="o">]</span><span class="p">,</span>
      <span class="s1">&#39;KEY_PROVINCE&#39;</span> <span class="o">=&gt;</span> <span class="n">node</span><span class="o">[</span><span class="s2">&quot;openvpn&quot;</span><span class="o">][</span><span class="s2">&quot;key&quot;</span><span class="o">][</span><span class="s2">&quot;province&quot;</span><span class="o">]</span><span class="p">,</span>
      <span class="s1">&#39;KEY_CITY&#39;</span> <span class="o">=&gt;</span> <span class="n">node</span><span class="o">[</span><span class="s2">&quot;openvpn&quot;</span><span class="o">][</span><span class="s2">&quot;key&quot;</span><span class="o">][</span><span class="s2">&quot;city&quot;</span><span class="o">]</span><span class="p">,</span>
      <span class="s1">&#39;KEY_ORG&#39;</span> <span class="o">=&gt;</span> <span class="n">node</span><span class="o">[</span><span class="s2">&quot;openvpn&quot;</span><span class="o">][</span><span class="s2">&quot;key&quot;</span><span class="o">][</span><span class="s2">&quot;org&quot;</span><span class="o">]</span><span class="p">,</span>
      <span class="s1">&#39;KEY_EMAIL&#39;</span> <span class="o">=&gt;</span> <span class="n">node</span><span class="o">[</span><span class="s2">&quot;openvpn&quot;</span><span class="o">][</span><span class="s2">&quot;key&quot;</span><span class="o">][</span><span class="s2">&quot;email&quot;</span><span class="o">]</span>
    <span class="p">)</span>
    <span class="n">not_if</span> <span class="p">{</span> <span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s2">&quot;openvpn&quot;</span><span class="o">][</span><span class="s2">&quot;key_dir&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">u</span><span class="o">[</span><span class="s1">&#39;id&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">.crt&quot;</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="sx">%w{ conf ovpn }</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">ext</span><span class="o">|</span>
    <span class="n">template</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s2">&quot;openvpn&quot;</span><span class="o">][</span><span class="s2">&quot;key_dir&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">u</span><span class="o">[</span><span class="s1">&#39;id&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">.</span><span class="si">#{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
      <span class="n">source</span> <span class="s2">&quot;client.conf.erb&quot;</span>
      <span class="n">variables</span> <span class="ss">:username</span> <span class="o">=&gt;</span> <span class="n">u</span><span class="o">[</span><span class="s1">&#39;id&#39;</span><span class="o">]</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">execute</span> <span class="s2">&quot;create-openvpn-tar-</span><span class="si">#{</span><span class="n">u</span><span class="o">[</span><span class="s1">&#39;id&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
    <span class="n">cwd</span> <span class="n">node</span><span class="o">[</span><span class="s2">&quot;openvpn&quot;</span><span class="o">][</span><span class="s2">&quot;key_dir&quot;</span><span class="o">]</span>
    <span class="n">command</span> <span class="o">&lt;&lt;-</span><span class="no">EOH</span>
<span class="sh">      tar zcf #{u[&#39;id&#39;]}.tar.gz \</span>
<span class="sh">      ca.crt #{u[&#39;id&#39;]}.crt #{u[&#39;id&#39;]}.key \</span>
<span class="sh">      #{u[&#39;id&#39;]}.conf #{u[&#39;id&#39;]}.ovpn \</span>
<span class="no">    EOH</span>
    <span class="n">not_if</span> <span class="p">{</span> <span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s2">&quot;openvpn&quot;</span><span class="o">][</span><span class="s2">&quot;key_dir&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">u</span><span class="o">[</span><span class="s1">&#39;id&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">.tar.gz&quot;</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>where</p>
<ul class="simple">
<li>the search will use both of the <tt class="docutils literal"><span class="pre">execute</span></tt> blocks, unless the condition specified by the <tt class="docutils literal"><span class="pre">not_if</span></tt> commands are met</li>
<li>the <tt class="docutils literal"><span class="pre">environments</span></tt> attribute in the first <tt class="docutils literal"><span class="pre">execute</span></tt> block is being used to define values that appear as variables in the OpenVPN configuration</li>
<li>the <tt class="docutils literal"><span class="pre">template</span></tt> block tells Chef which template to use</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This recipe (users.rb) is part of the openvpn cookbook: <a class="reference external" href="https://github.com/opscode-cookbooks/openvpn">https://github.com/opscode-cookbooks/openvpn</a>. The cookbook defines a basic way to get started with openvpn, but a lot of customization (for your environment) may be required, so keep that in mind when looking at the above recipe.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="dsl_recipe_method_tag.html" title="tag, tagged?, and untag Methods"
             >next</a></li>
        <li class="right" >
          <a href="dsl_recipe_method_resources.html" title="resources Method"
             >previous</a> |</li>
        <li><a href="http://docs.opscode.com/chef/knife.html" target="_products">Knife</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/resources.html" target="_products">Resources</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/dsl_recipe.html" target="_products">Recipe DSL</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/lwrps_custom.html" target="_products">LWRPs</a>&#149;</li>
        <li><a href="http://docs.opscode.com/search.html">Search the Docs</a>&#149;</li>
        <li><a href="http://docs.opscode.com/">Home</a> &raquo;</li>

          <li><a href="dsl_recipe.html" >About the Recipe DSL</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
    This work is licensed under a Creative Commons Attribution 3.0 Unported License.
    </div>


    <div class="footer">
        &copy; Copyright This work is licensed under a Creative Commons Attribution 3.0 Unported License.
    </div>

<!-- Start of Async Google Analytics Code -->
<script type="text/javascript">
var _gaq = _gaq || [];
var pluginUrl = (('https:' == document.location.protocol) ? 'https://ssl.' : 'http://www.') + 'google-analytics.com/plugins/ga/inpage_linkid.js';
_gaq.push(['_setAccount', 'UA-6369228-7']);
_gaq.push(['_setDomainName', '.opscode.com']);
_gaq.push(['_setAllowHash', false]);
_gaq.push(['_setAllowLinker', true]);
_gaq.push(['_addIgnoredRef','opscode.com']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript';
  ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0];
  s.parentNode.insertBefore(ga, s); })();
</script>
<!-- End of Async HubSpot Analytics Code -->

<!-- Start of Async HubSpot Analytics Code -->
<script type="text/javascript">
(function(d,s,i,r) {
            if (d.getElementById(i)){return;}
            var n=d.createElement(s),e=d.getElementsByTagName(s)[0];
            n.id=i;n.src='//js.hubspot.com/analytics/'+(Math.ceil(new Date()/r)*r)+'/57718.js';
            e.parentNode.insertBefore(n, e);
        })(document,"script","hs-analytics",300000);
    </script>
<!-- End of Async HubSpot Analytics Code -->

<!-- Start of Contact Analytics Code -->
<script type="text/javascript">
(function() {
  var didInit = false;
  function initMunchkin() {
    if(didInit === false) {
      didInit = true;
      Munchkin.init('255-VFB-268');
    }
  }
  var s = document.createElement('script');
  s.type = 'text/javascript';
  s.async = true;
  s.src = document.location.protocol + '//munchkin.marketo.net/munchkin.js';
  s.onreadystatechange = function() {
    if (this.readyState == 'complete' || this.readyState == 'loaded') {
      initMunchkin();
    }
  };
  s.onload = initMunchkin;
  document.getElementsByTagName('head')[0].appendChild(s);
})();
</script>
<!-- End of Contact Analytics Code -->


  </body>
</html>


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>About Data Bags &mdash; Chef Docs</title>
    
    <link rel="stylesheet" href="_static/opscode.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.0.1-1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="shortcut icon" href="_static/opscode.ico"/>
    <link rel="top" title="Chef Docs" href="index.html" />
    <link rel="next" title="Unix Environment Variables" href="essentials_environment_variables.html" />
    <link rel="prev" title="Run-lists" href="essentials_node_object_run_lists.html" /> 
  </head>
  <body>
<div style="background-color: #212c35; text-align: left; padding: 0px 0px 0px 0px">
<a href="http://docs.opscode.com/"><img src="_static/opscode_html_logo.png" border="0" alt="Opscode"/></a>
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="essentials_environment_variables.html" title="Unix Environment Variables"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="essentials_node_object_run_lists.html" title="Run-lists"
             accesskey="P">previous</a> |</li>
        <li><a href="http://docs.opscode.com/chef/knife.html" target="_products">Knife</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/resources.html" target="_products">Resources</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/dsl_recipe.html" target="_products">Recipe DSL</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/lwrps_custom.html" target="_products">LWRPs</a>&#149;</li>
        <li><a href="http://docs.opscode.com/search.html">Search the Docs</a>&#149;</li>
        <li><a href="http://docs.opscode.com/">Home</a> &raquo;</li>
 
      </ul>
    </div>

      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/opscode_chef_html_logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">About Data Bags</a><ul>
<li><a class="reference internal" href="#create-a-data-bag">Create a Data Bag</a><ul>
<li><a class="reference internal" href="#using-knife">Using Knife</a></li>
<li><a class="reference internal" href="#manually">Manually</a></li>
</ul>
</li>
<li><a class="reference internal" href="#store-data-in-a-data-bag">Store Data in a Data Bag</a><ul>
<li><a class="reference internal" href="#directory-structure">Directory Structure</a></li>
<li><a class="reference internal" href="#data-bag-items">Data Bag Items</a></li>
</ul>
</li>
<li><a class="reference internal" href="#encrypt-a-data-bag">Encrypt a Data Bag</a><ul>
<li><a class="reference internal" href="#encryption-versions">Encryption Versions</a></li>
<li><a class="reference internal" href="#knife-options">Knife Options</a></li>
<li><a class="reference internal" href="#secret-keys">Secret Keys</a></li>
<li><a class="reference internal" href="#encrypt">Encrypt</a></li>
<li><a class="reference internal" href="#verify-encryption">Verify encryption</a></li>
<li><a class="reference internal" href="#decrypt">Decrypt</a></li>
<li><a class="reference internal" href="#store-keys-on-nodes">Store Keys on Nodes</a></li>
<li><a class="reference internal" href="#example">Example</a></li>
</ul>
</li>
<li><a class="reference internal" href="#use-data-bags">Use Data Bags</a><ul>
<li><a class="reference internal" href="#with-search">with Search</a><ul>
<li><a class="reference internal" href="#search-syntax">Search Syntax</a></li>
<li><a class="reference internal" href="#use-search-indexes">Use Search Indexes</a></li>
<li><a class="reference internal" href="#id3">Example</a></li>
</ul>
</li>
<li><a class="reference internal" href="#with-environments">with Environments</a></li>
<li><a class="reference internal" href="#with-recipes">with Recipes</a><ul>
<li><a class="reference internal" href="#load-with-recipe-dsl">Load with Recipe DSL</a></li>
<li><a class="reference internal" href="#create-and-edit">Create and edit</a></li>
<li><a class="reference internal" href="#access-from-recipe">Access from recipe</a></li>
<li><a class="reference internal" href="#create-users">Create users</a></li>
</ul>
</li>
<li><a class="reference internal" href="#with-chef-solo">with chef-solo</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="about-data-bags">
<h1>About Data Bags<a class="headerlink" href="#about-data-bags" title="Permalink to this headline">¶</a></h1>
<p>A data bag is a global variable that is stored as JSON data and is accessible from a Chef Server. A data bag is indexed for searching and can be loaded by a recipe or accessed during a search. The contents of a data bag can vary, but they often include sensitive information (such as database passwords).</p>
<div class="section" id="create-a-data-bag">
<h2>Create a Data Bag<a class="headerlink" href="#create-a-data-bag" title="Permalink to this headline">¶</a></h2>
<p>A data bag can be created in two ways: using Knife or manually. In general, using Knife to create data bags is recommended, but as long as the data bag folders and data bag item JSON files are created correctly, either method is safe and effective.</p>
<div class="section" id="using-knife">
<h3>Using Knife<a class="headerlink" href="#using-knife" title="Permalink to this headline">¶</a></h3>
<p>Knife can be used to create data bags and data bag items when the <tt class="docutils literal"><span class="pre">knife</span> <span class="pre">data</span> <span class="pre">bag</span></tt> sub-command is run with the <tt class="docutils literal"><span class="pre">create</span></tt> argument and to update the Chef Server with local changes to data bag items with the <tt class="docutils literal"><span class="pre">from_file</span></tt> argument. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife data bag create DATA_BAG_NAME <span class="o">(</span>DATA_BAG_ITEM<span class="o">)</span>
</pre></div>
</div>
<p>As long as a file is in the correct directory structure, Knife will be able to find the data bag and data bag item with only the name of the data bag and data bag item. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife data bag from file BAG_NAME ITEM_NAME.json
</pre></div>
</div>
<p>will load the following file:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">data_bags</span><span class="o">/</span><span class="nx">BAG_NAME</span><span class="o">/</span><span class="nx">ITEM_NAME</span><span class="p">.</span><span class="nx">json</span>
</pre></div>
</div>
<p>Continuing the example above, if you are in the &#8220;admins&#8221; directory and make changes to the file charlie.json, then to upload that change to the Chef Server use the following command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife data bag from file admins charlie.json
</pre></div>
</div>
<p>In some cases, such as when Knife is not being run from the root directory for Chef, the full path to the data bag item may be required. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife data bag from file BAG_NAME /path/to/file/ITEM_NAME.json
</pre></div>
</div>
</div>
<div class="section" id="manually">
<h3>Manually<a class="headerlink" href="#manually" title="Permalink to this headline">¶</a></h3>
<p>One or more data bags and data bag items can be created manually under the <tt class="docutils literal"><span class="pre">data_bags</span></tt> directory in the Chef repository. Any method can be used to create the data bag folders and data bag item JSON files. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>mkdir data_bags/admins
</pre></div>
</div>
<p>would create a data bag folder named &#8220;admins&#8221;. The equivalent command for using Knife is:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife data bag create admins
</pre></div>
</div>
<p>A data bag item can be created manually in the same way as the data bag, but by also specifying the file name for the data bag item (this example is using the Unix Visual Editor):</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>vi data_bags/admins/charlie.json
</pre></div>
</div>
<p>would create a data bag item named &#8220;charlie.json&#8221; under the &#8220;admins&#8221; sub-directory in the <tt class="docutils literal"><span class="pre">data_bags</span></tt> directory of the Chef repository. The equivalent command for using Knife is:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife data bag create admins charlie
</pre></div>
</div>
</div>
</div>
<div class="section" id="store-data-in-a-data-bag">
<h2>Store Data in a Data Bag<a class="headerlink" href="#store-data-in-a-data-bag" title="Permalink to this headline">¶</a></h2>
<p>When the Chef repository is cloned from github, the following occurs:</p>
<ul class="simple">
<li>A directory named <tt class="docutils literal"><span class="pre">data_bags</span></tt> is created.</li>
<li>For each data bag, a sub-directory is created that has the same name as the data bag.</li>
<li>For each data bag item, a JSON file is created and placed in the appropriate sub-directory.</li>
</ul>
<p>The <tt class="docutils literal"><span class="pre">data_bags</span></tt> directory can be placed under version source control.</p>
<p>When deploying from a private repository using a data bag, use the <tt class="docutils literal"><span class="pre">deploy_key</span></tt> option to ensure the private key is present:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;my_app&quot;</span><span class="p">,</span>
  <span class="o">.</span><span class="n">.</span><span class="o">.</span> <span class="p">(</span><span class="n">truncated</span><span class="p">)</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span>
  <span class="s2">&quot;deploy_key&quot;</span><span class="p">:</span> <span class="s2">&quot;ssh_private_key&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">ssh_private_key</span></tt> is the same SSH private key as used with a private git repository and the new lines converted to <tt class="docutils literal"><span class="pre">\n</span></tt>.</p>
<div class="section" id="directory-structure">
<h3>Directory Structure<a class="headerlink" href="#directory-structure" title="Permalink to this headline">¶</a></h3>
<p>All data bags are stored in the <tt class="docutils literal"><span class="pre">data_bags</span></tt> directory of the Chef repository. This directory structure is understood by Knife so that the full path does not need to be entered when working with data bags from the command line. An example of the <tt class="docutils literal"><span class="pre">data_bags</span></tt> directory structure:</p>
<div class="highlight-python"><pre>data_bags
         |_admins
                    |_charlie.json
                    |_bob.json
                    |_tom.json
         |_db_users
                    |_charlie.json
                    |_bob.json
                    |_sarah.json
         |_db_config
                    |_small.json
                    |_medium.json
                    |_large.json
         |_standard_packages.json
         |_global_shell_settings.json</pre>
</div>
<p>where <tt class="docutils literal"><span class="pre">_admins</span></tt>, <tt class="docutils literal"><span class="pre">_db_users</span></tt>, <tt class="docutils literal"><span class="pre">_db_config</span></tt>, <tt class="docutils literal"><span class="pre">_standard_packages</span></tt>, and <tt class="docutils literal"><span class="pre">_global_shell_settings</span></tt> are the names of individual data bags and all of the files that end with <tt class="docutils literal"><span class="pre">.json</span></tt> are the individual data bag items.</p>
</div>
<div class="section" id="data-bag-items">
<h3>Data Bag Items<a class="headerlink" href="#data-bag-items" title="Permalink to this headline">¶</a></h3>
<p>A data bag is a container of related data bag items, where each individual data bag item is a JSON file. The only structural requirement of a data bag item is that it must have an <tt class="docutils literal"><span class="pre">id</span></tt>:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;ITEM_NAME&quot;</span>
  <span class="s2">&quot;key&quot;</span><span class="o">:</span> <span class="s2">&quot;value&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">key</span></tt> and <tt class="docutils literal"><span class="pre">value</span></tt> are the key:value pair for each additional attribute within the data bag item. Knife can load a data bag item by specifying the name of the data bag to which the item belongs and then the filename of the data bag item.</p>
</div>
</div>
<div class="section" id="encrypt-a-data-bag">
<h2>Encrypt a Data Bag<a class="headerlink" href="#encrypt-a-data-bag" title="Permalink to this headline">¶</a></h2>
<p>The contents of a data bag can be encrypted using <a class="reference external" href="https://en.wikipedia.org/wiki/Symmetric-key_algorithm">shared secret encryption</a>. This allows a data bag to store confidential information (such as a database password) or to be managed in a source control system (without plain-text data appearing in revision history).</p>
<div class="section" id="encryption-versions">
<h3>Encryption Versions<a class="headerlink" href="#encryption-versions" title="Permalink to this headline">¶</a></h3>
<p>The manner by which a data bag is encrypted depends on the version of Chef. See the following:</p>
<img alt="_images/essentials_data_bags_versions.png" src="_images/essentials_data_bags_versions.png" />
<p>where R is read, W is write, and D is disable. (Disabling support for older encryption version formats will be in the next version of Chef and, if desired, will require a configuration change.)</p>
<p>For version 0 (default, through Chef 10.18):</p>
<ul class="simple">
<li>An encrypted data bag is written using YAML as the serialization format</li>
<li>Base64 encoding is used to preserve special characters in encrypted contents</li>
<li>Data is encrypted using AES-256-CBC (as defined by the OpenSSL package in the Ruby Standard Library)</li>
<li>Chef uses <a class="reference external" href="https://en.wikipedia.org/wiki/Symmetric-key_algorithm">shared secret encryption</a>; an encrypted file can only be decrypted by a node or a user with the same shared secret</li>
<li>A recipe can load encrypted data as long as the shared secret is present in a file on the node or is accessible from a URI path</li>
<li>Only the values of a data bag item are decrypted; keys are still searchable. The values associated with the <tt class="docutils literal"><span class="pre">id</span></tt> key of a data bag item are not encrypted (because they are needed by Chef when tracking the data bag item)</li>
</ul>
<p>For version 1 (default, starting with Chef 11.x):</p>
<ul class="simple">
<li>An encrypted data bag is written using JSON as the serialization format</li>
<li>Base64 encoding is used to preserve special characters in encrypted contents</li>
<li>Data is encrypted using AES-256-CBC (as defined by the OpenSSL package in the Ruby Standard Library)</li>
<li>A data bag item is encrypted using a random initialization vector each time a value is encrypted, which helps protect against some forms of cryptanalysis</li>
<li>Chef uses <a class="reference external" href="https://en.wikipedia.org/wiki/Symmetric-key_algorithm">shared secret encryption</a>; an encrypted file can only be decrypted by a node or a user with the same shared secret</li>
<li>A recipe can load encrypted data as long as the shared secret is present in a file on the node or is accessible from a URI path</li>
<li>Only the values of a data bag item are decrypted; keys are still searchable. The values associated with the <tt class="docutils literal"><span class="pre">id</span></tt> key of a data bag item are not encrypted (because they are needed by Chef when tracking the data bag item)</li>
</ul>
<p>For version 2 (available, starting with Chef 11.6):</p>
<ul class="simple">
<li>Same as version 1</li>
<li>Can disable version 0 and version 1 data bag encryption formats</li>
<li>Adds Encrypt-then-MAC(EtM) protection</li>
</ul>
</div>
<div class="section" id="knife-options">
<h3>Knife Options<a class="headerlink" href="#knife-options" title="Permalink to this headline">¶</a></h3>
<p>Knife can encrypt and decrypt data when the <tt class="docutils literal"><span class="pre">knife</span> <span class="pre">data</span> <span class="pre">bag</span></tt> sub-command is run with the <tt class="docutils literal"><span class="pre">create</span></tt>, <tt class="docutils literal"><span class="pre">edit</span></tt>, <tt class="docutils literal"><span class="pre">from</span> <span class="pre">file</span></tt>, or <tt class="docutils literal"><span class="pre">show</span></tt> arguments and the following options:</p>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">--secret</span> <span class="pre">SECRET</span></tt></td>
<td>The encryption key that is used for values contained within a data bag.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">--secret-file</span> <span class="pre">FILE</span></tt></td>
<td>The path to the file that contains the encryption key.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="secret-keys">
<h3>Secret Keys<a class="headerlink" href="#secret-keys" title="Permalink to this headline">¶</a></h3>
<p>Encrypting a data bag requires a secret key. A secret key can be created in any number of ways. For example, OpenSSL can be used to generate a random number, which can then be used as the secret key:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>openssl rand -base64 512 &gt; encrypted_data_bag_secret
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">encrypted_data_bag_secret</span></tt> is the name of the file which will contain the secret key. For example, to create a secret key named &#8220;my_secret_key&#8221;:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>openssl rand -base64 512 &gt; my_secret_key
</pre></div>
</div>
</div>
<div class="section" id="encrypt">
<h3>Encrypt<a class="headerlink" href="#encrypt" title="Permalink to this headline">¶</a></h3>
<p>A data bag can be encrypted using a Knife command similar to:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife data bag create passwords mysql --secret-file /tmp/my_data_bag_key
</pre></div>
</div>
<p>where &#8220;passwords&#8221; is the name of the data bag, &#8220;mysql&#8221; is the name of the data bag item, and &#8220;/tmp/my_data_bag_key&#8221; is the path to the location in which the file that contains the secret-key is located. Knife will ask for user credentials before the encrypted data bag item is saved.</p>
</div>
<div class="section" id="verify-encryption">
<h3>Verify encryption<a class="headerlink" href="#verify-encryption" title="Permalink to this headline">¶</a></h3>
<p>When the contents of a data bag are encrypted, they will not be readable until they are decrypted. Encryption can be verified with a Knife command similar to:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife data bag create passwords mysql
</pre></div>
</div>
<p>where &#8220;passwords&#8221; is the name of the data bag and &#8220;mysql&#8221; is the name of the data bag item. This will return something similar to:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;mysql&quot;</span><span class="p">,</span>
  <span class="s2">&quot;pass&quot;</span><span class="o">:</span> <span class="s2">&quot;trywgFA6R70NO28PNhMpGhEvKBZuxouemnbnAUQsUyo=\n&quot;</span><span class="p">,</span>
  <span class="s2">&quot;user&quot;</span><span class="o">:</span> <span class="s2">&quot;e/p+8WJYVHY9fHcEgAAReg==\n&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="decrypt">
<h3>Decrypt<a class="headerlink" href="#decrypt" title="Permalink to this headline">¶</a></h3>
<p>An encrypted data bag item can be decrypted with a Knife command similar to:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife data bag show --secret-file /tmp/my_data_bag_key passwords mysql
</pre></div>
</div>
<p>that will return JSON output similar to:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;mysql&quot;</span><span class="p">,</span>
  <span class="s2">&quot;pass&quot;</span><span class="o">:</span> <span class="s2">&quot;thesecret123&quot;</span><span class="p">,</span>
   <span class="s2">&quot;user&quot;</span><span class="o">:</span> <span class="s2">&quot;fred&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="store-keys-on-nodes">
<h3>Store Keys on Nodes<a class="headerlink" href="#store-keys-on-nodes" title="Permalink to this headline">¶</a></h3>
<p>An encryption key can also be stored in an alternate file on the nodes that need it and specify the path location to the file inside an attribute; however, <tt class="docutils literal"><span class="pre">EncryptedDataBagItem.load</span></tt> expects to see the actual secret as the third argument, rather than a path to the secret file. In this case, you can use <tt class="docutils literal"><span class="pre">EncryptedDataBagItem.load_secret</span></tt> to slurp the secret file contents and then pass them:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="c1"># inside your attribute file:</span>
<span class="c1"># default[:mysql][:secretpath] = &quot;C:\\chef\\any_secret_filename&quot;</span>
<span class="c1">#</span>
<span class="c1"># inside your recipe:</span>
<span class="c1"># look for secret in file pointed to by mysql attribute :secretpath</span>
<span class="n">mysql_secret</span> <span class="o">=</span> <span class="no">Chef</span><span class="o">::</span><span class="no">EncryptedDataBagItem</span><span class="o">.</span><span class="n">load_secret</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:mysql</span><span class="o">][</span><span class="ss">:secretpath</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">mysql_creds</span> <span class="o">=</span> <span class="no">Chef</span><span class="o">::</span><span class="no">EncryptedDataBagItem</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;passwords&quot;</span><span class="p">,</span> <span class="s2">&quot;mysql&quot;</span><span class="p">,</span> <span class="n">mysql_secret</span><span class="p">)</span>
<span class="n">mysql_creds</span><span class="o">[</span><span class="s2">&quot;pass&quot;</span><span class="o">]</span> <span class="c1"># will be decrypted</span>
</pre></div>
</div>
</div>
<div class="section" id="example">
<h3>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h3>
<p>To demonstrate the use of encrypted data bags on a node, we&#8217;ll start by copying the <tt class="docutils literal"><span class="pre">secret_key</span></tt> file to an example node using <tt class="docutils literal"><span class="pre">scp</span></tt> and moving it to <tt class="docutils literal"><span class="pre">/etc/chef/encrypted_data_bag_secret</span></tt>:</p>
<div class="highlight-bash"><div class="highlight"><pre>scp ./secret_key <span class="nv">$MY_NODE_IP</span>:~/
ssh <span class="nv">$MY_NODE_IP</span>
sudo mv ./secret_key /etc/chef/encrypted_data_bag_secret
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">knife</span> <span class="pre">bootstrap</span></tt> sub-command supports the <tt class="docutils literal"><span class="pre">encrypted_data_bag_secret</span></tt> setting in knife.rb. You will want to add this line:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">encrypted_data_bag_secret</span> <span class="s1">&#39;/path/to/your/data_bag_key&#39;</span>
</pre></div>
</div>
<p>And change <tt class="docutils literal"><span class="pre">/path/to/your/data_bag_key</span></tt> to the location of where the data bag key is located. When you run knife bootstrap afterwards it automatically adds this line to the client.rb for the node you are bootstrapping and copies the key over.</p>
<p>Next, we&#8217;ll create a recipe that will log the decrypted values for demonstration purposes (if these were real secrets, you would want to avoid logging them). Use Knife and run the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife cookbook create edb_demo
</pre></div>
</div>
<p>Then, edit <tt class="docutils literal"><span class="pre">cookbooks/edb_demo/recipes/default.rb</span></tt> so that it contains the following:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="c1"># cookbooks/edb_demo/recipes/default.rb</span>
<span class="n">passwords</span> <span class="o">=</span> <span class="no">Chef</span><span class="o">::</span><span class="no">EncryptedDataBagItem</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;prod&quot;</span><span class="p">,</span> <span class="s2">&quot;passwords&quot;</span><span class="p">)</span>
<span class="n">mysql</span> <span class="o">=</span> <span class="n">passwords</span><span class="o">[</span><span class="s2">&quot;mysql&quot;</span><span class="o">]</span>
<span class="no">Chef</span><span class="o">::</span><span class="no">Log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The mysql password is: &#39;</span><span class="si">#{</span><span class="n">mysql</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, upload the cookbook and run chef-client on the node. You should see something like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife cookbook upload edb_demo
<span class="c"># output clipped</span>
knife ssh name:i-8a436fe5 -a ec2.public_hostname <span class="s1">&#39;sudo chef-client&#39;</span>
INFO: *** Chef 0.10.0 ***
INFO: Run List is <span class="o">[</span>recipe<span class="o">[</span>edb_demo<span class="o">]]</span>
INFO: Run List expands to <span class="o">[</span>edb_demo<span class="o">]</span>
INFO: Starting Chef Run <span class="k">for </span>i-8a436fe5
INFO: Loading cookbooks <span class="o">[</span>edb_demo<span class="o">]</span>
INFO: The mysql password is: <span class="s1">&#39;open-sesame-123&#39;</span>
INFO: Chef Run <span class="nb">complete </span>in 3.122228 seconds
INFO: Running report handlers
INFO: Report handlers <span class="nb">complete</span>
</pre></div>
</div>
<p>As you can see, the recipe was able to decrypt the values in the encrypted data bag. It did so by using the shared secret located in the default location of <tt class="docutils literal"><span class="pre">/etc/chef/encrypted_data_bag_secret</span></tt>.</p>
</div>
</div>
<div class="section" id="use-data-bags">
<h2>Use Data Bags<a class="headerlink" href="#use-data-bags" title="Permalink to this headline">¶</a></h2>
<p>Data bags can be accessed in the following ways:</p>
<div class="section" id="with-search">
<h3>with Search<a class="headerlink" href="#with-search" title="Permalink to this headline">¶</a></h3>
<p>A data bag is a global variable that is stored as JSON data and is accessible from a Chef Server. A data bag is indexed for searching and can be loaded by a recipe or accessed during a search. The contents of a data bag can vary, but they often include sensitive information (such as database passwords).</p>
<p>Any search for a data bag (or a data bag item) must specify the name of the data bag and then provide the search query string that will be used during the search. For example, to use Knife to search within a data bag named &#8220;admin_data&#8221; across all items, except for the &#8220;admin_users&#8221; item, enter the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife search admin_data <span class="s2">&quot;(NOT id:admin_users)&quot;</span>
</pre></div>
</div>
<p>Or, to include the same search query in a recipe, use a code block similar to:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">search</span><span class="p">(</span><span class="ss">:admin_data</span><span class="p">,</span> <span class="s2">&quot;NOT id:admin_users&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>It may not be possible to know which data bag items will be needed. It may be necessary to load everything in a data bag (but not know what &#8220;everything&#8221; is). Using a search query is the ideal way to deal with that ambiguity, yet still ensure that all of the required data is returned. The following examples show how a recipe can use a series of search queries to search within a data bag named &#8220;admins&#8221;. For example, to find every administrator:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">search</span><span class="p">(</span><span class="ss">:admins</span><span class="p">,</span> <span class="s2">&quot;*:*&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Or to search for an administrator named &#8220;charlie&#8221;:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">search</span><span class="p">(</span><span class="ss">:admins</span><span class="p">,</span> <span class="s2">&quot;id:charlie&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Or to search for an administrator with a group identifier of &#8220;ops&#8221;:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">search</span><span class="p">(</span><span class="ss">:admins</span><span class="p">,</span> <span class="s2">&quot;gid:ops&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Or to search for an administrator whose name begins with the letter &#8220;c&#8221;:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">search</span><span class="p">(</span><span class="ss">:admins</span><span class="p">,</span> <span class="s2">&quot;id:c*&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Data bag items that are returned by a search query can be used as if they were a hash. For example:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">charlie</span> <span class="o">=</span> <span class="n">search</span><span class="p">(</span><span class="ss">:admins</span><span class="p">,</span> <span class="s2">&quot;id:charlie&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
<span class="c1"># =&gt; variable &#39;charlie&#39; is set to the charlie data bag item</span>
<span class="n">charlie</span><span class="o">[</span><span class="s2">&quot;gid&quot;</span><span class="o">]</span>
<span class="c1"># =&gt; &quot;ops&quot;</span>
<span class="n">charlie</span><span class="o">[</span><span class="s2">&quot;shell&quot;</span><span class="o">]</span>
<span class="c1"># =&gt; &quot;/bin/zsh&quot;</span>
</pre></div>
</div>
<p>The following recipe can be used to create a user for each administrator by loading all of the items from the &#8220;admins&#8221; data bag, looping through each admin in the data bag, and then creating a user resource so that each of those admins exist:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">admins</span> <span class="o">=</span> <span class="n">data_bag</span><span class="p">(</span><span class="s1">&#39;admins&#39;</span><span class="p">)</span>

<span class="n">admins</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">login</span><span class="o">|</span>
  <span class="n">admin</span> <span class="o">=</span> <span class="n">data_bag_item</span><span class="p">(</span><span class="s1">&#39;admins&#39;</span><span class="p">,</span> <span class="n">login</span><span class="p">)</span>
  <span class="n">home</span> <span class="o">=</span> <span class="s2">&quot;/home/</span><span class="si">#{</span><span class="n">login</span><span class="si">}</span><span class="s2">&quot;</span>

  <span class="n">user</span><span class="p">(</span><span class="n">login</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">uid</span>       <span class="n">admin</span><span class="o">[</span><span class="s1">&#39;uid&#39;</span><span class="o">]</span>
    <span class="n">gid</span>       <span class="n">admin</span><span class="o">[</span><span class="s1">&#39;gid&#39;</span><span class="o">]</span>
    <span class="n">shell</span>     <span class="n">admin</span><span class="o">[</span><span class="s1">&#39;shell&#39;</span><span class="o">]</span>
    <span class="n">comment</span>   <span class="n">admin</span><span class="o">[</span><span class="s1">&#39;comment&#39;</span><span class="o">]</span>
    <span class="n">home</span>      <span class="n">home</span>
    <span class="n">supports</span>  <span class="ss">:manage_home</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>
</div>
<p>And then the same recipe, modified to load administrators using a search query (and using an array to store the results of the search query):</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">admins</span> <span class="o">=</span> <span class="o">[]</span>

<span class="n">search</span><span class="p">(</span><span class="ss">:admins</span><span class="p">,</span> <span class="s2">&quot;*:*&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">admin</span><span class="o">|</span>
  <span class="n">login</span> <span class="o">=</span> <span class="n">admin</span><span class="o">[</span><span class="s2">&quot;id&quot;</span><span class="o">]</span>

  <span class="n">admins</span> <span class="o">&lt;&lt;</span> <span class="n">login</span>

  <span class="n">home</span> <span class="o">=</span> <span class="s2">&quot;/home/</span><span class="si">#{</span><span class="n">login</span><span class="si">}</span><span class="s2">&quot;</span>

  <span class="n">user</span><span class="p">(</span><span class="n">login</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">uid</span>       <span class="n">admin</span><span class="o">[</span><span class="s1">&#39;uid&#39;</span><span class="o">]</span>
    <span class="n">gid</span>       <span class="n">admin</span><span class="o">[</span><span class="s1">&#39;gid&#39;</span><span class="o">]</span>
    <span class="n">shell</span>     <span class="n">admin</span><span class="o">[</span><span class="s1">&#39;shell&#39;</span><span class="o">]</span>
    <span class="n">comment</span>   <span class="n">admin</span><span class="o">[</span><span class="s1">&#39;comment&#39;</span><span class="o">]</span>

    <span class="n">home</span>      <span class="n">home</span>
    <span class="n">supports</span>  <span class="ss">:manage_home</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>
</div>
<div class="section" id="search-syntax">
<h4>Search Syntax<a class="headerlink" href="#search-syntax" title="Permalink to this headline">¶</a></h4>
<p>In some situations, it may not be possible to know exactly which data bags (or data bag items) should be used. Or in other situations, loading all of the data in a data bag might be the desired result. Use the search index to find data that is stored in one or more data bags in the Chef environment and use the various search patterns to fine-tune the search queries. Any data that is returned as the result of a search query can then be loaded by a recipe. Use the following syntax when searching for data in a data bag:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">search</span><span class="p">(</span><span class="n">name_of_data_bag</span><span class="p">,</span> <span class="n">search_query</span><span class="p">)</span>
</pre></div>
</div>
<p>For example, to find every admin in a data bag named &#8220;admins&#8221;:</p>
<div class="highlight-python"><pre>search(:admins, "*:*")</pre>
</div>
<p>Or, to search for an administrator with an ID of &#8220;charlie&#8221;:</p>
<div class="highlight-python"><pre>search(:admins, "id:charlie")</pre>
</div>
<p>Or, to search for all administrators with a group ID of &#8220;ops&#8221;:</p>
<div class="highlight-python"><pre>search(:admins, "gid:ops")</pre>
</div>
<p>Or, to search for all administrators with an ID that begins with the letter &#8220;c&#8221;:</p>
<div class="highlight-python"><pre>search(:admins, "id:c*")</pre>
</div>
<p>Once returned, this data can be used as if it were a hash. For example:</p>
<div class="highlight-python"><pre>charlie = search(:admins, "id:charlie").first
# =&gt; variable 'charlie' is set to the charlie data bag item
charlie["gid"]
# =&gt; "ops"
charlie["shell"]
# =&gt; "/bin/ssh"</pre>
</div>
</div>
<div class="section" id="use-search-indexes">
<h4>Use Search Indexes<a class="headerlink" href="#use-search-indexes" title="Permalink to this headline">¶</a></h4>
<p>Any search for a data bag (or a data bag item) must specify the name of the data bag and then provide the search query string that will be used during the search. For example, to use Knife to search within a data bag named &#8220;admin_data&#8221; across all items, except for the &#8220;admin_users&#8221; item, enter the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife search admin_data <span class="s2">&quot;(NOT id:admin_users)&quot;</span>
</pre></div>
</div>
<p>Or, to include the same search query in a recipe, use a code block similar to:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">search</span><span class="p">(</span><span class="ss">:admin_data</span><span class="p">,</span> <span class="s2">&quot;NOT id:admin_users&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>It may not be possible to know which data bag items will be needed. It may be necessary to load everything in a data bag (but not know what &#8220;everything&#8221; is). Using a search query is the ideal way to deal with that ambiguity, yet still ensure that all of the required data is returned. The following examples show how a recipe can use a series of search queries to search within a data bag named &#8220;admins&#8221;. For example, to find every administrator:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">search</span><span class="p">(</span><span class="ss">:admins</span><span class="p">,</span> <span class="s2">&quot;*:*&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Or to search for an administrator named &#8220;charlie&#8221;:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">search</span><span class="p">(</span><span class="ss">:admins</span><span class="p">,</span> <span class="s2">&quot;id:charlie&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Or to search for an administrator with a group identifier of &#8220;ops&#8221;:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">search</span><span class="p">(</span><span class="ss">:admins</span><span class="p">,</span> <span class="s2">&quot;gid:ops&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Or to search for an administrator whose name begins with the letter &#8220;c&#8221;:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">search</span><span class="p">(</span><span class="ss">:admins</span><span class="p">,</span> <span class="s2">&quot;id:c*&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Data bag items that are returned by a search query can be used as if they were a hash. For example:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">charlie</span> <span class="o">=</span> <span class="n">search</span><span class="p">(</span><span class="ss">:admins</span><span class="p">,</span> <span class="s2">&quot;id:charlie&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
<span class="c1"># =&gt; variable &#39;charlie&#39; is set to the charlie data bag item</span>
<span class="n">charlie</span><span class="o">[</span><span class="s2">&quot;gid&quot;</span><span class="o">]</span>
<span class="c1"># =&gt; &quot;ops&quot;</span>
<span class="n">charlie</span><span class="o">[</span><span class="s2">&quot;shell&quot;</span><span class="o">]</span>
<span class="c1"># =&gt; &quot;/bin/zsh&quot;</span>
</pre></div>
</div>
<p>The following recipe can be used to create a user for each administrator by loading all of the items from the &#8220;admins&#8221; data bag, looping through each admin in the data bag, and then creating a user resource so that each of those admins exist:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">admins</span> <span class="o">=</span> <span class="n">data_bag</span><span class="p">(</span><span class="s1">&#39;admins&#39;</span><span class="p">)</span>

<span class="n">admins</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">login</span><span class="o">|</span>
  <span class="n">admin</span> <span class="o">=</span> <span class="n">data_bag_item</span><span class="p">(</span><span class="s1">&#39;admins&#39;</span><span class="p">,</span> <span class="n">login</span><span class="p">)</span>
  <span class="n">home</span> <span class="o">=</span> <span class="s2">&quot;/home/</span><span class="si">#{</span><span class="n">login</span><span class="si">}</span><span class="s2">&quot;</span>

  <span class="n">user</span><span class="p">(</span><span class="n">login</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">uid</span>       <span class="n">admin</span><span class="o">[</span><span class="s1">&#39;uid&#39;</span><span class="o">]</span>
    <span class="n">gid</span>       <span class="n">admin</span><span class="o">[</span><span class="s1">&#39;gid&#39;</span><span class="o">]</span>
    <span class="n">shell</span>     <span class="n">admin</span><span class="o">[</span><span class="s1">&#39;shell&#39;</span><span class="o">]</span>
    <span class="n">comment</span>   <span class="n">admin</span><span class="o">[</span><span class="s1">&#39;comment&#39;</span><span class="o">]</span>
    <span class="n">home</span>      <span class="n">home</span>
    <span class="n">supports</span>  <span class="ss">:manage_home</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>
</div>
<p>And then the same recipe, modified to load administrators using a search query (and using an array to store the results of the search query):</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">admins</span> <span class="o">=</span> <span class="o">[]</span>

<span class="n">search</span><span class="p">(</span><span class="ss">:admins</span><span class="p">,</span> <span class="s2">&quot;*:*&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">admin</span><span class="o">|</span>
  <span class="n">login</span> <span class="o">=</span> <span class="n">admin</span><span class="o">[</span><span class="s2">&quot;id&quot;</span><span class="o">]</span>

  <span class="n">admins</span> <span class="o">&lt;&lt;</span> <span class="n">login</span>

  <span class="n">home</span> <span class="o">=</span> <span class="s2">&quot;/home/</span><span class="si">#{</span><span class="n">login</span><span class="si">}</span><span class="s2">&quot;</span>

  <span class="n">user</span><span class="p">(</span><span class="n">login</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">uid</span>       <span class="n">admin</span><span class="o">[</span><span class="s1">&#39;uid&#39;</span><span class="o">]</span>
    <span class="n">gid</span>       <span class="n">admin</span><span class="o">[</span><span class="s1">&#39;gid&#39;</span><span class="o">]</span>
    <span class="n">shell</span>     <span class="n">admin</span><span class="o">[</span><span class="s1">&#39;shell&#39;</span><span class="o">]</span>
    <span class="n">comment</span>   <span class="n">admin</span><span class="o">[</span><span class="s1">&#39;comment&#39;</span><span class="o">]</span>

    <span class="n">home</span>      <span class="n">home</span>
    <span class="n">supports</span>  <span class="ss">:manage_home</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h4>Example<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>The following example shows how to use the search index to find all of the items in a data bag (called &#8220;admins&#8221; that stores the user data for each system administrator), add each data bag item to an array, ensure that each data bag item exists as a user resource, and then to create a security group to which each of the data bag items belongs.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="c1"># An empty array to which we&#39;ll add the admins&#39; logins as we go.</span>
<span class="n">admins</span> <span class="o">=</span> <span class="o">[]</span>

<span class="c1"># search for all items in the &#39;admins&#39; data bag and loop over them</span>
<span class="n">search</span><span class="p">(</span><span class="ss">:admins</span><span class="p">,</span> <span class="s2">&quot;*:*&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">admin</span><span class="o">|</span>
  <span class="c1"># Set `login` to the id of the data bag item</span>
  <span class="n">login</span> <span class="o">=</span> <span class="n">admin</span><span class="o">[</span><span class="s2">&quot;id&quot;</span><span class="o">]</span>

  <span class="c1"># build up the list of the admins logins</span>
  <span class="n">admins</span> <span class="o">&lt;&lt;</span> <span class="n">login</span>

  <span class="n">home</span> <span class="o">=</span> <span class="s2">&quot;/home/</span><span class="si">#{</span><span class="n">login</span><span class="si">}</span><span class="s2">&quot;</span>

  <span class="c1"># for each admin in the data bag, make a user resource</span>
  <span class="c1"># to ensure they exist</span>
  <span class="n">user</span><span class="p">(</span><span class="n">login</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">uid</span>       <span class="n">admin</span><span class="o">[</span><span class="s1">&#39;uid&#39;</span><span class="o">]</span>
    <span class="n">gid</span>       <span class="n">admin</span><span class="o">[</span><span class="s1">&#39;gid&#39;</span><span class="o">]</span>
    <span class="n">shell</span>     <span class="n">admin</span><span class="o">[</span><span class="s1">&#39;shell&#39;</span><span class="o">]</span>
    <span class="n">comment</span>   <span class="n">admin</span><span class="o">[</span><span class="s1">&#39;comment&#39;</span><span class="o">]</span>

    <span class="n">home</span>      <span class="n">home</span>
    <span class="n">supports</span>  <span class="ss">:manage_home</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="k">end</span>

<span class="k">end</span>

<span class="c1"># Create an &quot;admins&quot; group on the system</span>
<span class="c1"># You might use this group in the /etc/sudoers file</span>
<span class="c1"># to provide sudo access to the admins</span>
<span class="n">group</span> <span class="s2">&quot;admins&quot;</span> <span class="k">do</span>
  <span class="n">gid</span>     <span class="mi">999</span>
  <span class="n">members</span> <span class="n">admins</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="with-environments">
<h3>with Environments<a class="headerlink" href="#with-environments" title="Permalink to this headline">¶</a></h3>
<p>Values that are stored in a data bag are global to the organization and are available to any environment. There are two main strategies that can be used to store per-environment data within a data bag: by using a top-level key that corresponds to the environment or by using separate items for each environment.</p>
<p>A data bag that is storing a top-level key for an environment might look something like this:</p>
<div class="highlight-javascript"><pre>{
  "id": "some_data_bag_item",
  "production" : {
    # Hash with all your data here
  },
  "testing" : {
    # Hash with all your data here
  }
}</pre>
</div>
<p>When using the data bag in a recipe, that data can be accessed from a recipe using code similar to:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">bag_item</span><span class="o">[</span><span class="n">node</span><span class="o">.</span><span class="n">chef_environment</span><span class="o">][</span><span class="s2">&quot;some_other_key&quot;</span><span class="o">]</span>
</pre></div>
</div>
<p>The other approach is to use separate items for each environment. Depending on the amount of data, it may all fit nicely within a single item. If this is the case, then creating different items for each environment may be a simple approach to providing per-environment values within a data bag. However, this approach is more time-consuming and may not scale to very large environments or when the data must be stored in many data bag items.</p>
</div>
<div class="section" id="with-recipes">
<h3>with Recipes<a class="headerlink" href="#with-recipes" title="Permalink to this headline">¶</a></h3>
<p>Data bags can be accessed by a recipe in the following ways:</p>
<ul class="simple">
<li>Loaded by name when using the recipe DSL. Use this approach when a only single, known data bag item is required.</li>
<li>Accessed through the search indexes. Use this approach when more than one data bag item is required or when the contents of a data bag are looped through. The search indexes will bulk-load all of the data bag items, which will result in a lower overhead than if each data bag item were loaded by name.</li>
</ul>
<div class="section" id="load-with-recipe-dsl">
<h4>Load with Recipe DSL<a class="headerlink" href="#load-with-recipe-dsl" title="Permalink to this headline">¶</a></h4>
<p>The recipe DSL provides access to data bags and data bag items with the following methods:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">data_bag(bag)</span></tt>, where <tt class="docutils literal"><span class="pre">bag</span></tt> is the name of the data bag.</li>
<li><tt class="docutils literal"><span class="pre">data_bag_item('bag',</span> <span class="pre">'item')</span></tt>, where <tt class="docutils literal"><span class="pre">bag</span></tt> is the name of the data bag and <tt class="docutils literal"><span class="pre">item</span></tt> is the name of the data bag item.</li>
</ul>
<p>The <tt class="docutils literal"><span class="pre">data_bag</span></tt> method returns an array with a key for each of the data bag items that are found in the data bag. For example, a data bag named &#8220;admins&#8221; with a single data bag item named &#8220;charlie&#8221; could be loaded with:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">data_bag</span><span class="p">(</span><span class="s2">&quot;admins&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>to return this:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="c1"># =&gt; [&quot;charlie&quot;]</span>
</pre></div>
</div>
<p>To load the contents of the data bag item named &#8220;charlie&#8221;:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">data_bag_item</span><span class="p">(</span><span class="s1">&#39;admins&#39;</span><span class="p">,</span> <span class="s1">&#39;charlie&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>to return something like this:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="c1"># =&gt; {&quot;comment&quot;=&gt;&quot;Crazy Charlie&quot;, &quot;gid&quot;=&gt;1005, &quot;id&quot;=&gt;&quot;charlie&quot;, &quot;uid&quot;=&gt;1005, &quot;shell&quot;=&gt;&quot;/bin/zsh&quot;}</span>
</pre></div>
</div>
</div>
<div class="section" id="create-and-edit">
<h4>Create and edit<a class="headerlink" href="#create-and-edit" title="Permalink to this headline">¶</a></h4>
<p>Creating and editing the contents of a data bag or a data bag item from a recipe is not recommended. The recommended method of updating a data bag or a data bag item is to use Knife and the <tt class="docutils literal"><span class="pre">knife</span> <span class="pre">data</span> <span class="pre">bag</span></tt> sub-command. If this action must be done from a recipe, please note the following:</p>
<ul class="simple">
<li>If two chef-client operations concurrently attempt to update the contents of a data bag, the last-written attempt will be the operation to update the contents of the data bag. This situation can lead to data loss, so organizations should take steps to ensure that only one chef-client is making updates to a data bag at a time.</li>
<li>Altering data bags from the node when using the open source Chef Server requires the node&#8217;s API client to be granted admin privileges. In most cases, this is not advisable.</li>
</ul>
<p>and then take steps to ensure that any subsequent actions are done carefully. The following examples show how a recipe can be used to create and edit the contents of a data bag or a data bag item using the <tt class="docutils literal"><span class="pre">Chef::DataBag</span></tt> and <tt class="docutils literal"><span class="pre">Chef::DataBagItem</span></tt> objects.</p>
<p>To create a data bag from a recipe:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">users</span> <span class="o">=</span> <span class="no">Chef</span><span class="o">::</span><span class="no">DataBag</span><span class="o">.</span><span class="n">new</span>
<span class="n">users</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">)</span>
<span class="n">users</span><span class="o">.</span><span class="n">save</span>
</pre></div>
</div>
<p>To create a data bag item from a recipe:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">sam</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s2">&quot;id&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;sam&quot;</span><span class="p">,</span>
  <span class="s2">&quot;Full Name&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Sammy&quot;</span><span class="p">,</span>
  <span class="s2">&quot;shell&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;/bin/zsh&quot;</span>
<span class="p">}</span>
<span class="n">databag_item</span> <span class="o">=</span> <span class="no">Chef</span><span class="o">::</span><span class="no">DataBagItem</span><span class="o">.</span><span class="n">new</span>
<span class="n">databag_item</span><span class="o">.</span><span class="n">data_bag</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">)</span>
<span class="n">databag_item</span><span class="o">.</span><span class="n">raw_data</span> <span class="o">=</span> <span class="n">sam</span>
<span class="n">databag_item</span><span class="o">.</span><span class="n">save</span>
</pre></div>
</div>
<p>To edit the contents of a data bag item from a recipe:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">sam</span> <span class="o">=</span> <span class="n">data_bag_item</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="s2">&quot;sam&quot;</span><span class="p">)</span>
<span class="n">sam</span><span class="o">[</span><span class="s2">&quot;Full Name&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Samantha&quot;</span>
<span class="n">sam</span><span class="o">.</span><span class="n">save</span>
</pre></div>
</div>
</div>
<div class="section" id="access-from-recipe">
<h4>Access from recipe<a class="headerlink" href="#access-from-recipe" title="Permalink to this headline">¶</a></h4>
<p>A recipe can access encrypted data bag items as long as the recipe is running on a node that has access to the shared-key that is required to decrypt the data. A secret can be specified by using the <tt class="docutils literal"><span class="pre">Chef::EncryptedDataBagItem.load</span></tt> method. For example:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">mysql_creds</span> <span class="o">=</span> <span class="no">Chef</span><span class="o">::</span><span class="no">EncryptedDataBagItem</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;passwords&quot;</span><span class="p">,</span> <span class="s2">&quot;mysql&quot;</span><span class="p">,</span> <span class="n">secret_key</span><span class="p">)</span>
<span class="n">mysql_creds</span><span class="o">[</span><span class="s2">&quot;pass&quot;</span><span class="o">]</span> <span class="c1"># will be decrypted</span>
</pre></div>
</div>
<p>where &#8220;secret_key&#8221; is the argument that specifies the location of the file that contains the encryption key. An encryption key can be stored in a file on the nodes that need it and then configured so that Chef knows where to look using the <tt class="docutils literal"><span class="pre">Chef::Config[:encrypted_data_bag_secret]</span></tt> method, which defaults to /etc/chef/encrypted_data_bag_secret. When the default location is used, the argument that specifies the secret key file location is assumed to be the default and does not need to be explicitly specified in the recipe. For example:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">mysql_creds</span> <span class="o">=</span> <span class="no">Chef</span><span class="o">::</span><span class="no">EncryptedDataBagItem</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;passwords&quot;</span><span class="p">,</span> <span class="s2">&quot;mysql&quot;</span><span class="p">)</span> <span class="c1"># no secret_key</span>
<span class="n">mysql_creds</span><span class="o">[</span><span class="s2">&quot;pass&quot;</span><span class="o">]</span> <span class="c1"># will be decrypted</span>
</pre></div>
</div>
</div>
<div class="section" id="create-users">
<h4>Create users<a class="headerlink" href="#create-users" title="Permalink to this headline">¶</a></h4>
<p>Chef can create users on systems based on the contents of a data bag. For example, a data bag named &#8220;admins&#8221; can contain a data bag item for each of the administrators that will manage the various systems that Chef is maintaining. A recipe can load the data bag items and then create user accounts on the target system with code similar to the following:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="c1"># Load the keys of the items in the &#39;admins&#39; data bag</span>
<span class="n">admins</span> <span class="o">=</span> <span class="n">data_bag</span><span class="p">(</span><span class="s1">&#39;admins&#39;</span><span class="p">)</span>

<span class="n">admins</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">login</span><span class="o">|</span>
  <span class="c1"># This causes a round-trip to the server for each admin in the data bag</span>
  <span class="n">admin</span> <span class="o">=</span> <span class="n">data_bag_item</span><span class="p">(</span><span class="s1">&#39;admins&#39;</span><span class="p">,</span> <span class="n">login</span><span class="p">)</span>
  <span class="n">homedir</span> <span class="o">=</span> <span class="s2">&quot;/home/</span><span class="si">#{</span><span class="n">login</span><span class="si">}</span><span class="s2">&quot;</span>

  <span class="c1"># for each admin in the data bag, make a user resource</span>
  <span class="c1"># to ensure they exist</span>
  <span class="n">user</span><span class="p">(</span><span class="n">login</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">uid</span>       <span class="n">admin</span><span class="o">[</span><span class="s1">&#39;uid&#39;</span><span class="o">]</span>
    <span class="n">gid</span>       <span class="n">admin</span><span class="o">[</span><span class="s1">&#39;gid&#39;</span><span class="o">]</span>
    <span class="n">shell</span>     <span class="n">admin</span><span class="o">[</span><span class="s1">&#39;shell&#39;</span><span class="o">]</span>
    <span class="n">comment</span>   <span class="n">admin</span><span class="o">[</span><span class="s1">&#39;comment&#39;</span><span class="o">]</span>
    <span class="n">home</span>      <span class="n">homedir</span>
    <span class="n">supports</span>  <span class="ss">:manage_home</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="k">end</span>

<span class="k">end</span>

<span class="c1"># Create an &quot;admins&quot; group on the system</span>
<span class="c1"># You might use this group in the /etc/sudoers file</span>
<span class="c1"># to provide sudo access to the admins</span>
<span class="n">group</span> <span class="s2">&quot;admins&quot;</span> <span class="k">do</span>
  <span class="n">gid</span>     <span class="mi">999</span>
  <span class="n">members</span> <span class="n">admins</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="with-chef-solo">
<h3>with chef-solo<a class="headerlink" href="#with-chef-solo" title="Permalink to this headline">¶</a></h3>
<p>chef-solo can load data from a data bag as long as the contents of that data bag are accessible from a directory structure that exists on the same machine as chef-solo. The location of this directory is configurable using the <tt class="docutils literal"><span class="pre">data_bag_path</span></tt> option in the solo.rb file. The name of each sub-directory corresponds to a data bag and each JSON file within a sub-directory corresponds to a data bag item. Search is not available in recipes when they are run with chef-solo; use the <tt class="docutils literal"><span class="pre">data_bag()</span></tt> and <tt class="docutils literal"><span class="pre">data_bag_item()</span></tt> functions to access data bags and data bag items.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Use the <tt class="docutils literal"><span class="pre">chef-solo-search</span></tt> cookbook library (developed by Opscode community member &#8220;edelight&#8221; and available from github) to add data bag search capabilities to a chef-solo environment: <a class="reference external" href="https://github.com/edelight/chef-solo-search">https://github.com/edelight/chef-solo-search</a>.</p>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="essentials_environment_variables.html" title="Unix Environment Variables"
             >next</a></li>
        <li class="right" >
          <a href="essentials_node_object_run_lists.html" title="Run-lists"
             >previous</a> |</li>
        <li><a href="http://docs.opscode.com/chef/knife.html" target="_products">Knife</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/resources.html" target="_products">Resources</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/dsl_recipe.html" target="_products">Recipe DSL</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/lwrps_custom.html" target="_products">LWRPs</a>&#149;</li>
        <li><a href="http://docs.opscode.com/search.html">Search the Docs</a>&#149;</li>
        <li><a href="http://docs.opscode.com/">Home</a> &raquo;</li>
 
      </ul>
    </div>

    <div class="footer">
    This work is licensed under a Creative Commons Attribution 3.0 Unported License.
    </div>


    <div class="footer">
        &copy; Copyright This work is licensed under a Creative Commons Attribution 3.0 Unported License.
    </div>

<!-- Start of Async Google Analytics Code -->
<script type="text/javascript">
var _gaq = _gaq || [];
var pluginUrl = (('https:' == document.location.protocol) ? 'https://ssl.' : 'http://www.') + 'google-analytics.com/plugins/ga/inpage_linkid.js';
_gaq.push(['_setAccount', 'UA-6369228-7']);
_gaq.push(['_setDomainName', '.opscode.com']);
_gaq.push(['_setAllowHash', false]);
_gaq.push(['_setAllowLinker', true]);
_gaq.push(['_addIgnoredRef','opscode.com']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript';
  ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0];
  s.parentNode.insertBefore(ga, s); })();
</script>
<!-- End of Async HubSpot Analytics Code -->

<!-- Start of Async HubSpot Analytics Code -->
<script type="text/javascript">
(function(d,s,i,r) {
            if (d.getElementById(i)){return;}
            var n=d.createElement(s),e=d.getElementsByTagName(s)[0];
            n.id=i;n.src='//js.hubspot.com/analytics/'+(Math.ceil(new Date()/r)*r)+'/57718.js';
            e.parentNode.insertBefore(n, e);
        })(document,"script","hs-analytics",300000);
    </script>
<!-- End of Async HubSpot Analytics Code -->

<!-- Start of Contact Analytics Code -->
<script type="text/javascript">
(function() {
  var didInit = false;
  function initMunchkin() {
    if(didInit === false) {
      didInit = true;
      Munchkin.init('255-VFB-268');
    }
  }
  var s = document.createElement('script');
  s.type = 'text/javascript';
  s.async = true;
  s.src = document.location.protocol + '//munchkin.marketo.net/munchkin.js';
  s.onreadystatechange = function() {
    if (this.readyState == 'complete' || this.readyState == 'loaded') {
      initMunchkin();
    }
  };
  s.onload = initMunchkin;
  document.getElementsByTagName('head')[0].appendChild(s);
})();
</script>
<!-- End of Contact Analytics Code -->


  </body>
</html>


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Upgrading to Chef Server 11.x &mdash; Chef Docs</title>
    
    <link rel="stylesheet" href="_static/opscode.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.0.1-1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="shortcut icon" href="_static/opscode.ico"/>
    <link rel="top" title="Chef Docs" href="index.html" />
    <link rel="next" title="chef-shell" href="ctl_chef_shell.html" />
    <link rel="prev" title="Pushy" href="pushy.html" /> 
  </head>
  <body>
<div style="background-color: #212c35; text-align: left; padding: 0px 0px 0px 0px">
<a href="http://docs.opscode.com/"><img src="_static/opscode_html_logo.png" border="0" alt="Opscode"/></a>
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="ctl_chef_shell.html" title="chef-shell"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="pushy.html" title="Pushy"
             accesskey="P">previous</a> |</li>
        <li><a href="http://docs.opscode.com/chef/knife.html" target="_products">Knife</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/resources.html" target="_products">Resources</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/dsl_recipe.html" target="_products">Recipe DSL</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/lwrps_custom.html" target="_products">LWRPs</a>&#149;</li>
        <li><a href="http://docs.opscode.com/search.html">Search the Docs</a>&#149;</li>
        <li><a href="http://docs.opscode.com/">Home</a> &raquo;</li>
 
      </ul>
    </div>

      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/opscode_chef_html_logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Upgrading to Chef Server 11.x</a><ul>
<li><a class="reference internal" href="#requirements">Requirements</a></li>
<li><a class="reference internal" href="#set-up-access-to-chef-server-10">Set up Access to Chef Server 0.10.x</a></li>
<li><a class="reference internal" href="#download-data-from-chef-server-10">Download Data from Chef Server 0.10.x</a></li>
<li><a class="reference internal" href="#set-up-access-to-chef-server-11">Set up Access to Chef Server 11.x</a></li>
<li><a class="reference internal" href="#update-the-chef-validator-settings">Update the chef-validator settings</a></li>
<li><a class="reference internal" href="#verify-the-admin-public-key">Verify the admin public key</a></li>
<li><a class="reference internal" href="#upload-data-to-chef-11">Upload Data to Chef 11</a></li>
<li><a class="reference internal" href="#last-steps">Last Steps</a></li>
</ul>
</li>
</ul>

        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="upgrading-to-chef-server-11-x">
<h1>Upgrading to Chef Server 11.x<a class="headerlink" href="#upgrading-to-chef-server-11-x" title="Permalink to this headline">¶</a></h1>
<p>Upgrading to Chef Server 11.x from Chef Server 0.10.x is a relatively simple process: install the Chef Server 11.x and then move the data from Chef Server 0.10.x to the new one. Because the Chef Server 0.10.x database is CouchDB and the Chef Server 11.x database is PostgreSQL, the data cannot be moved directly. Instead, use the following Knife subcommands:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">knife</span> <span class="pre">download</span></tt></li>
<li><tt class="docutils literal"><span class="pre">knife</span> <span class="pre">list</span></tt></li>
<li><tt class="docutils literal"><span class="pre">knife</span> <span class="pre">upload</span></tt></li>
</ul>
<p>These subcommands will be used to download the data from Chef Server 0.10.x (as JSON), and then upload it to the Chef Server 11.x server. This approach bypasses the need to interact directly with either database or having to worry about how the data is stored in either location.</p>
<p>Install the latest version of the <tt class="docutils literal"><span class="pre">knife-essentials</span></tt> plugin using the following command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>gem install knife-essentials
</pre></div>
</div>
<p>For more information about <tt class="docutils literal"><span class="pre">knife-essentials</span></tt>, see <a class="reference external" href="https://github.com/jkeiser/knife-essentials">https://github.com/jkeiser/knife-essentials</a>.</p>
<div class="section" id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>A live Chef Server 0.10.x server</li>
<li>A live Chef Server 11.x server</li>
<li>A workstation (running Knife) that can access both the Chef Server 0.10.x and Chef Server 11.x servers</li>
<li>The ability to run the <tt class="docutils literal"><span class="pre">knife</span> <span class="pre">download</span></tt> and <tt class="docutils literal"><span class="pre">knife</span> <span class="pre">upload</span></tt> subcommands</li>
</ul>
</div>
<div class="section" id="set-up-access-to-chef-server-10">
<h2>Set up Access to Chef Server 0.10.x<a class="headerlink" href="#set-up-access-to-chef-server-10" title="Permalink to this headline">¶</a></h2>
<p>Use the following steps to configure a workstation so that it can communicate with the Chef Server 0.10.x server:</p>
<ol class="arabic">
<li><p class="first">Create a directory to use as the location to which data will be downloaded. This topic uses a directory named <tt class="docutils literal"><span class="pre">~/transfer</span></tt>.</p>
</li>
<li><p class="first">In the <tt class="docutils literal"><span class="pre">~/transfer</span></tt> directory, create a file named <tt class="docutils literal"><span class="pre">.chef/knife-chef10.rb</span></tt>. The contents of this file should be similar to the following:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">transfer_repo</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">))</span>
<span class="n">chef_server_url</span> <span class="s2">&quot;http://chef-10.example.com:4000&quot;</span>
<span class="n">node_name</span> <span class="s1">&#39;chef-webui&#39;</span>
<span class="n">client_key</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">transfer_repo</span><span class="si">}</span><span class="s2">/.chef/chef-webui.pem&quot;</span>
<span class="n">repo_mode</span> <span class="s1">&#39;everything&#39;</span>
<span class="n">versioned_cookbooks</span> <span class="kp">true</span>
<span class="n">chef_repo_path</span> <span class="n">transfer_repo</span>
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">chef_server_url</span></tt> is the URL for the Chef Server 0.10.x server from which the data will be downloaded and <tt class="docutils literal"><span class="pre">node_name</span></tt> is the name of the workstation from which Knife runs (with admin rights).</p>
</li>
<li><p class="first">Copy the private key for the Chef Server 0.10.x server to the <tt class="docutils literal"><span class="pre">.chef</span></tt> directory. The private key is typically located at <tt class="docutils literal"><span class="pre">/etc/chef/webui.pem</span></tt>. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>cp &lt;local_webui.pem&gt; .chef/chef-webui.pem
</pre></div>
</div>
</li>
<li><p class="first">Verify the configuration by running the following command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife list /clients
</pre></div>
</div>
<p>to return a list of all clients, including <tt class="docutils literal"><span class="pre">clients/chef-webui.json</span></tt> and <tt class="docutils literal"><span class="pre">clients/chef-validator.json</span></tt>.</p>
</li>
</ol>
</div>
<div class="section" id="download-data-from-chef-server-10">
<h2>Download Data from Chef Server 0.10.x<a class="headerlink" href="#download-data-from-chef-server-10" title="Permalink to this headline">¶</a></h2>
<p>To download data from the Chef Server 0.10.x, run the following command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife download -c .chef/knife-chef10.rb /
</pre></div>
</div>
<p>This will transfer all of the data on Chef Server 0.10.x to the transfer directory.</p>
</div>
<div class="section" id="set-up-access-to-chef-server-11">
<h2>Set up Access to Chef Server 11.x<a class="headerlink" href="#set-up-access-to-chef-server-11" title="Permalink to this headline">¶</a></h2>
<p>Use the following steps to configure a workstation so that it can communicate with the Chef Server 11.x server:</p>
<ol class="arabic">
<li><p class="first">In the same <tt class="docutils literal"><span class="pre">~/transfer</span></tt> directory, create a file named <tt class="docutils literal"><span class="pre">.chef/knife.rb</span></tt>. The contents of this file should be similar to the following:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">transfer_repo</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">))</span>
<span class="n">chef_server_url</span> <span class="s2">&quot;https://chef-11.example.com&quot;</span>
<span class="n">node_name</span> <span class="s1">&#39;admin&#39;</span>
<span class="n">client_key</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">transfer_repo</span><span class="si">}</span><span class="s2">/.chef/admin.pem&quot;</span>
<span class="n">repo_mode</span> <span class="s1">&#39;everything&#39;</span>
<span class="n">versioned_cookbooks</span> <span class="kp">true</span>
<span class="n">chef_repo_path</span> <span class="n">transfer_repo</span>
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">chef_server_url</span></tt> is the URL for the Chef Server 11.x server to which the data will be uploaded.</p>
</li>
<li><p class="first">Copy the private key for the Chef Server 11.x server to the <tt class="docutils literal"><span class="pre">.chef</span></tt> directory. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>cp &lt;admin.pem&gt; .chef/admin.pem
</pre></div>
</div>
</li>
<li><p class="first">Verify the configuration by running the following command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife list /users
</pre></div>
</div>
<p>to return a list of all users, including <tt class="docutils literal"><span class="pre">users/admin.json</span></tt>.</p>
</li>
</ol>
</div>
<div class="section" id="update-the-chef-validator-settings">
<h2>Update the chef-validator settings<a class="headerlink" href="#update-the-chef-validator-settings" title="Permalink to this headline">¶</a></h2>
<p>The chef-validator client is no longer special; Chef Server 11.x requires the <tt class="docutils literal"><span class="pre">chef-validator</span></tt> flag to be set in order for the chef-validator to be created.</p>
<ol class="arabic simple">
<li>Edit the <tt class="docutils literal"><span class="pre">clients/chef-validator.json</span></tt> file and add <tt class="docutils literal"><span class="pre">&quot;validator&quot;:</span> <span class="pre">true</span></tt> as a property, like this:</li>
</ol>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;chef-validator&quot;</span><span class="p">,</span>
  <span class="s2">&quot;public_key&quot;</span><span class="o">:</span> <span class="s2">&quot;-----BEGIN PUBLIC KEY-----\</span>
<span class="s2">    nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AM235gKCgAQEA8l0+sy05G6YX/SaVsu2k\</span>
<span class="s2">    ndwOTIZKLhvfuhp/VcBU432455DTMWyxTR9sdgdRq+mgUqkF4ox/zIwhLG5nyHMLa\</span>
<span class="s2">    nFKsKPxUQlS1Jsf2gaoP+RhnswmspJffhF2l593DwSsglTLNtDw5cqhF6YYo7b7cB\</span>
<span class="s2">    nywHaWL+O3cSFLd0US7tSoOTeOdnAAwPwrsdfgKQdgfgerCV3Ottn83V8BUCfpnbi\</span>
<span class="s2">    nNetytGDnE1Ms9lvYswsW2EqEnzQ+afvlDq5tXu72b1XBs7Y/8JqQz8+3lVHNGKys\</span>
<span class="s2">    nh5U6VdI5Br0u1leO0LcffgrgE4@#$fs7/T2MVztXujUN9CoX1a+3siu3HAa8lslo\</span>
<span class="s2">    noQIDAQAB\n-----END PUBLIC KEY-----\n&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_rev&quot;</span><span class="o">:</span> <span class="s2">&quot;1-72a9f16a92108bd794704c075261aeb5&quot;</span><span class="p">,</span>
  <span class="s2">&quot;validator&quot;</span><span class="o">:</span> <span class="kc">true</span>
<span class="p">}</span>
</pre></div>
</div>
<ol class="arabic">
<li><ol class="first arabic simple">
<li>Verify the configuration by running the following command:</li>
</ol>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife list /clients
</pre></div>
</div>
<p>to return a list of all clients, including <tt class="docutils literal"><span class="pre">clients/chef-validator.json</span></tt>.</p>
</li>
</ol>
</div>
<div class="section" id="verify-the-admin-public-key">
<h2>Verify the admin public key<a class="headerlink" href="#verify-the-admin-public-key" title="Permalink to this headline">¶</a></h2>
<p>The <tt class="docutils literal"><span class="pre">admin.pem</span></tt> private key must be correct for each workstation that will have access to Chef Server 11.x. Chef Server 11.x has a new user named <tt class="docutils literal"><span class="pre">admin</span></tt>, whereas many instances of Chef Server 0.10.x have an admin client named <tt class="docutils literal"><span class="pre">admin</span></tt>. For Chef 11.x, Knife requires a private key named <tt class="docutils literal"><span class="pre">admin.pem</span></tt>. This naming similarity can be an issue if the name of the client doesn&#8217;t match the name of the private key.</p>
<ol class="arabic">
<li><p class="first">Copy the <tt class="docutils literal"><span class="pre">admin.pem</span></tt> to each workstation or replace the Chef 11.x admin private key with the old private key. To do this, run the following commands:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife download users/admin.json
<span class="nv">$ </span>grep public_key clients/admin.json
</pre></div>
</div>
</li>
<li><p class="first">Replace the public key in <tt class="docutils literal"><span class="pre">users/admin.json</span></tt> with the results of the previous step:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife upload users/admin.json
<span class="nv">$ </span>cp &lt;Chef 10 admin.pem&gt; .chef/admin.pem
</pre></div>
</div>
</li>
<li><p class="first">Remove the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>rm clients/admin.json
</pre></div>
</div>
</li>
<li><p class="first">Verify the configuration by running the following command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife list /users
</pre></div>
</div>
<p>to return a list of all users, including <tt class="docutils literal"><span class="pre">users/admin.json</span></tt>.</p>
</li>
</ol>
</div>
<div class="section" id="upload-data-to-chef-11">
<h2>Upload Data to Chef 11<a class="headerlink" href="#upload-data-to-chef-11" title="Permalink to this headline">¶</a></h2>
<p>To upload data to the Chef Server 11.x, run the following command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife upload /
</pre></div>
</div>
<p>This will transfer all of the data in the transfer directory to Chef Server 11.x.</p>
</div>
<div class="section" id="last-steps">
<h2>Last Steps<a class="headerlink" href="#last-steps" title="Permalink to this headline">¶</a></h2>
<p>At this point, the Chef Server 11.x should have all of the data that used to be on the Chef Server 0.10.x. Point the DNS or load balancer at the new Chef Server. The chef-client should continue to run properly on all nodes and each workstation should be able to manage Chef objects using Knife. If issues remain, try the IRC channel or email the <a class="reference external" href="mailto:chef&#37;&#52;&#48;lists&#46;opscode&#46;com">chef<span>&#64;</span>lists<span>&#46;</span>opscode<span>&#46;</span>com</a> discussion alias. If <tt class="docutils literal"><span class="pre">knife-essentials</span></tt> is the issue, file an issue in github or check the IRC channel.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="ctl_chef_shell.html" title="chef-shell"
             >next</a></li>
        <li class="right" >
          <a href="pushy.html" title="Pushy"
             >previous</a> |</li>
        <li><a href="http://docs.opscode.com/chef/knife.html" target="_products">Knife</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/resources.html" target="_products">Resources</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/dsl_recipe.html" target="_products">Recipe DSL</a>&#149;</li>
        <li><a href="http://docs.opscode.com/chef/lwrps_custom.html" target="_products">LWRPs</a>&#149;</li>
        <li><a href="http://docs.opscode.com/search.html">Search the Docs</a>&#149;</li>
        <li><a href="http://docs.opscode.com/">Home</a> &raquo;</li>
 
      </ul>
    </div>

    <div class="footer">
    This work is licensed under a Creative Commons Attribution 3.0 Unported License.
    </div>


    <div class="footer">
        &copy; Copyright This work is licensed under a Creative Commons Attribution 3.0 Unported License.
    </div>

<!-- Start of Async Google Analytics Code -->
<script type="text/javascript">
var _gaq = _gaq || [];
var pluginUrl = (('https:' == document.location.protocol) ? 'https://ssl.' : 'http://www.') + 'google-analytics.com/plugins/ga/inpage_linkid.js';
_gaq.push(['_setAccount', 'UA-6369228-7']);
_gaq.push(['_setDomainName', '.opscode.com']);
_gaq.push(['_setAllowHash', false]);
_gaq.push(['_setAllowLinker', true]);
_gaq.push(['_addIgnoredRef','opscode.com']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript';
  ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0];
  s.parentNode.insertBefore(ga, s); })();
</script>
<!-- End of Async HubSpot Analytics Code -->

<!-- Start of Async HubSpot Analytics Code -->
<script type="text/javascript">
(function(d,s,i,r) {
            if (d.getElementById(i)){return;}
            var n=d.createElement(s),e=d.getElementsByTagName(s)[0];
            n.id=i;n.src='//js.hubspot.com/analytics/'+(Math.ceil(new Date()/r)*r)+'/57718.js';
            e.parentNode.insertBefore(n, e);
        })(document,"script","hs-analytics",300000);
    </script>
<!-- End of Async HubSpot Analytics Code -->

<!-- Start of Contact Analytics Code -->
<script type="text/javascript">
(function() {
  var didInit = false;
  function initMunchkin() {
    if(didInit === false) {
      didInit = true;
      Munchkin.init('255-VFB-268');
    }
  }
  var s = document.createElement('script');
  s.type = 'text/javascript';
  s.async = true;
  s.src = document.location.protocol + '//munchkin.marketo.net/munchkin.js';
  s.onreadystatechange = function() {
    if (this.readyState == 'complete' || this.readyState == 'loaded') {
      initMunchkin();
    }
  };
  s.onload = initMunchkin;
  document.getElementsByTagName('head')[0].appendChild(s);
})();
</script>
<!-- End of Contact Analytics Code -->


  </body>
</html>